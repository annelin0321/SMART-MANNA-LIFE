<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» | Smart Manna Life</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SQLite Support (sql.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- Google Fonts -->
    <style>
        /* å¼•å…¥è¥¯ç·šé«”èˆ‡æ‰‹å¯«è‹±æ–‡å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&family=Caveat:wght@400;700&family=Zen+Maru+Gothic:wght@300;400;700&display=swap');
        
        :root {
            /* æ–‡é’é…è‰²ï¼šå®£ç´™ç™½ã€ç‚­ç­†ç°ã€ä¹¾ç‡¥ç«ç‘°ã€é¼ å°¾è‰ç¶ ã€é™¶åœŸæ£• */
            --bg-paper: #F9F8F4;
            --bg-card: #FFFEFA;
            --ink-primary: #59544D;
            --ink-secondary: #8C867D;
            --accent-sage: #94A698;
            --accent-clay: #C2A695;
            --accent-rose: #D6C0BE;
            --border-sketch: #E0DBD3;
        }

        body { 
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', sans-serif; /* åœ“é«”å­—æ›´è¦ªå’Œ */
            background-color: var(--bg-paper);
            color: var(--ink-primary);
            -webkit-tap-highlight-color: transparent;
            /* æ¨¡æ“¬ç´™å¼µç´‹ç† */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        .serif-font, .bible-text, h1, h2, h3 { 
            font-family: 'Noto Serif TC', serif; 
        }

        .hand-font {
            font-family: 'Caveat', cursive;
        }

        .bible-text {
            line-height: 2.4; /* å¢åŠ è¡Œè·ï¼Œå‘¼å¸æ„Ÿ */
            font-size: 1.1rem;
            letter-spacing: 0.05em;
            font-style: normal !important; /* å¼·åˆ¶æ­£é«” */
        }

        /* æ‰‹ç¹ªæ„Ÿå¡ç‰‡ (ä¸è¦å‰‡åœ“è§’) */
        .sketch-card {
            background: var(--bg-card);
            border: 1px solid var(--border-sketch);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; /* æ‰‹ç¹ªé¢¨æ ¼é‚Šæ¡† */
            box-shadow: 2px 3px 10px rgba(0,0,0,0.02);
            transition: all 0.3s ease;
        }
        .sketch-card:hover {
            transform: translateY(-3px) rotate(0.5deg);
            box-shadow: 4px 6px 15px rgba(0,0,0,0.05);
            border-color: var(--accent-clay);
        }

        /* ç¶“æ–‡é¸å–æ¨£å¼ - åƒè¢å…‰ç­†åŠƒç·š */
        .verse-item {
            position: relative;
            padding: 4px 8px;
            margin-bottom: 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .verse-item.selected {
            background: linear-gradient(120deg, #f6e6e6 0%, #f6e6e6 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 88%;
        }
        .verse-item:hover {
            background-color: rgba(0,0,0,0.02);
        }

        /* éš±è—å·è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #DCD6CC; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å››è»Œé€²åº¦ - éƒµç¥¨é¢¨æ ¼ */
        .devotion-track-card {
            background: #FFFEFA; 
            transition: all 0.2s; 
            cursor: pointer;
            border: 1px dashed var(--border-sketch); /* è™›ç·šé‚Šæ¡† */
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 4px;
            min-height: 65px;
            position: relative;
        }
        .devotion-track-card:hover { 
            border-color: var(--accent-clay); 
            background: #FAF8F5;
        }
        .devotion-track-card.active {
            background: var(--accent-sage); 
            color: white;
            border: 1px solid var(--accent-sage);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 4px 8px rgba(148, 166, 152, 0.4);
        }
        .devotion-track-card.active .track-tag { color: rgba(255,255,255,0.9); }
        
        .track-tag { font-size: 11px; font-weight: 700; color: var(--ink-secondary); margin-bottom: 2px; font-family: 'Caveat', cursive; letter-spacing: 1px; }
        .track-ref { font-size: 13px; font-weight: 600; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: 'Noto Serif TC'; }

        /* åˆ†é æŒ‰éˆ• - ç´™è† å¸¶é¢¨æ ¼ */
        .workspace-tab-btn {
            flex: 1; text-align: center; padding: 14px 10px; font-size: 15px; font-weight: bold; 
            color: var(--ink-secondary); border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .workspace-tab-btn.active { 
            color: var(--accent-clay); 
            border-bottom-color: var(--accent-clay); 
            background-color: rgba(194, 166, 149, 0.05);
            font-family: 'Noto Serif TC';
        }

        /* å¿ƒæƒ…è²¼ç´™ */
        .mood-sticker {
            font-size: 1.4rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; transition: all 0.2s; background-color: #fff; border: 1px dashed var(--border-sketch);
        }
        .mood-sticker.selected { background-color: var(--accent-sage); color: white; border-style: solid; border-color: var(--accent-sage); transform: scale(1.1) rotate(10deg); }

        /* æœˆæ›†æ¨£å¼ */
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%;
            font-size: 0.85rem; cursor: pointer; transition: all 0.2s; position: relative; font-family: 'Caveat', cursive; font-size: 1.1rem;
        }
        .calendar-day.has-entry::after {
            content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; background: var(--accent-sage); border-radius: 50%;
        }
        .calendar-day.selected-day { background-color: var(--accent-clay) !important; color: white !important; }
        .calendar-day.today { border: 2px dashed var(--accent-clay); font-weight: bold; color: var(--accent-clay); }

        .loader {
            width: 30px; height: 30px; border: 3px solid #EBE6DE; border-bottom-color: var(--accent-sage);
            border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ‰‹ç¹ªåœ–ç¤º SVG é€šç”¨æ¨£å¼ */
        .icon-sketch { stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; fill: none; }
        
        /* è¼¸å…¥æ¡†æ‰‹ç¹ªé¢¨ */
        textarea, input[type="text"], input[type="date"] {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            font-family: 'Zen Maru Gothic', sans-serif;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-[#D6C0BE] selection:text-[#59544D]">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <header id="main-header" class="bg-[#F9F8F4]/90 backdrop-blur-sm border-b border-[#E0DBD3] sticky top-0 z-30 shrink-0 hidden">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="window.goHome()">
                <!-- Logo æ›æˆ SVG åå¸ -->
                <svg class="w-7 h-7 text-[#C2A695] group-hover:rotate-12 transition-transform icon-sketch" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M4 14C4 14 4 7 12 7C20 7 20 14 20 14V18C20 19.1 19.1 20 18 20H6C4.9 20 4 19.1 4 18V14Z"></path>
                    <path d="M4 14H20"></path>
                    <path d="M9 11C9 11 9.5 10 10.5 10C11.5 10 12 11 12 11"></path>
                    <path d="M13 11C13 11 13.5 10 14.5 10C15.5 10 16 11 16 11"></path>
                </svg>
                <h1 class="hidden sm:block text-sm font-bold tracking-widest text-[#59544D] font-serif">æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´»</h1>
            </div>
            <div id="header-title" class="flex-1 text-center font-family-caveat text-xl text-[#94A698] font-bold tracking-widest uppercase truncate hand-font">HOME</div>
            <div class="flex items-center gap-2">
                <button onclick="window.openExportModal()" class="p-2 text-[#8C867D] hover:text-[#C2A695]">
                    <svg class="w-5 h-5 icon-sketch" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                </button>
                <input type="date" id="date-picker" class="bg-[#F0EFEB] border-none rounded-md px-3 py-1 text-xs font-mono outline-none text-[#59544D] cursor-pointer" onchange="window.handleDateChange(this.value)">
            </div>
        </div>
    </header>

    <!-- 1. é¦–é è¦–åœ– -->
    <div id="view-home" class="flex-1 overflow-y-auto p-4 md:p-8 w-full max-w-5xl mx-auto flex flex-col">
        
        <div class="flex justify-between items-end mb-10 fade-in pt-4">
            <div class="flex flex-col gap-1">
                <span class="text-xs text-[#C2A695] tracking-[0.2em] font-bold uppercase hand-font text-lg">Smart Manna Life</span>
                <h1 class="text-3xl md:text-4xl font-serif font-bold text-[#59544D] leading-tight flex items-center gap-3">
                    æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» 
                    <svg class="w-8 h-8 text-[#C2A695] icon-sketch" viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                    </svg>
                </h1>
            </div>
            <div class="hidden sm:block">
                <input type="date" id="home-date-picker" class="bg-white border border-[#E0DBD3] rounded-lg px-4 py-2 text-sm font-mono outline-none shadow-sm text-[#59544D]" onchange="window.handleDateChange(this.value)">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 fade-in">
            <!-- ä»Šæ—¥å—å“ªå¡ç‰‡ -->
            <div class="md:col-span-1 flex flex-col sketch-card p-8 relative overflow-hidden group cursor-pointer bg-[#FFFEFA] hover:bg-[#FAF9F7] transition-colors" onclick="window.switchMode('devotion')">
                <!-- è£é£¾ç”¨åœ–æ¡ˆ -->
                <svg class="absolute -right-4 -top-4 w-32 h-32 text-[#E0DBD3] opacity-20 icon-sketch" viewBox="0 0 24 24" stroke="currentColor">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    <path d="M2 12h20"></path>
                </svg>
                
                <div class="inline-block px-3 py-1 bg-[#F0EFEB] text-[#94A698] text-sm font-bold tracking-wider mb-6 self-start hand-font transform -rotate-2">Today's Manna</div>
                
                <div id="home-manna-display" class="z-10 flex-1 flex flex-col justify-center">
                    <p class="serif-font text-2xl text-[#59544D] leading-relaxed mb-6 not-italic" id="manna-text">è¼‰å…¥ä¸­...</p>
                    <p class="text-sm font-bold text-[#C2A695] tracking-widest text-right" id="manna-ref"></p>
                </div>

                <!-- è¡Œå‹•å‘¼ç±²å€åŸŸ -->
                <div class="flex items-center justify-between mt-8 pt-5 border-t border-dashed border-[#E0DBD3] z-10">
                     <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-[#F6E6E6] flex items-center justify-center text-[#C2A695] group-hover:bg-[#C2A695] group-hover:text-white transition-colors shadow-sm">
                            <svg class="w-5 h-5 icon-sketch" viewBox="0 0 24 24" stroke="currentColor">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-[#94A698] font-bold uppercase tracking-wider leading-tight">Start Devotion</span>
                            <span class="text-sm text-[#59544D] font-bold tracking-widest font-serif">é–‹å§‹éˆä¿®</span>
                        </div>
                     </div>
                     <span class="text-xl text-[#C2A695] font-bold group-hover:translate-x-1 transition-transform">â”</span>
                </div>
            </div>

            <!-- éˆä¿®è¶³è·¡æœˆæ›† -->
            <div class="md:col-span-2 sketch-card p-8 bg-white">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-[#59544D] flex items-center gap-2 font-serif text-lg">
                        ç”Ÿå‘½è¶³è·¡ <span id="streak-badge" class="hidden items-center px-3 py-1 rounded-full bg-[#F6E6E6] text-[#C2A695] text-xs ml-2 hand-font">ğŸ”¥ <span id="streak-count" class="mx-1 font-sans font-bold">0</span> Days</span>
                    </h3>
                    <div class="flex items-center gap-4">
                        <button onclick="window.changeCalendarMonth(-1)" class="w-8 h-8 flex items-center justify-center text-[#8C867D] hover:bg-[#F0EFEB] rounded-full transition-colors">â—€</button>
                        <div class="text-base font-bold w-24 text-center text-[#59544D] serif-font" id="calendar-month-label"></div>
                        <button onclick="window.changeCalendarMonth(1)" class="w-8 h-8 flex items-center justify-center text-[#8C867D] hover:bg-[#F0EFEB] rounded-full transition-colors">â–¶</button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs text-[#C2A695] mb-3 font-bold uppercase tracking-widest hand-font">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>
        </div>

        <!-- æ·å¾‘å€åŸŸ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10 fade-in">
            <div onclick="window.switchMode('bible')" class="sketch-card p-6 cursor-pointer flex flex-col items-center gap-3 group hover:bg-[#FAF9F7]">
                <svg class="w-8 h-8 text-[#8C867D] group-hover:text-[#59544D] icon-sketch transition-colors" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <h3 class="text-sm font-bold text-[#59544D] tracking-widest">è–ç¶“é–±è®€</h3>
            </div>
            <div onclick="window.switchMode('journal-prayer')" class="sketch-card p-6 cursor-pointer flex flex-col items-center gap-3 group hover:bg-[#FAF9F7]">
                <svg class="w-8 h-8 text-[#8C867D] group-hover:text-[#94A698] icon-sketch transition-colors" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                <h3 class="text-sm font-bold text-[#59544D] tracking-widest">è·Ÿç¥èŠèŠ</h3>
            </div>
            <div onclick="window.switchMode('journal-gratitude')" class="sketch-card p-6 cursor-pointer flex flex-col items-center gap-3 group hover:bg-[#FAF9F7]">
                <svg class="w-8 h-8 text-[#8C867D] group-hover:text-[#D6C0BE] icon-sketch transition-colors" viewBox="0 0 24 24" stroke="currentColor">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <h3 class="text-sm font-bold text-[#59544D] tracking-widest">æ„Ÿæ©æ—¥è¨˜</h3>
            </div>
            <div onclick="window.switchMode('journal-mood')" class="sketch-card p-6 cursor-pointer flex flex-col items-center gap-3 group hover:bg-[#FAF9F7]">
                <svg class="w-8 h-8 text-[#8C867D] group-hover:text-[#C2A695] icon-sketch transition-colors" viewBox="0 0 24 24" stroke="currentColor">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
                <h3 class="text-sm font-bold text-[#59544D] tracking-widest">å…§å¿ƒæˆ²</h3>
            </div>
        </div>

        <footer class="mt-auto py-10 text-center fade-in border-t border-dashed border-[#E0DBD3] w-11/12 md:w-2/3 mx-auto">
            <div class="flex justify-center flex-wrap gap-5 md:gap-6 mb-4">
                <a href="https://www.facebook.com/profile.php?id=100068500932557" target="_blank" class="text-[#8C867D] hover:text-[#1877F2] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6 icon-sketch" viewBox="0 0 24 24" stroke="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
                <a href="https://www.instagram.com/forever.believe.in.jesus/" target="_blank" class="text-[#8C867D] hover:text-[#E4405F] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6 icon-sketch" viewBox="0 0 24 24" stroke="currentColor"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
                <a href="https://www.threads.net/@forever.believe.in.jesus" target="_blank" class="text-[#8C867D] hover:text-black transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6 icon-sketch" viewBox="0 0 24 24" stroke="currentColor"><path d="M12.27 4.15c-4.46 0-7.85 3.32-7.85 7.85 0 4.54 3.39 7.85 7.85 7.85 2.5 0 4.67-1.16 6.04-2.81l-1.92-1.46c-1 1.15-2.52 1.83-4.12 1.83-2.91 0-5.32-2.31-5.32-5.41s2.41-5.41 5.32-5.41c2.46 0 4.8 1.63 5.24 4.09l.06.35c.19 1.09.08 1.95-.31 2.34-.18.18-.45.26-.81.26-.58 0-1.17-.26-1.54-1.12l-.12-.27c-.49-1.15-.74-2.42-.74-3.69v-.39h-2.52v.4c0 1.57.34 3.09.98 4.49-.9 1.02-2.22 1.69-3.7 1.69-2.7 0-4.9-2.2-4.9-4.9 0-2.7 2.2-4.9 4.9-4.9 2.59 0 4.86 1.98 5.16 4.53.13 1.14.07 2.01-.17 2.65-.54 1.43-1.69 1.98-2.98 1.98-1.25 0-2.2-.69-2.61-1.91-.45-.87-.45-1.95-.45-2.07 0-.58.11-1.14.32-1.67.58-1.45 2.03-2.46 3.69-2.46z"/></svg></a>
                <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" class="text-[#8C867D] hover:text-[#00C300] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6 icon-sketch" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></a>
                <a href="mailto:newthingsinthelittlelight@gmail.com" class="text-[#8C867D] hover:text-[#C2A695] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6 icon-sketch" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
            </div>
            <p class="text-[10px] text-[#C2A695] font-bold tracking-widest uppercase hand-font text-lg">è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹ Â© 2024</p>
        </footer>
    </div>

    <!-- 2. å·¥ä½œå€è¦–åœ– -->
    <main id="view-workspace" class="hidden flex-1 w-full max-w-7xl mx-auto flex flex-col h-full overflow-hidden bg-[#F9F8F4]">
        
        <!-- å…¨åŸŸåˆ†é åˆ‡æ› (éˆä¿®æ¨¡å¼) -->
        <div id="workspace-tabs" class="flex border-b border-[#E0DBD3] shrink-0 bg-[#F9F8F4] z-20 px-4 pt-2 gap-2">
            <button id="tab-reader" class="workspace-tab-btn active rounded-t-xl" onclick="window.switchWorkspaceTab('reader')">
                <span class="text-xl mr-1 hand-font">Read</span> <span id="tab-reader-text">é–±è®€ç¶“æ–‡</span>
            </button>
            <button id="tab-journal" class="workspace-tab-btn rounded-t-xl" onclick="window.switchWorkspaceTab('journal')">
                <span class="text-xl mr-1 hand-font">Write</span> <span id="tab-journal-text">éˆä¿®ç­†è¨˜</span>
            </button>
        </div>

        <!-- é›™æ¬„å…§å®¹å®¹å™¨ -->
        <div class="flex-1 flex overflow-hidden relative p-0 md:p-4 gap-4">
            
            <!-- é–±è®€å™¨å€å¡Š (Left) -->
            <section id="section-reader" class="w-full lg:w-1/2 flex flex-col bg-white border border-[#E0DBD3] rounded-none md:rounded-2xl transition-all duration-300 absolute lg:relative inset-0 z-10 lg:z-auto shadow-sm">
                
                <!-- A. Devotion Tabs (Sticky top in section) -->
                <div id="devotion-tabs" class="hidden grid grid-cols-4 gap-3 p-4 bg-[#FAF9F7] border-b border-dashed border-[#E0DBD3] shrink-0 rounded-t-2xl"></div>
                
                <!-- B. Universal Header (New) -->
                <div id="reader-universal-header" class="px-5 py-4 border-b border-[#E0DBD3] flex justify-between items-center bg-[#FAF9F7] shrink-0 rounded-t-2xl">
                    <!-- Left: Nav/Title -->
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                         <!-- Back Button (Dynamic) -->
                         <button id="btn-header-back" onclick="window.goBackToMainBooks()" class="hidden shrink-0 w-8 h-8 rounded-full border border-[#C2A695] text-[#C2A695] flex items-center justify-center text-xs hover:bg-[#C2A695] hover:text-white transition-colors">â—€</button>
                         
                         <!-- Title Info -->
                         <div class="min-w-0">
                             <div class="flex items-center gap-2">
                                <span id="header-subtitle" class="text-[12px] font-bold text-[#94A698] uppercase tracking-widest block hand-font">Scripture</span>
                                <!-- Added Copy Progress Button -->
                                <button id="btn-copy-progress" onclick="window.copyDevotionProgress()" class="hidden text-[10px] text-[#94A698] border border-[#94A698] rounded px-1 hover:bg-[#94A698] hover:text-white transition-colors leading-tight" title="è¤‡è£½ä»Šæ—¥é€²åº¦">
                                    è¤‡è£½ä»Šæ—¥é€²åº¦
                                </button>
                             </div>
                             <h2 id="header-main-title" class="text-lg text-[#59544D] font-bold truncate font-serif">Bible Reading</h2>
                         </div>
                    </div>
                    <!-- Right: Actions -->
                    <div class="flex items-center gap-2">
                         <!-- Search (Always visible) -->
                         <div class="relative" id="search-box">
                             <input type="text" id="inline-search" placeholder="Search..." class="pl-3 pr-8 py-1.5 rounded-lg bg-white text-xs w-28 focus:w-48 transition-all outline-none border border-[#E0DBD3] focus:border-[#94A698]" onkeyup="if(event.key==='Enter') window.performSearch()">
                             <button onclick="window.performSearch()" class="absolute right-2 top-2 text-[#8C867D]"><svg class="w-4 h-4 icon-sketch" viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                         </div>
                         <!-- Copy (Only visible in content mode) -->
                         <button id="btn-copy-verses" onclick="window.copySelectedVerses()" class="hidden w-9 h-9 flex items-center justify-center rounded-lg bg-white text-[#8C867D] border border-[#E0DBD3] hover:border-[#C2A695] hover:text-[#C2A695] transition-colors shadow-sm">
                            <svg class="w-5 h-5 icon-sketch" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                         </button>
                    </div>
                </div>

                <!-- C. Scrollable Content Wrapper -->
                <div id="reader-content-wrapper" class="flex-1 overflow-y-auto relative bg-white">
                    
                    <!-- 1. Books View -->
                    <div id="view-bible-books" class="hidden flex-col min-h-full p-6">
                         <div class="flex gap-4 mb-6 shrink-0">
                            <button onclick="window.renderMainBooks('old')" id="btn-old" class="flex-1 py-3 text-sm font-bold rounded-lg border-2 border-[#C2A695] bg-[#C2A695] text-white transition-all transform hover:-translate-y-1">èˆŠç´„ Old Testament</button>
                            <button onclick="window.renderMainBooks('new')" id="btn-new" class="flex-1 py-3 text-sm font-bold rounded-lg border-2 border-[#C2A695] bg-white text-[#C2A695] transition-all transform hover:-translate-y-1">æ–°ç´„ New Testament</button>
                        </div>
                        <div id="main-book-list" class="grid grid-cols-2 sm:grid-cols-4 gap-3 content-start pb-10"></div>
                    </div>

                    <!-- 2. Chapters View -->
                    <div id="view-bible-chapters" class="hidden flex-col min-h-full p-6">
                        <h3 id="main-chapter-title" class="text-3xl font-serif font-bold text-[#59544D] mb-8 border-b-2 border-[#F0EFEB] pb-4"></h3>
                        <div id="main-chapter-grid" class="grid grid-cols-5 sm:grid-cols-6 gap-3 pb-10"></div>
                    </div>

                    <!-- 3. Text View -->
                    <div id="view-bible-text" class="hidden min-h-full p-6 md:p-10 bible-text text-[#4A4A4A] bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]"></div>
                </div>
            </section>

            <!-- ç­†è¨˜å€å¡Š (Right) -->
            <section id="section-journal" class="w-full lg:w-1/2 flex flex-col bg-white border border-[#E0DBD3] rounded-none md:rounded-2xl transition-all duration-300 absolute lg:relative inset-0 opacity-0 lg:opacity-100 pointer-events-none lg:pointer-events-auto z-0 lg:z-auto shadow-sm">
                <div class="bg-[#FAF9F7] px-6 py-4 border-b border-[#E0DBD3] flex gap-3 overflow-x-auto no-scrollbar items-center shrink-0 rounded-t-2xl">
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜€ï¸')">â˜€ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜ï¸')">â˜ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ§ï¸')">ğŸŒ§ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸ”¥')">ğŸ”¥</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ±')">ğŸŒ±</button>
                    <input type="hidden" id="note-mood">
                </div>
                <div class="flex-1 overflow-y-auto p-8 space-y-10 pb-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                    <!-- éˆä¿®ç­†è¨˜ (Devotion) -->
                    <div id="journal-devotion-fields" class="space-y-8">
                        <!-- è‡ªå‹•æŠ“å–ä»Šæ—¥é€²åº¦ -->
                        <div>
                            <label class="block text-sm font-bold text-[#8C867D] mb-2 uppercase tracking-widest hand-font">ğŸ“– Reading / ä»Šæ—¥é€²åº¦</label>
                            <input type="text" id="note-devotion-progress" readonly class="w-full bg-[#FAF9F7] border border-[#E0DBD3] rounded-lg p-3 text-sm text-[#59544D] outline-none select-none cursor-default" value="è¼‰å…¥ä¸­...">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-[#C2A695] mb-2 uppercase tracking-widest hand-font">âœ¨ Rhema / è§¸å‹•é‡‘å¥</label>
                            <textarea id="note-rhema" placeholder="è¨˜ä¸‹ä»Šå¤©æœ€è§¸å‹•ä½ çš„ç¶“æ–‡..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#C2A695] outline-none min-h-[80px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-[#94A698] mb-2 uppercase tracking-widest hand-font">ğŸ“ Reflection / éˆä¿®å¿ƒå¾—</label>
                            <textarea id="note-reflection" placeholder="ä½ çš„çœ‹è¦‹ã€é«”æœƒï¼Œæˆ–æ˜¯å¤©çˆ¶å°ä½ èªªçš„è©±..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#94A698] outline-none min-h-[150px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                        
                        <!-- æ–°å¢ï¼šç”Ÿæ´»æ‡‰ç”¨ -->
                        <div>
                            <label class="block text-sm font-bold text-[#8C867D] mb-2 uppercase tracking-widest hand-font">ğŸŒ± Action / ç”Ÿæ´»æ‡‰ç”¨</label>
                            <textarea id="note-application" placeholder="å…·é«”å¯ä»¥è¡Œå‡ºä¾†çš„å°ç·´ç¿’..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#8C867D] outline-none min-h-[80px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-[#C2A695] mb-2 uppercase tracking-widest hand-font">ğŸ’Œ Response / ç¦±å‘Šå›æ‡‰</label>
                            <textarea id="note-prayer-devotion" placeholder="å¯«çµ¦ç¥çš„å›ä¿¡..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#C2A695] outline-none min-h-[100px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>
                    
                    <!-- è·Ÿç¥èŠèŠ (Prayer) -->
                    <div id="journal-prayer-fields" class="space-y-8 hidden">
                        <div>
                            <label class="block text-sm font-bold text-[#C2A695] mb-2 uppercase tracking-widest hand-font">ğŸ¯ Wish / è¨±é¡˜æ± </label>
                            <textarea id="note-topic" placeholder="æƒ³è¦ä»€éº¼ï¼Ÿå¤§è†½è·Ÿç¥æ±‚..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#C2A695] outline-none min-h-[60px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-[#94A698] mb-2 uppercase tracking-widest hand-font">ğŸ’¬ Murmur / ç¢ç¢å”¸</label>
                            <textarea id="note-content" placeholder="æŠŠå¿ƒè£¡è©±éƒ½å€’å‡ºä¾†å§..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#94A698] outline-none min-h-[200px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>

                    <!-- æ„Ÿæ©æ—¥è¨˜ (Gratitude) -->
                    <div id="journal-gratitude-fields" class="space-y-8 hidden">
                        <div>
                            <label class="block text-sm font-bold text-[#C2A695] mb-2 uppercase tracking-widest hand-font">ğŸ’– Gratitude / æ„Ÿæ©äº‹é …</label>
                            <textarea id="note-thanks" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å¥½äº‹ï¼Ÿ..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#C2A695] outline-none min-h-[120px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-[#94A698] mb-2 uppercase tracking-widest hand-font">âœ¨ Grace / æ©å…¸è¨˜è™Ÿ</label>
                            <textarea id="note-grace" placeholder="å“ªè£¡çœ‹è¦‹ç¥çš„ä½œç‚ºï¼Ÿ..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#94A698] outline-none min-h-[120px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>

                    <!-- å…§å¿ƒæˆ² (Mood) -->
                    <div id="journal-mood-fields" class="space-y-8 hidden">
                        <div class="p-5 bg-[#FAF9F7] rounded-3xl border border-dashed border-[#E0DBD3]">
                            <label class="block text-base font-bold text-[#59544D] mb-3 uppercase hand-font">ğŸ¬ Event / ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ</label>
                            <textarea id="note-mood-event" placeholder="è¨˜éŒ„äº‹ä»¶èˆ‡æ„Ÿå—..." class="w-full bg-white border border-[#E0DBD3] rounded-xl p-4 text-base outline-none resize-none h-28 focus:border-[#C2A695] leading-relaxed"></textarea>
                        </div>

                        <!-- æƒ…ç·’æ¨™è¨»å€å¡Š -->
                        <div>
                            <label class="block text-lg font-bold text-[#8C867D] mb-2 hand-font">ğŸ·ï¸ Emotions / æƒ…ç·’æ¨™ç±¤</label>
                            <textarea id="note-mood-tags" placeholder="æŠŠæ‰€æœ‰èƒ½æ„Ÿå—åˆ°çš„æƒ…ç·’å¾æœ€å¼·åˆ—çš„æƒ…ç·’é–‹å§‹ä¸€å€‹ä¸€å€‹å¯«ä¸‹ä¾†..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#8C867D] outline-none min-h-[60px] resize-none p-2 text-lg"></textarea>
                        </div>

                        <div class="grid grid-cols-1 gap-8">
                            <div>
                                <label class="block text-lg font-bold text-[#C2A695] mb-2 hand-font">ğŸ¤¥ Lie / æˆ‘ç›¸ä¿¡äº†ä»€éº¼è¬Šè¨€ï¼Ÿ</label>
                                <textarea id="note-mood-lie" placeholder="æˆ‘èªç‚ºé€™ä»¶äº‹æ˜¯å› ç‚ºä»€éº¼..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#C2A695] outline-none min-h-[50px] resize-none p-2 text-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-lg font-bold text-[#94A698] mb-2 hand-font">ğŸ‘“ Truth / ç¥æ€éº¼çœ‹é€™ä»¶äº‹ï¼Ÿ</label>
                                <textarea id="note-mood-god-view" placeholder="åœ¨ç¦±å‘Šä¸­é ˜å—ç¥çš„çœ¼å…‰..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#94A698] outline-none min-h-[50px] resize-none p-2 text-lg"></textarea>
                            </div>
                        </div>

                        <!-- ç¦±å‘Šå€å¡Š -->
                        <div>
                            <label class="block text-lg font-bold text-[#C2A695] mb-2 hand-font">ğŸ™ Prayer / ç¦±å‘Š & é ˜å—</label>
                            <textarea id="note-mood-prayer" placeholder="æœ€å¾Œçš„äº¤è¨—èˆ‡é ˜å—..." class="w-full bg-transparent border-b-2 border-dashed border-[#E0DBD3] focus:border-[#C2A695] outline-none min-h-[100px] resize-none p-2 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>

                    <!-- åº•éƒ¨å„²å­˜æç¤º -->
                    <div class="pt-8">
                        <button onclick="window.backupData()" class="w-full py-4 rounded-xl bg-[#FAF9F7] border border-[#E0DBD3] text-[#8C867D] text-sm font-bold hover:bg-[#C2A695] hover:text-white transition-all flex items-center justify-center gap-3 group shadow-sm">
                            <span class="group-hover:scale-110 transition-transform">ğŸ’¾</span> 
                            <span>Save & Backup</span>
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal -->
    <div id="export-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-[#59544D]/20 backdrop-blur-sm hidden" onclick="if(event.target===this)window.closeExportModal()">
        <div class="bg-[#FFFEFA] w-full max-w-sm p-8 rounded-[40px] shadow-2xl m-4 border border-[#E0DBD3]" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-3 font-serif text-[#59544D] text-center">Data Manager</h3>
            <p class="text-sm text-[#8C867D] mb-8 text-center">ç­†è¨˜å„²å­˜åœ¨ç€è¦½å™¨ä¸­ï¼Œè¨˜å¾—å®šæœŸå‚™ä»½ã€‚</p>
            <div class="grid grid-cols-1 gap-4">
                 <button onclick="window.backupData()" class="w-full py-4 rounded-2xl bg-[#C2A695] text-white hover:bg-[#B09280] transition-all text-sm font-bold flex items-center justify-center gap-3 shadow-md">
                    <svg class="w-5 h-5 icon-sketch" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    ä¸‹è¼‰å‚™ä»½ (.json)
                 </button>
                 <button onclick="document.getElementById('restore-input').click()" class="w-full py-4 rounded-2xl border-2 border-[#E0DBD3] hover:border-[#94A698] hover:text-[#94A698] transition-all text-sm font-bold text-[#8C867D] flex items-center justify-center gap-3">
                    <svg class="w-5 h-5 icon-sketch" stroke="currentColor" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                    é‚„åŸè³‡æ–™
                 </button>
                 <input type="file" id="restore-input" class="hidden" accept=".json" onchange="window.restoreData(this)">
            </div>
            <button onclick="window.closeExportModal()" class="mt-8 text-xs text-[#C2A695] font-bold w-full text-center hover:underline uppercase tracking-widest">Close</button>
        </div>
    </div>

    <script>
        // --- è¨­å®š ---
        const REMOTE_DB_URL = "https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db";
        let sqlDb = null, sqlDbLoaded = false, SQL = null, els = {};
        let dbTable = "verses";
        let dbCols = { book: "book", chapter: "chapter", verse: "verse", text: "text" };
        let currentMode = 'home';
        let calendarDate = new Date();
        let currentDailyPlan = []; 

        const mannaVerses = [
            { t: "ã€Œæ•¬ç•è€¶å’Œè¯æ˜¯æ™ºæ…§çš„é–‹ç«¯ã€‚ã€", r: "â€” ç®´è¨€ 9:10" },
            { t: "ã€Œè€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚ã€", r: "â€” è©©ç¯‡ 23:1" },
            { t: "ã€Œå–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥ï¼›æ†‚å‚·çš„éˆä½¿éª¨æ¯ä¹¾ã€‚ã€", r: "â€” ç®´è¨€ 17:22" },
            { t: "ã€Œæˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚ã€", r: "â€” è…“ç«‹æ¯”æ›¸ 4:13" },
            { t: "ã€Œå‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚ã€", r: "â€” é¦¬å¤ªç¦éŸ³ 11:28" }
        ];

        const bibleBooks = {
            old: [{n:"å‰µä¸–è¨˜",abbr:"å‰µ",c:50},{n:"å‡ºåŸƒåŠè¨˜",abbr:"å‡º",c:40},{n:"åˆ©æœªè¨˜",abbr:"åˆ©",c:27},{n:"æ°‘æ•¸è¨˜",abbr:"æ°‘",c:36},{n:"ç”³å‘½è¨˜",abbr:"ç”³",c:34},{n:"ç´„æ›¸äºè¨˜",abbr:"æ›¸",c:24},{n:"å£«å¸«è¨˜",abbr:"å£«",c:21},{n:"è·¯å¾—è¨˜",abbr:"å¾—",c:4},{n:"æ’’æ¯è€³è¨˜ä¸Š",abbr:"æ’’ä¸Š",c:31},{n:"æ’’æ¯è€³è¨˜ä¸‹",abbr:"æ’’ä¸‹",c:24},{n:"åˆ—ç‹ç´€ä¸Š",abbr:"ç‹ä¸Š",c:22},{n:"åˆ—ç‹ç´€ä¸‹",abbr:"ç‹ä¸‹",c:25},{n:"æ­·ä»£å¿—ä¸Š",abbr:"ä»£ä¸Š",c:29},{n:"æ­·ä»£å¿—ä¸‹",abbr:"ä»£ä¸‹",c:36},{n:"ä»¥æ–¯æ‹‰è¨˜",abbr:"æ‹‰",c:10},{n:"å°¼å¸Œç±³è¨˜",abbr:"å°¼",c:13},{n:"ä»¥æ–¯å¸–è¨˜",abbr:"æ–¯",c:10},{n:"ç´„ä¼¯è¨˜",abbr:"ä¼¯",c:42},{n:"è©©ç¯‡",abbr:"è©©",c:150},{n:"ç®´è¨€",abbr:"ç®´",c:31},{n:"å‚³é“æ›¸",abbr:"å‚³",c:12},{n:"é›…æ­Œ",abbr:"æ­Œ",c:8},{n:"ä»¥è³½äºæ›¸",abbr:"è³½",c:66},{n:"è€¶åˆ©ç±³æ›¸",abbr:"è€¶",c:52},{n:"è€¶åˆ©ç±³å“€æ­Œ",abbr:"å“€",c:5},{n:"ä»¥è¥¿çµæ›¸",abbr:"çµ",c:48},{n:"ä½†ä»¥ç†æ›¸",abbr:"ä½†",c:12},{n:"ä½•è¥¿é˜¿æ›¸",abbr:"ä½•",c:14},{n:"ç´„ç¥æ›¸",abbr:"ç¥",c:3},{n:"é˜¿æ‘©å¸æ›¸",abbr:"æ‘©",c:9},{n:"ä¿„å·´åº•äºæ›¸",abbr:"ä¿„",c:1},{n:"ç´„æ‹¿æ›¸",abbr:"æ‹¿",c:4},{n:"å½Œè¿¦æ›¸",abbr:"å½Œ",c:7},{n:"é‚£é´»æ›¸",abbr:"é´»",c:3},{n:"å“ˆå·´è°·æ›¸",abbr:"å“ˆ",c:3},{n:"è¥¿ç•ªé›…æ›¸",abbr:"ç•ª",c:3},{n:"å“ˆè©²æ›¸",abbr:"è©²",c:2},{n:"æ’’è¿¦åˆ©äºæ›¸",abbr:"äº",c:14},{n:"ç‘ªæ‹‰åŸºæ›¸",abbr:"ç‘ª",c:4}],
            new: [{n:"é¦¬å¤ªç¦éŸ³",abbr:"å¤ª",c:28},{n:"é¦¬å¯ç¦éŸ³",abbr:"å¯",c:16},{n:"è·¯åŠ ç¦éŸ³",abbr:"è·¯",c:24},{n:"ç´„ç¿°ç¦éŸ³",abbr:"ç´„",c:21},{n:"ä½¿å¾’è¡Œå‚³",abbr:"å¾’",c:28},{n:"ç¾…é¦¬æ›¸",abbr:"ç¾…",c:16},{n:"å“¥æ—å¤šå‰æ›¸",abbr:"æ—å‰",c:16},{n:"å“¥æ—å¤šå¾Œæ›¸",abbr:"æ—å¾Œ",c:13},{n:"åŠ æ‹‰å¤ªæ›¸",abbr:"åŠ ",c:6},{n:"ä»¥å¼—æ‰€æ›¸",abbr:"å¼—",c:6},{n:"è…“ç«‹æ¯”æ›¸",abbr:"è…“",c:4},{n:"æ­Œç¾…è¥¿æ›¸",abbr:"è¥¿",c:4},{n:"å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸",abbr:"å¸–å‰",c:5},{n:"å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸",abbr:"å¸–å¾Œ",c:3},{n:"ææ‘©å¤ªå‰æ›¸",abbr:"æå‰",c:6},{n:"ææ‘©å¤ªå¾Œæ›¸",abbr:"æå¾Œ",c:4},{n:"æå¤šæ›¸",abbr:"å¤š",c:3},{n:"è…“åˆ©é–€æ›¸",abbr:"é–€",c:1},{n:"å¸Œä¼¯ä¾†æ›¸",abbr:"ä¾†",c:13},{n:"é›…å„æ›¸",abbr:"é›…",c:5},{n:"å½¼å¾—å‰æ›¸",abbr:"å½¼å‰",c:5},{n:"å½¼å¾—å¾Œæ›¸",abbr:"å½¼å¾Œ",c:3},{n:"ç´„ç¿°ä¸€æ›¸",abbr:"ç´„ä¸€",c:5},{n:"ç´„ç¿°äºŒæ›¸",abbr:"ç´„äºŒ",c:1},{n:"ç´„ç¿°ä¸‰æ›¸",abbr:"ç´„ä¸‰",c:1},{n:"çŒ¶å¤§æ›¸",abbr:"çŒ¶",c:1},{n:"å•Ÿç¤ºéŒ„",abbr:"å•Ÿ",c:22}]
        };

        const planTracks = [
            {t: "èˆŠç´„", books: bibleBooks.old},
            {t: "æ–°ç´„", books: bibleBooks.new},
            {t: "è©©ç¯‡", books: [{n:"è©©ç¯‡",abbr:"è©©",c:150}]},
            {t: "ç®´è¨€", books: [{n:"ç®´è¨€",abbr:"ç®´",c:31}]}
        ];

        const bookMap = {};
        [...bibleBooks.old, ...bibleBooks.new].forEach(b => {
            bookMap[b.abbr] = b.n;
            bookMap[b.n] = b.n;
            bookMap[b.n.replace("æ›¸","")] = b.n;
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // åˆå§‹åŒ–
        async function initApp() {
            els = {
                viewHome: document.getElementById('view-home'),
                viewWorkspace: document.getElementById('view-workspace'),
                mainHeader: document.getElementById('main-header'),
                // ä¿®æ­£ï¼šå¾æ–°çš„é€šç”¨ Header æŠ“å–å…ƒç´ 
                readerTitle: document.getElementById('header-main-title'),
                readerSubtitle: document.getElementById('header-subtitle'),
                backBtn: document.getElementById('btn-header-back'),
                copyBtn: document.getElementById('btn-copy-verses'),
                btnCopyProgress: document.getElementById('btn-copy-progress'),
                
                headerTitle: document.getElementById('header-title'),
                datePicker: document.getElementById('date-picker'),
                homeDatePicker: document.getElementById('home-date-picker'),
                inlineSearch: document.getElementById('inline-search'),
                calendarGrid: document.getElementById('calendar-grid'),
                calendarMonthLabel: document.getElementById('calendar-month-label'),
                streakCount: document.getElementById('streak-count'),
                streakBadge: document.getElementById('streak-badge'),
                
                // Content Views
                viewBooks: document.getElementById('view-bible-books'),
                viewChapters: document.getElementById('view-bible-chapters'),
                viewText: document.getElementById('view-bible-text')
            };

            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            window.handleDateChange(todayKey);
            window.setAppIcon();

            try {
                SQL = await window.initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
                const res = await fetch(REMOTE_DB_URL);
                if (!res.ok) throw new Error("Network Error");
                const buffer = await res.arrayBuffer();
                sqlDb = new SQL.Database(new Uint8Array(buffer));
                sqlDbLoaded = true;
                window.detectTableStructure();
                els.inlineSearch.placeholder = "ğŸ” æœå°‹ç¶“æ–‡...";
            } catch(e) {
                console.error("DB Load Fail", e);
                els.inlineSearch.placeholder = "âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—";
            }

            window.renderCalendar();
            window.calculateStreak();
        }

        window.setAppIcon = function() {
            const canvas = document.createElement('canvas');
            canvas.width = 192;
            canvas.height = 192;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, 192, 192);
            ctx.translate(96, 96); 
            ctx.scale(6.5, 6.5);   
            ctx.translate(-12, -12); 
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 1.8; 
            ctx.beginPath();
            ctx.moveTo(4, 14);
            ctx.bezierCurveTo(4, 14, 4, 7, 12, 7);
            ctx.bezierCurveTo(20, 7, 20, 14, 20, 14);
            ctx.lineTo(20, 18);
            ctx.bezierCurveTo(20, 19.1, 19.1, 20, 18, 20);
            ctx.lineTo(6, 20);
            ctx.bezierCurveTo(4.9, 20, 4, 19.1, 4, 18);
            ctx.lineTo(4, 14);
            ctx.closePath();
            ctx.fillStyle = '#FFF8E7'; 
            ctx.fill();
            ctx.strokeStyle = '#8B5E3C'; 
            ctx.stroke();
            ctx.beginPath(); ctx.moveTo(4, 14); ctx.lineTo(20, 14); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(9, 11); ctx.bezierCurveTo(9, 11, 9.5, 10, 10.5, 10); ctx.bezierCurveTo(11.5, 10, 12, 11, 12, 11); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(13, 11); ctx.bezierCurveTo(13, 11, 13.5, 10, 14.5, 10); ctx.bezierCurveTo(15.5, 10, 16, 11, 16, 11); ctx.stroke();
            const dataURL = canvas.toDataURL('image/png');
            const existingIcons = document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]');
            existingIcons.forEach(e => e.remove());
            const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.type = 'image/png'; linkIcon.href = dataURL; document.head.appendChild(linkIcon);
            const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = dataURL; document.head.appendChild(linkApple);
        }

        window.detectTableStructure = function() {
            if(!sqlDb) return;
            try {
                const tables = sqlDb.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
                if(tables[0] && tables[0].values.length > 0) {
                    const names = tables[0].values.flat();
                    dbTable = names.includes('verses') ? 'verses' : (names.includes('bible') ? 'bible' : names[0]);
                }
                const cols = sqlDb.exec(`PRAGMA table_info(${dbTable})`);
                if(cols.length > 0) {
                    const colNames = cols[0].values.map(r => r[1]);
                    if(colNames.includes('content')) dbCols.text = 'content';
                    else if(colNames.includes('scripture')) dbCols.text = 'scripture';
                    else if(colNames.includes('text')) dbCols.text = 'text';
                    if(colNames.includes('book_name')) dbCols.book = 'book_name';
                    else if(colNames.includes('book')) dbCols.book = 'book';
                    if(colNames.includes('chapter_number')) dbCols.chapter = 'chapter_number';
                    else if(colNames.includes('chapter')) dbCols.chapter = 'chapter';
                    if(colNames.includes('verse_number')) dbCols.verse = 'verse_number';
                    else if(colNames.includes('verse')) dbCols.verse = 'verse';
                }
            } catch(e) { console.error("Table detection failed", e); }
        }

        // åˆ‡æ›æ¨¡å¼ (æ›´æ–°ç‰ˆ)
        window.switchMode = function(m) {
            currentMode = m;
            els.viewHome.classList.toggle('hidden', m !== 'home');
            els.viewWorkspace.classList.toggle('hidden', m === 'home');
            els.mainHeader.classList.toggle('hidden', m === 'home');

            const isDevotion = m === 'devotion';
            const isPureJournal = ['journal-prayer','journal-gratitude','journal-mood'].includes(m);
            const isBible = m === 'bible';

            // 1. UI å…ƒç´ åˆ‡æ›
            document.getElementById('workspace-tabs').classList.toggle('hidden', !isDevotion);
            document.getElementById('devotion-tabs').classList.toggle('hidden', !isDevotion);
            
            // æœå°‹æ¡†åªåœ¨è–ç¶“æ¨¡å¼é¡¯ç¤º (å…¶ä»–æ¨¡å¼é€šå¸¸ä¸éœ€è¦)
            document.getElementById('search-box').classList.toggle('invisible', !isBible); 

            // ç­†è¨˜æ¬„ä½
            ['journal-devotion-fields', 'journal-prayer-fields', 'journal-gratitude-fields', 'journal-mood-fields']
                .forEach(id => document.getElementById(id).classList.add('hidden'));

            const readerSec = document.getElementById('section-reader');
            const journalSec = document.getElementById('section-journal');

            // é‡ç½®å€å¡Šå¯¬åº¦
            readerSec.classList.remove('hidden', 'lg:w-1/2');
            journalSec.classList.remove('hidden', 'lg:w-1/2');
            readerSec.classList.add('w-full'); 
            journalSec.classList.add('w-full');

            // é‡ç½® Header ç‹€æ…‹
            els.backBtn.classList.add('hidden');
            els.copyBtn.classList.add('hidden');

            // è¤‡è£½é€²åº¦æŒ‰éˆ•ç‹€æ…‹ï¼šåªåœ¨éˆä¿®æ¨¡å¼é¡¯ç¤º
            if (els.btnCopyProgress) {
                els.btnCopyProgress.classList.toggle('hidden', !isDevotion);
            }

            if (isDevotion) {
                // éˆä¿®æ¨¡å¼ (å·¦å³åˆ†æ¬„)
                readerSec.classList.remove('w-full');
                journalSec.classList.remove('w-full');
                readerSec.classList.add('lg:w-1/2');
                journalSec.classList.add('lg:w-1/2');

                document.getElementById('journal-devotion-fields').classList.remove('hidden');
                els.headerTitle.innerText = "Daily Devotion";
                
                // Reader Header for Devotion
                els.readerTitle.innerText = "Daily Devotion";
                els.readerSubtitle.innerText = "Reading Plan";
                
                window.updateDevotionUI();
                window.switchWorkspaceTab('reader'); 
            } else if (isBible) {
                // è–ç¶“æ¨¡å¼ (å…¨å¯¬é–±è®€)
                journalSec.classList.add('hidden'); 
                
                els.headerTitle.innerText = "Bible Reading";
                // Reader Header for Bible
                els.readerTitle.innerText = "Bible Reading";
                els.readerSubtitle.innerText = "Select Book";

                window.renderMainBooks('old');
                window.goBackToMainBooks();
                window.switchWorkspaceTab('reader'); 
            } else if (isPureJournal) {
                // ç´”ç­†è¨˜æ¨¡å¼
                readerSec.classList.add('hidden'); 
                
                const map = {'journal-prayer':'Prayer Journal','journal-gratitude':'Gratitude','journal-mood':'Mood Diary'};
                const fieldMap = {'journal-prayer':'journal-prayer-fields','journal-gratitude':'journal-gratitude-fields','journal-mood':'journal-mood-fields'};
                els.headerTitle.innerText = map[m];
                document.getElementById(fieldMap[m]).classList.remove('hidden');
                window.switchWorkspaceTab('journal'); 
            }
        }

        window.fetchBibleRef = async function(refInput) {
            if (!sqlDbLoaded || !refInput) return;
            const ref = refInput.trim();
            // åˆ‡æ›åˆ°æ–‡å­—é¡¯ç¤ºæ¨¡å¼
            els.viewBooks.classList.add('hidden');
            els.viewChapters.classList.add('hidden');
            els.viewText.classList.remove('hidden');
            // é¡¯ç¤ºè¤‡è£½æŒ‰éˆ• & è¿”å›æŒ‰éˆ•
            els.copyBtn.classList.remove('hidden');
            els.backBtn.classList.remove('hidden');
            
            els.viewText.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>';
            
            const match = ref.match(/^([\u4e00-\u9fa5]+|[a-zA-Z]+)\s*(\d+)(?::(\d+)(?:-(\d+))?)?$/);
            const bookKey = match ? match[1] : null;
            const isBookRef = bookKey && (bookMap[bookKey] || bookMap[bookKey.replace("æ›¸","")]);

            if (match && isBookRef) {
                const book = bookMap[bookKey] || bookKey; 
                const chapter = parseInt(match[2]);
                const startV = match[3] ? parseInt(match[3]) : 1;
                const endV = match[4] ? parseInt(match[4]) : (match[3] ? parseInt(match[3]) : 200); 

                try {
                    const query = `SELECT ${dbCols.chapter}, ${dbCols.verse}, ${dbCols.text} FROM ${dbTable} WHERE ${dbCols.book} = ? AND ${dbCols.chapter} = ? AND ${dbCols.verse} >= ? AND ${dbCols.verse} <= ?`;
                    const res = sqlDb.exec(query, [book, chapter, startV, endV]);
                    
                    if (res.length > 0) {
                        els.readerTitle.innerText = `${book} ${chapter}`;
                        els.readerSubtitle.innerText = "Scripture";
                        els.viewText.innerHTML = res[0].values.map(v => `
                            <div class="verse-item mb-4 p-2 rounded-xl" onclick="this.classList.toggle('selected'); window.updateCopyButton()">
                                <span class="text-[10px] font-bold text-[#C2A695] mr-2 font-mono bg-[#FAF9F7] px-1 rounded select-none">${v[1]}</span>
                                <span class="text-verse leading-loose">${v[2]}</span>
                            </div>
                        `).join('');
                    } else {
                        els.viewText.innerHTML = "<p class='p-8 opacity-50 text-center text-sm'>æ­¤ç« ç¯€æŸ¥ç„¡å…§å®¹ã€‚</p>";
                    }
                } catch(e) { console.error(e); }
            } else {
                // é—œéµå­—æœå°‹
                try {
                    els.readerTitle.innerText = `æœå°‹: "${ref}"`;
                    els.readerSubtitle.innerText = "Search Result";
                    const query = `SELECT ${dbCols.book}, ${dbCols.chapter}, ${dbCols.verse}, ${dbCols.text} FROM ${dbTable} WHERE ${dbCols.text} LIKE ? LIMIT 50`;
                    const res = sqlDb.exec(query, [`%${ref}%`]);

                    if (res.length > 0) {
                        const results = res[0].values;
                        els.viewText.innerHTML = results.map(v => {
                            const highlightedTxt = v[3].replace(new RegExp(ref, 'g'), `<span class="bg-[#F6E6E6] text-[#59544D] font-bold px-1 rounded">${ref}</span>`);
                            return `
                                <div class="verse-item mb-4 p-4 rounded-2xl border border-transparent hover:border-[#E0DBD3] transition-all bg-white shadow-sm cursor-pointer" onclick="this.classList.toggle('selected'); window.updateCopyButton()">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-[10px] font-bold text-white bg-[#C2A695] px-2 py-1 rounded-md tracking-wider">${v[0]} ${v[1]}:${v[2]}</span>
                                    </div>
                                    <span class="text-verse text-[#59544D] leading-relaxed block">${highlightedTxt}</span>
                                </div>
                            `;
                        }).join('');
                    } else {
                        els.viewText.innerHTML = `<div class="flex flex-col items-center justify-center py-12 opacity-60"><span class="text-4xl mb-4">ğŸ‚</span><p class="text-sm font-serif">æ‰¾ä¸åˆ°åŒ…å«ã€Œ${ref}ã€çš„ç¶“æ–‡</p></div>`;
                    }
                } catch(e) { console.error(e); }
            }
        }

        // é€²åº¦è¨ˆç®— (1å¹´ 365 å¤©)
        window.updateDevotionUI = function() {
            const start = new Date(calendarDate.getFullYear(), 0, 0);
            const diff = calendarDate - start;
            const dayOfYear = Math.floor(diff / 86400000);
            
            // ç”¨ä¾†æ”¶é›†ä»Šæ—¥é€²åº¦çš„æ–‡å­—é™£åˆ—
            let progressTexts = [];

            const container = document.getElementById('devotion-tabs');
            container.innerHTML = planTracks.map((track, idx) => {
                // ç°¡å–®çš„åˆ†ç™¼é‚è¼¯
                const totalChapters = track.books.reduce((a,b)=>a+b.c, 0);
                const chapterIdx = Math.floor((dayOfYear % totalChapters)) || 1;
                
                // æ‰¾å‡ºè©² index å°æ‡‰å“ªå·æ›¸
                let currentCount = 0, targetBook = track.books[0], targetChapter = 1;
                for(let b of track.books) {
                    if (currentCount + b.c >= chapterIdx) {
                        targetBook = b;
                        targetChapter = chapterIdx - currentCount;
                        break;
                    }
                    currentCount += b.c;
                }

                const ref = `${targetBook.abbr} ${targetChapter}`;
                progressTexts.push(ref); // æ”¶é›†é€²åº¦

                return `
                    <div class="devotion-track-card ${idx===0?'active':''}" onclick="window.fetchBibleRef('${ref}'); document.querySelectorAll('.devotion-track-card').forEach(c=>c.classList.remove('active')); this.classList.add('active');">
                        <span class="track-tag uppercase">${track.t}</span>
                        <span class="track-ref font-mono">${ref}</span>
                    </div>
                `;
            }).join('');
            
            // æ›´æ–°ã€Œä»Šæ—¥é€²åº¦ã€æ¬„ä½
            const progressField = document.getElementById('note-devotion-progress');
            if(progressField) {
                progressField.value = progressTexts.join(' / ');
            }

            // é è¨­è¼‰å…¥ç¬¬ä¸€è»Œ
            const firstRef = container.querySelector('.track-ref').innerText;
            window.fetchBibleRef(firstRef);
        }

        // æ—¥æœŸè™•ç†
        window.handleDateChange = function(val) {
            calendarDate = new Date(val);
            if(els.datePicker) els.datePicker.value = val;
            if(els.homeDatePicker) els.homeDatePicker.value = val;
            
            // éš¨æ©Ÿä»Šæ—¥å—å“ª
            const daySeed = val.split('-').reduce((a,b)=>a+parseInt(b), 0);
            const m = mannaVerses[daySeed % mannaVerses.length];
            document.getElementById('manna-text').innerText = m.t;
            document.getElementById('manna-ref').innerText = m.r;

            // è¼‰å…¥ç­†è¨˜ (æ–°å¢ note-application)
            const fields = [
                'note-rhema', 'note-reflection', 'note-application', 'note-prayer-devotion',
                'note-topic', 'note-content', 
                'note-thanks', 'note-grace', 
                'note-mood-event', 'note-mood-tags', 'note-mood-lie', 'note-mood-god-view', 'note-mood-prayer'
            ];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if(el) {
                    el.value = localStorage.getItem(`${val}-${f}`) || "";
                    el.oninput = () => {
                        localStorage.setItem(`${val}-${f}`, el.value);
                        window.renderCalendar();
                    };
                }
            });
            
            // æ›´æ–°é€²åº¦é¡¯ç¤º (å¦‚æœæ˜¯éˆä¿®æ¨¡å¼)
            if(currentMode === 'devotion') {
                window.updateDevotionUI();
            }
            
            window.renderCalendar();
        }

        window.renderCalendar = function() {
            const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
            els.calendarMonthLabel.innerText = `${y} . ${m+1}`;
            els.calendarGrid.innerHTML = "";
            const startDay = new Date(y, m, 1).getDay();
            const totalDays = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<startDay; i++) els.calendarGrid.appendChild(document.createElement('div'));
            for(let i=1; i<=totalDays; i++) {
                const d = document.createElement('div');
                const key = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                d.className = "calendar-day"; d.innerText = i;
                if (key === els.datePicker.value) d.classList.add('selected-day');
                const hasNote = ['note-rhema', 'note-content', 'note-thanks', 'note-mood-event', 'note-mood-tags'].some(field => localStorage.getItem(`${key}-${field}`));
                if (hasNote) d.classList.add('has-entry');
                d.onclick = () => window.handleDateChange(key);
                els.calendarGrid.appendChild(d);
            }
        }

        window.switchWorkspaceTab = function(t) {
            const r = document.getElementById('section-reader'), j = document.getElementById('section-journal');
            const tr = document.getElementById('tab-reader'), tj = document.getElementById('tab-journal');
            if (t === 'reader') {
                r.classList.replace('opacity-0', 'opacity-100'); r.classList.replace('z-0', 'z-10'); r.style.pointerEvents = "auto";
                j.classList.replace('opacity-100', 'opacity-0'); j.classList.replace('z-10', 'z-0'); j.style.pointerEvents = "none";
                tr.classList.add('active'); tj.classList.remove('active');
            } else {
                j.classList.replace('opacity-0', 'opacity-100'); j.classList.replace('z-0', 'z-10'); j.style.pointerEvents = "auto";
                r.classList.replace('opacity-100', 'opacity-0'); r.classList.replace('z-10', 'z-0'); r.style.pointerEvents = "none";
                tj.classList.add('active'); tr.classList.remove('active');
            }
        }

        window.renderMainBooks = function(t) {
            els.viewBooks.innerHTML = `<div class="flex gap-4 mb-6 shrink-0"><button onclick="window.renderMainBooks('old')" class="flex-1 py-3 text-sm font-bold rounded-lg border-2 border-[#C2A695] ${t==='old'?'bg-[#C2A695] text-white':'bg-white text-[#C2A695]'} transition-all">èˆŠç´„ Old Testament</button><button onclick="window.renderMainBooks('new')" class="flex-1 py-3 text-sm font-bold rounded-lg border-2 border-[#C2A695] ${t==='new'?'bg-[#C2A695] text-white':'bg-white text-[#C2A695]'} transition-all">æ–°ç´„ New Testament</button></div>` +
            `<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 content-start pb-10">` + bibleBooks[t].map(b => `<button class="px-3 py-3 text-sm border border-[#E0DBD3] rounded-lg bg-white hover:border-[#C2A695] text-left shadow-sm transition-all" onclick='window.showMainChapters(${JSON.stringify(b)})'>${b.n}</button>`).join('') + `</div>`;
        }

        window.showMainChapters = function(b) {
            els.viewBooks.classList.add('hidden');
            els.viewChapters.classList.remove('hidden');
            els.viewText.classList.add('hidden');
            
            // Header Update
            els.readerTitle.innerText = b.n;
            els.readerSubtitle.innerText = "Select Chapter";
            els.backBtn.classList.remove('hidden');
            els.copyBtn.classList.add('hidden');

            document.getElementById('main-chapter-title').innerText = b.n;
            document.getElementById('main-chapter-grid').innerHTML = Array.from({length:b.c}, (_,i)=> `
                <button class="aspect-square border border-[#E0DBD3] rounded-xl hover:bg-[#C2A695] hover:text-white transition-all flex items-center justify-center font-mono text-sm bg-white shadow-sm" onclick="window.fetchBibleRef('${b.abbr}${i+1}')">${i+1}</button>
            `).join('');
        }

        window.goBackToMainBooks = function() {
            // å¦‚æœç›®å‰æ˜¯åœ¨é–±è®€ç¶“æ–‡ (viewText)ï¼Œè¿”å›ç« ç¯€é¸æ“‡ (viewChapters)ï¼›å¦‚æœæ˜¯åœ¨ç« ç¯€é¸æ“‡ï¼Œè¿”å›æ›¸å· (viewBooks)
            if (!els.viewText.classList.contains('hidden')) {
                // å¾ç¶“æ–‡è¿”å›ç« ç¯€ (ç°¡å–®è™•ç†ï¼šç›´æ¥å›æ›¸å·åˆ—è¡¨ï¼Œå› ç‚ºç‹€æ…‹æ²’å­˜é‚£éº¼ç´°)
                // æˆ–è€…æˆ‘å€‘å¯ä»¥æª¢æŸ¥ readerTitle åˆ¤æ–·ï¼Œä½†ç‚ºäº†æµæš¢ç›´æ¥å›æ›¸å·æœ€å–®ç´”
                els.viewText.classList.add('hidden');
                els.viewChapters.classList.add('hidden');
                els.viewBooks.classList.remove('hidden');
                els.readerTitle.innerText = "Bible Reading";
                els.readerSubtitle.innerText = "Select Book";
                els.backBtn.classList.add('hidden');
                els.copyBtn.classList.add('hidden');
            } else {
                // å¾ç« ç¯€è¿”å›æ›¸å·
                els.viewChapters.classList.add('hidden');
                els.viewBooks.classList.remove('hidden');
                els.readerTitle.innerText = "Bible Reading";
                els.readerSubtitle.innerText = "Select Book";
                els.backBtn.classList.add('hidden');
            }
        }

        window.copyDevotionProgress = function() {
            const progressText = document.getElementById('note-devotion-progress').value;
            if(!progressText || progressText === "è¼‰å…¥ä¸­...") return;
            
            const t = document.createElement('textarea'); 
            t.value = progressText; 
            document.body.appendChild(t); 
            t.select(); 
            document.execCommand('copy'); 
            document.body.removeChild(t);
            
            const btn = document.getElementById('btn-copy-progress');
            const originalText = btn.innerText;
            const originalClass = btn.className;
            
            btn.innerText = "å·²è¤‡è£½!";
            btn.classList.add('bg-[#94A698]', 'text-white', 'border-transparent');
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.className = originalClass;
            }, 1500);
        }

        window.changeCalendarMonth = function(n) { calendarDate.setMonth(calendarDate.getMonth()+n); window.renderCalendar(); }
        window.goHome = function() { window.switchMode('home'); }
        window.openExportModal = function() { document.getElementById('export-modal').classList.remove('hidden'); }
        window.closeExportModal = function() { document.getElementById('export-modal').classList.add('hidden'); }
        window.selectMood = function(el, m) { document.getElementById('note-mood').value = m; document.querySelectorAll('.mood-sticker').forEach(s=>s.classList.remove('selected')); el.classList.add('selected'); }
        
        window.performSearch = function() { window.fetchBibleRef(els.inlineSearch.value); }
        window.updateCopyButton = function() {
            const count = document.querySelectorAll('.verse-item.selected').length;
            els.copyBtn.innerHTML = count > 0 ? `<span class='text-[10px] font-bold'>${count}</span>` : `<svg class="w-5 h-5 icon-sketch" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`;
        }
        
        window.copySelectedVerses = function() {
            const sel = document.querySelectorAll('.verse-item.selected');
            if (sel.length === 0) return;
            const text = Array.from(sel).map(v => v.innerText.trim()).join('\n');
            const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            els.copyBtn.innerHTML = "âœ…";
            setTimeout(() => { sel.forEach(v=>v.classList.remove('selected')); window.updateCopyButton(); }, 1000);
        }

        window.backupData = function() {
            const data = {};
            for(let i=0; i<localStorage.length; i++){
                const k = localStorage.key(i);
                if(k.includes('note-')) data[k] = localStorage.getItem(k);
            }
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `manna-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
        }

        window.restoreData = function(input) {
            const r = new FileReader();
            r.onload = e => {
                const data = JSON.parse(e.target.result);
                Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                location.reload();
            }
            r.readAsText(input.files[0]);
        }

        window.calculateStreak = function() {
            let s = 0, d = new Date();
            while(true) {
                const k = d.toISOString().split('T')[0];
                if (localStorage.getItem(`${k}-note-rhema`) || localStorage.getItem(`${k}-note-content`)) {
                    s++; d.setDate(d.getDate()-1);
                } else break;
            }
            els.streakCount.innerText = s;
            els.streakBadge.classList.toggle('hidden', s === 0);
            els.streakBadge.classList.add('inline-flex');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
