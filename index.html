<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» | Smart Manna Life</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SQLite Support (sql.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- Google Fonts -->
    <style>
        /* ä¿æŒ Noto Sans TC é¿å…ç¼ºå­—ï¼Œä¿ç•™ VT323 è£é£¾ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=VT323&display=swap');
        
        :root {
            /* æ¨‚é«˜ç©æœ¨é…è‰² (Lego Palette) */
            --lego-red: #E3000B;
            --lego-red-dark: #bf0009;
            --lego-blue: #0055BF;
            --lego-blue-dark: #004296;
            --lego-yellow: #FFD500;
            --lego-yellow-dark: #ccaa00;
            --lego-green: #008F39;
            --lego-green-dark: #006b2b;
            --lego-white: #FFFFFF;
            --lego-grey: #A0A5A9;
            --lego-dark-grey: #6D6E71;
            
            --bg-baseplate: #F4F6F8; /* æ·ºç°åº•æ¿è‰² */
            --stud-shadow: rgba(0,0,0,0.1);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-baseplate);
            color: #333;
            -webkit-tap-highlight-color: transparent;
            /* ä¿®æ”¹ï¼šèƒŒæ™¯åœ“é»è®Šå°è®Šå¯† (æ¨¡æ“¬ 7 stud å¯¬åº¦æ„Ÿ) */
            background-image: 
                radial-gradient(var(--stud-shadow) 20%, transparent 22%),
                radial-gradient(var(--stud-shadow) 20%, transparent 22%);
            background-size: 20px 20px; /* ç¸®å°å°ºå¯¸ */
            background-position: 0 0, 10px 10px;
        }
        
        .pixel-font { font-family: 'VT323', monospace; }
        
        /* ç©æœ¨å¡ç‰‡ (Brick Card) */
        .brick-card {
            background: var(--lego-white);
            border-radius: 8px; /* ç¨å¾®åœ“è§’ï¼Œåƒç¾ä»£æ¨‚é«˜ç£š */
            border: 2px solid rgba(0,0,0,0.05);
            /* ç©æœ¨çš„ç«‹é«”æ„Ÿï¼šåº•éƒ¨åšåº¦é™°å½± */
            box-shadow: 0 6px 0 #E0E0E0, 0 12px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
        }
        /* é ‚éƒ¨è£é£¾æ¢ï¼šæ¨¡æ“¬ç©æœ¨å´é¢ */
        .brick-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: rgba(0,0,0,0.05);
        }

        /* é€šç”¨ç©æœ¨æŒ‰éˆ• */
        .brick-btn {
            background-color: var(--lego-white);
            color: #333;
            font-weight: 900;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            position: relative;
            /* å¯¦é«”æŒ‰éˆ•æ•ˆæœ */
            box-shadow: 0 5px 0 #ccc; 
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .brick-btn:active, .brick-btn.active {
            transform: translateY(5px); /* å£“ä¸‹å» */
            box-shadow: 0 0 0 #ccc; /* é™°å½±æ¶ˆå¤± */
        }
        
        /* é¡è‰²è®Šé«” */
        .btn-yellow { background-color: var(--lego-yellow); color: #333; box-shadow: 0 5px 0 var(--lego-yellow-dark); }
        .btn-yellow:active { box-shadow: 0 0 0 var(--lego-yellow-dark); }
        
        .btn-blue { background-color: var(--lego-blue); color: white; box-shadow: 0 5px 0 var(--lego-blue-dark); }
        .btn-blue:active { box-shadow: 0 0 0 var(--lego-blue-dark); }
        
        .btn-red { background-color: var(--lego-red); color: white; box-shadow: 0 5px 0 var(--lego-red-dark); }
        .btn-red:active { box-shadow: 0 0 0 var(--lego-red-dark); }
        
        .btn-green { background-color: var(--lego-green); color: white; box-shadow: 0 5px 0 var(--lego-green-dark); }
        .btn-green:active { box-shadow: 0 0 0 var(--lego-green-dark); }

        /* çœŸå¯¦ç©æœ¨é¢¨æ ¼æŒ‰éˆ• (ç”¨æ–¼æ·å¾‘) */
        .real-brick-btn {
            position: relative;
            border-radius: 4px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: transform 0.1s;
            overflow: hidden;
        }
        /* è¡¨é¢å‡¸ç²’ç´‹ç† */
        .real-brick-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(0,0,0,0.2) 20%, transparent 22%);
            background-size: 16px 16px; /* å‡¸ç²’å¤§å° */
            background-position: 8px 8px;
            opacity: 0.5;
            pointer-events: none;
        }
        /* é ‚éƒ¨åå…‰æ•ˆæœ */
        .real-brick-btn::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3) 0%, transparent 40%);
            pointer-events: none;
        }
        .real-brick-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 transparent !important;
        }

        /* æ·å¾‘ç©æœ¨é¡è‰²å®šç¾© */
        .brick-bible {
            background-color: var(--lego-blue);
            color: white;
            box-shadow: 0 8px 0 var(--lego-blue-dark), 0 15px 15px rgba(0,0,0,0.2);
        }
        .brick-prayer {
            background-color: var(--lego-green);
            color: white;
            box-shadow: 0 8px 0 var(--lego-green-dark), 0 15px 15px rgba(0,0,0,0.2);
        }
        .brick-gratitude {
            background-color: var(--lego-yellow);
            color: #333;
            box-shadow: 0 8px 0 var(--lego-yellow-dark), 0 15px 15px rgba(0,0,0,0.2);
        }
        .brick-mood {
            background-color: var(--lego-red);
            color: white;
            box-shadow: 0 8px 0 var(--lego-red-dark), 0 15px 15px rgba(0,0,0,0.2);
        }

        /* æ–°å¢ï¼šå°å‹ç©æœ¨ç´‹ç† (ç”¨æ–¼åœ–ç¤º) */
        .mini-brick {
            position: relative;
            overflow: hidden;
        }
        .mini-brick::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* 3x3 å‡¸ç²’ (æ›´å¯†é›†) */
            background-image: radial-gradient(rgba(0,0,0,0.15) 25%, transparent 28%);
            background-size: 13.33px 13.33px; 
            background-position: 0 0;
        }
        .mini-brick::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.4) 0%, transparent 50%);
            pointer-events: none;
        }

        /* ç¶“æ–‡æ¨£å¼ */
        .bible-text {
            line-height: 2.2;
            font-size: 1.15rem;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* ç¶“æ–‡é¸å– - ç©æœ¨å †ç–Šæ„Ÿ */
        .verse-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 6px;
            border: 2px solid transparent;
            background: #FAFAFA;
            transition: all 0.1s;
        }
        .verse-item:hover {
            border-color: var(--lego-yellow);
            background: #fff;
        }
        .verse-item.selected {
            background-color: var(--lego-yellow);
            color: #333;
            border-bottom: 4px solid var(--lego-yellow-dark);
            transform: translateY(-2px);
            font-weight: 700;
        }

        /* éš±è—å·è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--lego-grey); border-radius: 6px; border: 3px solid #f1f1f1; }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* é–±è®€é€²åº¦æ¢ - ç©æœ¨æ¢ */
        .devotion-track-card {
            background: white;
            border-radius: 6px;
            cursor: pointer;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            border-bottom: 4px solid #ddd;
        }
        .devotion-track-card:hover { transform: translateY(-2px); border-bottom-width: 6px; }
        .devotion-track-card.active {
            background: var(--lego-blue);
            color: white;
            border-bottom-color: var(--lego-blue-dark);
            transform: translateY(1px);
            border-bottom-width: 2px;
        }
        .devotion-track-card.active .track-tag { color: rgba(255,255,255,0.9); }

        .track-tag { font-size: 12px; font-weight: 700; color: #888; margin-bottom: 2px; }
        .track-ref { font-size: 14px; font-weight: 700; font-family: 'VT323', monospace; letter-spacing: 1px;}

        /* åˆ†é æŒ‰éˆ• - ç©æœ¨æ¥åˆè™• */
        .workspace-tab-btn {
            flex: 1; text-align: center; padding: 12px 10px; font-size: 16px; font-weight: 700; 
            color: #888; border-radius: 8px 8px 0 0;
            transition: all 0.1s;
            position: relative;
            background: #eee;
            margin-right: 4px;
        }
        .workspace-tab-btn.active { 
            background-color: var(--lego-white);
            color: var(--lego-blue); 
            box-shadow: 0 -3px 0 var(--lego-blue) inset; /* é ‚éƒ¨äº®æ¢ */
            z-index: 10;
            margin-bottom: -2px; /* é€£æ¥ä¸‹æ–¹ */
            padding-bottom: 14px;
        }

        /* å¿ƒæƒ…è²¼ç´™ - åœ“å½¢ç©æœ¨ (Round Plate 1x1) */
        .mood-sticker {
            font-size: 1.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; transition: all 0.1s; background-color: #fff; 
            border-bottom: 4px solid #ddd;
        }
        .mood-sticker:active, .mood-sticker.selected { 
            transform: translateY(3px);
            border-bottom-width: 0;
            background-color: var(--lego-yellow);
        }

        /* æœˆæ›†æ¨£å¼ - åƒ 1x1 æ‹¼è²¼ç£š */
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px;
            font-size: 1rem; cursor: pointer; transition: all 0.1s; position: relative; font-weight: 700;
            background: #fff;
            border-bottom: 3px solid #ddd;
            font-family: 'VT323', monospace; font-size: 1.4rem;
        }
        .calendar-day:active { transform: translateY(3px); border-bottom: 0; }
        .calendar-day.has-entry::after {
            content: ''; position: absolute; bottom: 4px; width: 6px; height: 6px; background: var(--lego-green); 
            border-radius: 50%;
        }
        .calendar-day.selected-day { 
            background-color: var(--lego-blue) !important; 
            color: white !important; 
            border-bottom-color: var(--lego-blue-dark);
        }
        .calendar-day.today { 
            border: 2px dashed var(--lego-red); 
            color: var(--lego-red); 
            border-bottom: 2px dashed var(--lego-red); /* Reset shadow style */
        }

        .loader {
            width: 40px; height: 40px; 
            background-color: var(--lego-yellow);
            box-shadow: 0 4px 0 var(--lego-yellow-dark);
            border-radius: 4px;
            animation: bounce 0.6s infinite alternate;
        }
        @keyframes bounce { 
            from { transform: translateY(0); } 
            to { transform: translateY(-10px); } 
        }

        /* è¼¸å…¥æ¡† - å‡¹é™·å€å¡Š */
        textarea, input[type="text"], input[type="date"] {
            background-color: #FAFAFA;
            border: 2px solid #ddd;
            border-top: 4px solid #ccc; /* é ‚éƒ¨é™°å½±åŠ æ·±ï¼Œè£½é€ å‡¹é™·æ„Ÿ */
            border-radius: 6px;
            font-family: 'Noto Sans TC', sans-serif;
            transition: all 0.2s;
        }
        textarea:focus, input:focus {
            outline: none;
            background-color: white;
            border-color: var(--lego-blue);
            border-top-color: var(--lego-blue);
        }
        
        /* æ¨™ç±¤ Badge */
        .badge {
            background: var(--lego-red);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 0 var(--lego-red-dark);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-[#FFD500] selection:text-black">

    <!-- é ‚éƒ¨å°è¦½åˆ—ï¼šåƒä¸€æ¢é•·ç©æœ¨ -->
    <header id="main-header" class="bg-white/95 backdrop-blur-none border-b-4 border-[#eee] sticky top-0 z-30 shrink-0 hidden">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="window.goHome()">
                <!-- Game Icon: Yellow Brick -->
                <div class="w-10 h-10 bg-[#FFD500] rounded flex items-center justify-center shadow-[0_4px_0_#ccaa00] active:shadow-none active:translate-y-1 transition-all mini-brick border border-yellow-400">
                     <svg class="w-6 h-6 text-[#333] relative z-10" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2.5">
                        <path d="M4 14C4 14 4 7 12 7C20 7 20 14 20 14V18C20 19.1 19.1 20 18 20H6C4.9 20 4 19.1 4 18V14Z"></path>
                        <path d="M4 14H20"></path>
                        <path d="M9 11C9 11 9.5 10 10.5 10C11.5 10 12 11 12 11"></path>
                        <path d="M13 11C13 11 13.5 10 14.5 10C15.5 10 16 11 16 11"></path>
                    </svg>
                </div>
                <h1 class="hidden sm:block text-lg font-bold tracking-wider text-[#333]">æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´»</h1>
            </div>
            
            <div id="header-title" class="flex-1 text-center pixel-font text-2xl text-[#333] font-bold tracking-widest uppercase truncate">HOME</div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.openExportModal()" class="brick-btn p-2 hover:bg-gray-50">
                    <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                </button>
                <input type="date" id="date-picker" class="border-2 border-[#ddd] rounded px-2 py-1 text-sm font-bold outline-none text-[#333] cursor-pointer" onchange="window.handleDateChange(this.value)">
            </div>
        </div>
    </header>

    <!-- 1. é¦–é è¦–åœ– -->
    <div id="view-home" class="flex-1 overflow-y-auto p-4 md:p-8 w-full max-w-5xl mx-auto flex flex-col">
        
        <div class="flex justify-between items-end mb-10 fade-in pt-4">
            <div class="flex flex-col gap-2">
                <span class="inline-block px-2 py-1 bg-[#333] text-[#FFD500] text-xs font-bold tracking-widest uppercase pixel-font transform -rotate-2 rounded shadow-sm">Smart Manna Life</span>
                <h1 class="text-3xl md:text-5xl font-black text-[#333] leading-tight flex items-center gap-3 drop-shadow-sm">
                    æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» 
                    <div class="w-10 h-10 bg-[#E3000B] rounded flex items-center justify-center relative top-1 shadow-[0_4px_0_#bf0009] mini-brick border border-red-600">
                        <svg class="w-6 h-6 text-white relative z-10" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2.5">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                        </svg>
                    </div>
                </h1>
            </div>
            <div class="hidden sm:block">
                <input type="date" id="home-date-picker" class="bg-white border-2 border-[#ddd] rounded px-4 py-2 text-sm font-bold outline-none shadow-[0_4px_0_#ccc] active:shadow-none active:translate-y-1 transition-all text-[#333]" onchange="window.handleDateChange(this.value)">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 fade-in">
            <!-- ä»Šæ—¥å—å“ªå¡ç‰‡ -->
            <div class="md:col-span-1 flex flex-col brick-card p-6 relative group cursor-pointer" onclick="window.switchMode('devotion')">
                <!-- è£é£¾ç”¨åœ–æ¡ˆ -->
                <div class="absolute top-4 right-4 p-2 opacity-10 rotate-12">
                    <svg class="w-20 h-20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2zm0 3.8L18.4 19H5.6L12 5.8z"/></svg>
                </div>
                
                <div class="inline-block px-3 py-1 bg-[#0055BF] text-white text-sm font-bold mb-6 self-start rounded shadow-[0_3px_0_#004296]">Today's Build</div>
                
                <div id="home-manna-display" class="z-10 flex-1 flex flex-col justify-center">
                    <p class="text-2xl font-bold text-[#333] leading-relaxed mb-6 not-italic" id="manna-text">Loading...</p>
                    <p class="text-sm font-bold bg-[#333] text-white px-2 py-1 w-fit self-end pixel-font tracking-wider rounded" id="manna-ref"></p>
                </div>

                <!-- è¡Œå‹•å‘¼ç±²å€åŸŸ -->
                <div class="flex items-center justify-between mt-8 pt-5 border-t-2 border-dashed border-gray-200 z-10">
                     <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-[#FFD500] rounded flex items-center justify-center text-[#333] shadow-[0_3px_0_#ccaa00]">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2.5">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider leading-tight">START BUILDING</span>
                            <span class="text-base text-[#333] font-bold tracking-widest">é–‹å§‹éˆä¿®</span>
                        </div>
                     </div>
                     <span class="text-2xl text-[#E3000B] font-black group-hover:translate-x-2 transition-transform">â†’</span>
                </div>
            </div>

            <!-- éˆä¿®è¶³è·¡æœˆæ›† -->
            <div class="md:col-span-2 brick-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-[#333] flex items-center gap-2 text-xl">
                        ç”Ÿå‘½è¶³è·¡ <span id="streak-badge" class="hidden items-center px-3 py-1 bg-[#FFD500] text-[#333] text-xs ml-2 rounded shadow-[0_2px_0_#ccaa00]">ğŸ”¥ <span id="streak-count" class="mx-1 font-mono text-lg">0</span> Days</span>
                    </h3>
                    <div class="flex items-center gap-3">
                        <button onclick="window.changeCalendarMonth(-1)" class="w-8 h-8 flex items-center justify-center brick-btn p-0">â—€</button>
                        <div class="text-xl font-bold w-24 text-center text-[#333] pixel-font" id="calendar-month-label"></div>
                        <button onclick="window.changeCalendarMonth(1)" class="w-8 h-8 flex items-center justify-center brick-btn p-0">â–¶</button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-400 mb-3 font-bold uppercase tracking-widest pixel-font">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>
        </div>

        <!-- æ·å¾‘å€åŸŸ (ç©æœ¨é¢¨æ ¼) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-10 fade-in">
            <!-- è—è‰²ç©æœ¨ï¼šè–ç¶“é–±è®€ -->
            <div onclick="window.switchMode('bible')" class="real-brick-btn brick-bible cursor-pointer group h-auto">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">è–ç¶“é–±è®€</h3>
            </div>
            
            <!-- ç¶ è‰²ç©æœ¨ï¼šè·Ÿç¥èŠèŠ -->
            <div onclick="window.switchMode('journal-prayer')" class="real-brick-btn brick-prayer cursor-pointer group h-auto">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">è·Ÿç¥èŠèŠ</h3>
            </div>
            
            <!-- é»ƒè‰²ç©æœ¨ï¼šæ„Ÿæ©æ—¥è¨˜ -->
            <div onclick="window.switchMode('journal-gratitude')" class="real-brick-btn brick-gratitude cursor-pointer group h-auto">
                <svg class="w-10 h-10 text-[#333] opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <h3 class="text-base font-bold text-[#333] tracking-widest mt-auto">æ„Ÿæ©æ—¥è¨˜</h3>
            </div>
            
            <!-- ç´…è‰²ç©æœ¨ï¼šå…§å¿ƒæˆ² -->
            <div onclick="window.switchMode('journal-mood')" class="real-brick-btn brick-mood cursor-pointer group h-auto">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">å…§å¿ƒæˆ²</h3>
            </div>
        </div>

        <footer class="mt-auto py-10 text-center fade-in border-t-4 border-[#ddd] w-11/12 md:w-2/3 mx-auto">
            <div class="flex justify-center flex-wrap gap-5 md:gap-6 mb-4">
                <a href="https://www.facebook.com/profile.php?id=100068500932557" target="_blank" class="text-gray-400 hover:text-[#1877F2] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
                <a href="https://www.instagram.com/forever.believe.in.jesus/" target="_blank" class="text-gray-400 hover:text-[#E4405F] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
                <a href="https://www.threads.net/@forever.believe.in.jesus" target="_blank" class="text-gray-400 hover:text-black transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M12.27 4.15c-4.46 0-7.85 3.32-7.85 7.85 0 4.54 3.39 7.85 7.85 7.85 2.5 0 4.67-1.16 6.04-2.81l-1.92-1.46c-1 1.15-2.52 1.83-4.12 1.83-2.91 0-5.32-2.31-5.32-5.41s2.41-5.41 5.32-5.41c2.46 0 4.8 1.63 5.24 4.09l.06.35c.19 1.09.08 1.95-.31 2.34-.18.18-.45.26-.81.26-.58 0-1.17-.26-1.54-1.12l-.12-.27c-.49-1.15-.74-2.42-.74-3.69v-.39h-2.52v.4c0 1.57.34 3.09.98 4.49-.9 1.02-2.22 1.69-3.7 1.69-2.7 0-4.9-2.2-4.9-4.9 0-2.7 2.2-4.9 4.9-4.9 2.59 0 4.86 1.98 5.16 4.53.13 1.14.07 2.01-.17 2.65-.54 1.43-1.69 1.98-2.98 1.98-1.25 0-2.2-.69-2.61-1.91-.45-.87-.45-1.95-.45-2.07 0-.58.11-1.14.32-1.67.58-1.45 2.03-2.46 3.69-2.46z"/></svg></a>
                <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" class="text-gray-400 hover:text-[#00C300] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></a>
                <a href="mailto:newthingsinthelittlelight@gmail.com" class="text-gray-400 hover:text-[#E3000B] transition-colors p-2 hover:scale-110 transform duration-200"><svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
            </div>
            <p class="text-xs text-gray-400 font-bold tracking-widest uppercase pixel-font text-lg">è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹ Â© 2024</p>
        </footer>
    </div>

    <!-- 2. å·¥ä½œå€è¦–åœ– -->
    <main id="view-workspace" class="hidden flex-1 w-full max-w-7xl mx-auto flex flex-col h-full overflow-hidden bg-transparent">
        
        <!-- å…¨åŸŸåˆ†é åˆ‡æ› -->
        <div id="workspace-tabs" class="flex border-b-4 border-[#ccc] shrink-0 bg-[#F4F6F8] z-20 px-4 pt-2 gap-1">
            <button id="tab-reader" class="workspace-tab-btn active" onclick="window.switchWorkspaceTab('reader')">
                <span class="text-xl mr-1 pixel-font">Read</span> <span id="tab-reader-text">é–±è®€ç¶“æ–‡</span>
            </button>
            <button id="tab-journal" class="workspace-tab-btn" onclick="window.switchWorkspaceTab('journal')">
                <span class="text-xl mr-1 pixel-font">Write</span> <span id="tab-journal-text">éˆä¿®ç­†è¨˜</span>
            </button>
        </div>

        <!-- é›™æ¬„å…§å®¹å®¹å™¨ -->
        <div class="flex-1 flex overflow-hidden relative p-0 md:p-4 gap-4">
            
            <!-- é–±è®€å™¨å€å¡Š (Left) -->
            <section id="section-reader" class="w-full lg:w-1/2 flex flex-col brick-card rounded-none md:rounded-lg transition-all duration-300 absolute lg:relative inset-0 z-10 lg:z-auto shadow-none md:shadow-[0_6px_0_#E0E0E0,0_12px_10px_rgba(0,0,0,0.1)]">
                
                <!-- A. Devotion Tabs (Sticky top) -->
                <div id="devotion-tabs" class="hidden grid grid-cols-4 gap-2 p-4 bg-[#F9F9F9] border-b-2 border-gray-100 shrink-0"></div>
                
                <!-- B. Universal Header -->
                <div id="reader-universal-header" class="px-5 py-4 border-b-2 border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <!-- Left: Nav/Title -->
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                         <!-- Back Button -->
                         <button id="btn-header-back" onclick="window.goBackToMainBooks()" class="hidden shrink-0 w-8 h-8 rounded bg-[#333] text-white flex items-center justify-center text-xs hover:bg-black transition-colors shadow-[0_3px_0_#000] active:shadow-none active:translate-y-1">â—€</button>
                         
                         <!-- Title Info -->
                         <div class="min-w-0">
                             <div class="flex items-center gap-2">
                                <span id="header-subtitle" class="text-[12px] font-bold text-gray-400 uppercase tracking-widest block pixel-font">Scripture</span>
                                <!-- Copy Progress Button -->
                                <button id="btn-copy-progress" onclick="window.copyDevotionProgress()" class="hidden text-[10px] bg-[#333] text-white rounded px-2 py-0.5 hover:bg-black transition-colors leading-tight tracking-wider" title="è¤‡è£½ä»Šæ—¥é€²åº¦">
                                    è¤‡è£½é€²åº¦
                                </button>
                             </div>
                             <h2 id="header-main-title" class="text-lg text-[#333] font-bold truncate">Bible Reading</h2>
                         </div>
                    </div>
                    <!-- Right: Actions -->
                    <div class="flex items-center gap-2">
                         <!-- Search -->
                         <div class="relative" id="search-box">
                             <input type="text" id="inline-search" placeholder="Search..." class="pl-3 pr-8 py-1.5 rounded bg-gray-50 text-xs w-28 focus:w-48 transition-all outline-none border-2 border-gray-200 focus:border-[#0055BF]" onkeyup="if(event.key==='Enter') window.performSearch()">
                             <button onclick="window.performSearch()" class="absolute right-2 top-2 text-gray-400"><svg class="w-4 h-4" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                         </div>
                         <!-- Copy -->
                         <button id="btn-copy-verses" onclick="window.copySelectedVerses()" class="hidden w-9 h-9 flex items-center justify-center rounded bg-[#FFD500] text-[#333] border-none shadow-[0_3px_0_#ccaa00] active:shadow-none active:translate-y-1 transition-all">
                            <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                         </button>
                    </div>
                </div>

                <!-- C. Scrollable Content Wrapper -->
                <div id="reader-content-wrapper" class="flex-1 overflow-y-auto relative bg-white">
                    
                    <!-- 1. Books View -->
                    <div id="view-bible-books" class="hidden flex-col min-h-full p-6">
                         <div class="flex gap-4 mb-6 shrink-0">
                            <button onclick="window.renderMainBooks('old')" id="btn-old" class="brick-btn btn-yellow flex-1 py-3 text-sm">èˆŠç´„ Old Testament</button>
                            <button onclick="window.renderMainBooks('new')" id="btn-new" class="brick-btn flex-1 py-3 text-sm border-2 border-gray-100">æ–°ç´„ New Testament</button>
                        </div>
                        <div id="main-book-list" class="grid grid-cols-2 sm:grid-cols-4 gap-3 content-start pb-10"></div>
                    </div>

                    <!-- 2. Chapters View -->
                    <div id="view-bible-chapters" class="hidden flex-col min-h-full p-6">
                        <h3 id="main-chapter-title" class="text-3xl font-bold text-[#333] mb-8 border-b-4 border-[#FFD500] w-fit pb-1 px-2"></h3>
                        <div id="main-chapter-grid" class="grid grid-cols-5 sm:grid-cols-6 gap-3 pb-10"></div>
                    </div>

                    <!-- 3. Text View -->
                    <div id="view-bible-text" class="hidden min-h-full p-6 md:p-10 bible-text text-gray-800"></div>
                </div>
            </section>

            <!-- ç­†è¨˜å€å¡Š (Right) -->
            <section id="section-journal" class="w-full lg:w-1/2 flex flex-col brick-card rounded-none md:rounded-lg transition-all duration-300 absolute lg:relative inset-0 opacity-0 lg:opacity-100 pointer-events-none lg:pointer-events-auto z-0 lg:z-auto shadow-none md:shadow-[0_6px_0_#E0E0E0,0_12px_10px_rgba(0,0,0,0.1)]">
                <div class="bg-gray-50 px-6 py-4 border-b-2 border-gray-100 flex gap-3 overflow-x-auto no-scrollbar items-center shrink-0">
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜€ï¸')">â˜€ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜ï¸')">â˜ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ§ï¸')">ğŸŒ§ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸ”¥')">ğŸ”¥</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ±')">ğŸŒ±</button>
                    <input type="hidden" id="note-mood">
                </div>
                <div class="flex-1 overflow-y-auto p-8 space-y-10 pb-20">
                    <!-- éˆä¿®ç­†è¨˜ (Devotion) -->
                    <div id="journal-devotion-fields" class="space-y-8">
                        <!-- è‡ªå‹•æŠ“å–ä»Šæ—¥é€²åº¦ -->
                        <div>
                            <label class="block text-sm font-bold text-[#333] mb-2 uppercase tracking-widest pixel-font bg-[#FFD500] w-fit px-2 rounded shadow-sm">ğŸ“– Reading</label>
                            <input type="text" id="note-devotion-progress" readonly class="w-full p-3 text-sm text-[#333] font-bold" value="Loading...">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#0055BF] w-fit px-2 rounded shadow-sm">âœ¨ Rhema</label>
                            <textarea id="note-rhema" placeholder="è¨˜ä¸‹ä»Šå¤©æœ€è§¸å‹•ä½ çš„ç¶“æ–‡..." class="w-full min-h-[80px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#008F39] w-fit px-2 rounded shadow-sm">ğŸ“ Reflection</label>
                            <textarea id="note-reflection" placeholder="ä½ çš„çœ‹è¦‹ã€é«”æœƒï¼Œæˆ–æ˜¯å¤©çˆ¶å°ä½ èªªçš„è©±..." class="w-full min-h-[150px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        
                        <!-- æ–°å¢ï¼šç”Ÿæ´»æ‡‰ç”¨ -->
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#6D6E71] w-fit px-2 rounded shadow-sm">ğŸŒ± Action</label>
                            <textarea id="note-application" placeholder="å…·é«”å¯ä»¥è¡Œå‡ºä¾†çš„å°ç·´ç¿’..." class="w-full min-h-[80px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#E3000B] w-fit px-2 rounded shadow-sm">ğŸ’Œ Response</label>
                            <textarea id="note-prayer-devotion" placeholder="å¯«çµ¦ç¥çš„å›ä¿¡..." class="w-full min-h-[100px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>
                    
                    <!-- è·Ÿç¥èŠèŠ (Prayer) -->
                    <div id="journal-prayer-fields" class="space-y-8 hidden">
                        <div>
                            <label class="block text-sm font-bold text-[#333] mb-2 uppercase tracking-widest pixel-font bg-[#FFD500] w-fit px-2 rounded shadow-sm">ğŸ¯ Wish</label>
                            <textarea id="note-topic" placeholder="æƒ³è¦ä»€éº¼ï¼Ÿå¤§è†½è·Ÿç¥æ±‚..." class="w-full min-h-[60px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#0055BF] w-fit px-2 rounded shadow-sm">ğŸ’¬ Murmur</label>
                            <textarea id="note-content" placeholder="æŠŠå¿ƒè£¡è©±éƒ½å€’å‡ºä¾†å§..." class="w-full min-h-[200px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>

                    <!-- æ„Ÿæ©æ—¥è¨˜ (Gratitude) -->
                    <div id="journal-gratitude-fields" class="space-y-8 hidden">
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#E3000B] w-fit px-2 rounded shadow-sm">ğŸ’– Gratitude</label>
                            <textarea id="note-thanks" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å¥½äº‹ï¼Ÿ..." class="w-full min-h-[120px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#008F39] w-fit px-2 rounded shadow-sm">âœ¨ Grace</label>
                            <textarea id="note-grace" placeholder="å“ªè£¡çœ‹è¦‹ç¥çš„ä½œç‚ºï¼Ÿ..." class="w-full min-h-[120px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>

                    <!-- å…§å¿ƒæˆ² (Mood) -->
                    <div id="journal-mood-fields" class="space-y-8 hidden">
                        <div class="p-5 bg-[#FAFAFA] rounded-lg border-2 border-gray-200 border-t-4 border-gray-300">
                            <label class="block text-base font-bold text-[#333] mb-3 uppercase pixel-font">ğŸ¬ Event / ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ</label>
                            <textarea id="note-mood-event" placeholder="è¨˜éŒ„äº‹ä»¶èˆ‡æ„Ÿå—..." class="w-full bg-white border-2 border-[#ddd] rounded p-4 text-base outline-none resize-none h-28 focus:border-[#FFD500] leading-relaxed shadow-none"></textarea>
                        </div>

                        <!-- æƒ…ç·’æ¨™è¨»å€å¡Š -->
                        <div>
                            <label class="block text-lg font-bold text-[#333] mb-2 pixel-font">ğŸ·ï¸ Emotions</label>
                            <textarea id="note-mood-tags" placeholder="æŠŠæ‰€æœ‰èƒ½æ„Ÿå—åˆ°çš„æƒ…ç·’å¾æœ€å¼·åˆ—çš„æƒ…ç·’é–‹å§‹ä¸€å€‹ä¸€å€‹å¯«ä¸‹ä¾†..." class="w-full min-h-[60px] resize-none p-3 text-lg"></textarea>
                        </div>

                        <div class="grid grid-cols-1 gap-8">
                            <div>
                                <label class="block text-lg font-bold text-white mb-2 pixel-font bg-[#333] w-fit px-2 rounded">ğŸ¤¥ Lie</label>
                                <textarea id="note-mood-lie" placeholder="æˆ‘èªç‚ºé€™ä»¶äº‹æ˜¯å› ç‚ºä»€éº¼..." class="w-full min-h-[50px] resize-none p-3 text-lg"></textarea>
                            </div>
                            <div>
                                <label class="block text-lg font-bold text-[#333] mb-2 pixel-font bg-[#FFD500] w-fit px-2 rounded border border-[#ccaa00]">ğŸ‘“ Truth</label>
                                <textarea id="note-mood-god-view" placeholder="åœ¨ç¦±å‘Šä¸­é ˜å—ç¥çš„çœ¼å…‰..." class="w-full min-h-[50px] resize-none p-3 text-lg"></textarea>
                            </div>
                        </div>

                        <!-- ç¦±å‘Šå€å¡Š -->
                        <div>
                            <label class="block text-lg font-bold text-white mb-2 pixel-font bg-[#0055BF] w-fit px-2 rounded">ğŸ™ Prayer</label>
                            <textarea id="note-mood-prayer" placeholder="æœ€å¾Œçš„äº¤è¨—èˆ‡é ˜å—..." class="w-full min-h-[100px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                    </div>

                    <!-- åº•éƒ¨å„²å­˜æç¤º -->
                    <div class="pt-8">
                        <button onclick="window.backupData()" class="brick-btn btn-green w-full flex items-center justify-center gap-3 group">
                            <span class="group-hover:scale-110 transition-transform">ğŸ’¾</span> 
                            <span>SAVE GAME (Backup)</span>
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal -->
    <div id="export-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm hidden" onclick="if(event.target===this)window.closeExportModal()">
        <div class="bg-white w-full max-w-sm p-8 rounded-lg shadow-[0_12px_0_#ccc] m-4 border-2 border-gray-200" onclick="event.stopPropagation()">
            <h3 class="text-3xl font-bold mb-3 text-[#333] text-center pixel-font">DATA CENTER</h3>
            <p class="text-sm text-gray-500 mb-8 text-center font-bold">ç­†è¨˜å„²å­˜åœ¨ç€è¦½å™¨ä¸­ï¼Œè¨˜å¾—å®šæœŸå­˜æª”ï¼</p>
            <div class="grid grid-cols-1 gap-4">
                 <button onclick="window.backupData()" class="brick-btn btn-yellow w-full flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    ä¸‹è¼‰å­˜æª” (.json)
                 </button>
                 <button onclick="document.getElementById('restore-input').click()" class="brick-btn w-full flex items-center justify-center gap-3 border-2 border-gray-100">
                    <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                    è®€å–å­˜æª”
                 </button>
                 <input type="file" id="restore-input" class="hidden" accept=".json" onchange="window.restoreData(this)">
            </div>
            <button onclick="window.closeExportModal()" class="mt-8 text-xs text-[#333] font-bold w-full text-center hover:underline uppercase tracking-widest pixel-font">Close Window</button>
        </div>
    </div>

    <script>
        // --- è¨­å®š ---
        const REMOTE_DB_URL = "https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db";
        let sqlDb = null, sqlDbLoaded = false, SQL = null, els = {};
        let dbTable = "verses";
        let dbCols = { book: "book", chapter: "chapter", verse: "verse", text: "text" };
        let currentMode = 'home';
        let calendarDate = new Date();
        let currentDailyPlan = []; 

        const mannaVerses = [
            { t: "ã€Œæ•¬ç•è€¶å’Œè¯æ˜¯æ™ºæ…§çš„é–‹ç«¯ã€‚ã€", r: "â€” ç®´è¨€ 9:10" },
            { t: "ã€Œè€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚ã€", r: "â€” è©©ç¯‡ 23:1" },
            { t: "ã€Œå–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥ï¼›æ†‚å‚·çš„éˆä½¿éª¨æ¯ä¹¾ã€‚ã€", r: "â€” ç®´è¨€ 17:22" },
            { t: "ã€Œæˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚ã€", r: "â€” è…“ç«‹æ¯”æ›¸ 4:13" },
            { t: "ã€Œå‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚ã€", r: "â€” é¦¬å¤ªç¦éŸ³ 11:28" }
        ];

        const bibleBooks = {
            old: [{n:"å‰µä¸–è¨˜",abbr:"å‰µ",c:50},{n:"å‡ºåŸƒåŠè¨˜",abbr:"å‡º",c:40},{n:"åˆ©æœªè¨˜",abbr:"åˆ©",c:27},{n:"æ°‘æ•¸è¨˜",abbr:"æ°‘",c:36},{n:"ç”³å‘½è¨˜",abbr:"ç”³",c:34},{n:"ç´„æ›¸äºè¨˜",abbr:"æ›¸",c:24},{n:"å£«å¸«è¨˜",abbr:"å£«",c:21},{n:"è·¯å¾—è¨˜",abbr:"å¾—",c:4},{n:"æ’’æ¯è€³è¨˜ä¸Š",abbr:"æ’’ä¸Š",c:31},{n:"æ’’æ¯è€³è¨˜ä¸‹",abbr:"æ’’ä¸‹",c:24},{n:"åˆ—ç‹ç´€ä¸Š",abbr:"ç‹ä¸Š",c:22},{n:"åˆ—ç‹ç´€ä¸‹",abbr:"ç‹ä¸‹",c:25},{n:"æ­·ä»£å¿—ä¸Š",abbr:"ä»£ä¸Š",c:29},{n:"æ­·ä»£å¿—ä¸‹",abbr:"ä»£ä¸‹",c:36},{n:"ä»¥æ–¯æ‹‰è¨˜",abbr:"æ‹‰",c:10},{n:"å°¼å¸Œç±³è¨˜",abbr:"å°¼",c:13},{n:"ä»¥æ–¯å¸–è¨˜",abbr:"æ–¯",c:10},{n:"ç´„ä¼¯è¨˜",abbr:"ä¼¯",c:42},{n:"è©©ç¯‡",abbr:"è©©",c:150},{n:"ç®´è¨€",abbr:"ç®´",c:31},{n:"å‚³é“æ›¸",abbr:"å‚³",c:12},{n:"é›…æ­Œ",abbr:"æ­Œ",c:8},{n:"ä»¥è³½äºæ›¸",abbr:"è³½",c:66},{n:"è€¶åˆ©ç±³æ›¸",abbr:"è€¶",c:52},{n:"è€¶åˆ©ç±³å“€æ­Œ",abbr:"å“€",c:5},{n:"ä»¥è¥¿çµæ›¸",abbr:"çµ",c:48},{n:"ä½†ä»¥ç†æ›¸",abbr:"ä½†",c:12},{n:"ä½•è¥¿é˜¿æ›¸",abbr:"ä½•",c:14},{n:"ç´„ç¥æ›¸",abbr:"ç¥",c:3},{n:"é˜¿æ‘©å¸æ›¸",abbr:"æ‘©",c:9},{n:"ä¿„å·´åº•äºæ›¸",abbr:"ä¿„",c:1},{n:"ç´„æ‹¿æ›¸",abbr:"æ‹¿",c:4},{n:"å½Œè¿¦æ›¸",abbr:"å½Œ",c:7},{n:"é‚£é´»æ›¸",abbr:"é´»",c:3},{n:"å“ˆå·´è°·æ›¸",abbr:"å“ˆ",c:3},{n:"è¥¿ç•ªé›…æ›¸",abbr:"ç•ª",c:3},{n:"å“ˆè©²æ›¸",abbr:"è©²",c:2},{n:"æ’’è¿¦åˆ©äºæ›¸",abbr:"äº",c:14},{n:"ç‘ªæ‹‰åŸºæ›¸",abbr:"ç‘ª",c:4}],
            new: [{n:"é¦¬å¤ªç¦éŸ³",abbr:"å¤ª",c:28},{n:"é¦¬å¯ç¦éŸ³",abbr:"å¯",c:16},{n:"è·¯åŠ ç¦éŸ³",abbr:"è·¯",c:24},{n:"ç´„ç¿°ç¦éŸ³",abbr:"ç´„",c:21},{n:"ä½¿å¾’è¡Œå‚³",abbr:"å¾’",c:28},{n:"ç¾…é¦¬æ›¸",abbr:"ç¾…",c:16},{n:"å“¥æ—å¤šå‰æ›¸",abbr:"æ—å‰",c:16},{n:"å“¥æ—å¤šå¾Œæ›¸",abbr:"æ—å¾Œ",c:13},{n:"åŠ æ‹‰å¤ªæ›¸",abbr:"åŠ ",c:6},{n:"ä»¥å¼—æ‰€æ›¸",abbr:"å¼—",c:6},{n:"è…“ç«‹æ¯”æ›¸",abbr:"è…“",c:4},{n:"æ­Œç¾…è¥¿æ›¸",abbr:"è¥¿",c:4},{n:"å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸",abbr:"å¸–å‰",c:5},{n:"å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸",abbr:"å¸–å¾Œ",c:3},{n:"ææ‘©å¤ªå‰æ›¸",abbr:"æå‰",c:6},{n:"ææ‘©å¤ªå¾Œæ›¸",abbr:"æå¾Œ",c:4},{n:"æå¤šæ›¸",abbr:"å¤š",c:3},{n:"è…“åˆ©é–€æ›¸",abbr:"é–€",c:1},{n:"å¸Œä¼¯ä¾†æ›¸",abbr:"ä¾†",c:13},{n:"é›…å„æ›¸",abbr:"é›…",c:5},{n:"å½¼å¾—å‰æ›¸",abbr:"å½¼å‰",c:5},{n:"å½¼å¾—å¾Œæ›¸",abbr:"å½¼å¾Œ",c:3},{n:"ç´„ç¿°ä¸€æ›¸",abbr:"ç´„ä¸€",c:5},{n:"ç´„ç¿°äºŒæ›¸",abbr:"ç´„äºŒ",c:1},{n:"ç´„ç¿°ä¸‰æ›¸",abbr:"ç´„ä¸‰",c:1},{n:"çŒ¶å¤§æ›¸",abbr:"çŒ¶",c:1},{n:"å•Ÿç¤ºéŒ„",abbr:"å•Ÿ",c:22}]
        };

        const planTracks = [
            {t: "èˆŠç´„", books: bibleBooks.old},
            {t: "æ–°ç´„", books: bibleBooks.new},
            {t: "è©©ç¯‡", books: [{n:"è©©ç¯‡",abbr:"è©©",c:150}]},
            {t: "ç®´è¨€", books: [{n:"ç®´è¨€",abbr:"ç®´",c:31}]}
        ];

        const bookMap = {};
        [...bibleBooks.old, ...bibleBooks.new].forEach(b => {
            bookMap[b.abbr] = b.n;
            bookMap[b.n] = b.n;
            bookMap[b.n.replace("æ›¸","")] = b.n;
        });

        // æ¨¡æ“¬æ•¸æ“š (Fallback Mock Data)
        const mockVerses = {
            "å‰µä¸–è¨˜": {1: {1: "èµ·åˆï¼Œç¥å‰µé€ å¤©åœ°ã€‚", 2: "åœ°æ˜¯ç©ºè™›æ··æ²Œï¼Œæ·µé¢é»‘æš—ï¼›ç¥çš„éˆé‹è¡Œåœ¨æ°´é¢ä¸Šã€‚", 3: "ç¥èªªï¼šã€Œè¦æœ‰å…‰ã€ï¼Œå°±æœ‰äº†å…‰ã€‚"}},
            "é¦¬å¤ªç¦éŸ³": {1: {1: "äºä¼¯æ‹‰ç½•çš„å¾Œè£”ï¼Œå¤§è¡›çš„å­å­«ï¼Œè€¶ç©ŒåŸºç£çš„å®¶è­œã€‚", 18: "è€¶ç©ŒåŸºç£é™ç”Ÿçš„äº‹è¨˜åœ¨ä¸‹é¢ï¼šä»–æ¯è¦ªé¦¬åˆ©äºå·²ç¶“è¨±é…äº†ç´„ç‘Ÿï¼Œé‚„æ²’æœ‰è¿å¨¶ï¼Œé¦¬åˆ©äºå°±å¾è–éˆæ‡·äº†å­•ã€‚"}},
            "è©©ç¯‡": {1: {1: "ä¸å¾æƒ¡äººçš„è¨ˆè¬€ï¼Œä¸ç«™ç½ªäººçš„é“è·¯ï¼Œä¸åè¤»æ…¢äººçš„åº§ä½ã€‚", 2: "æƒŸå–œæ„›è€¶å’Œè¯çš„å¾‹æ³•ï¼Œæ™å¤œæ€æƒ³ï¼Œé€™äººä¾¿ç‚ºæœ‰ç¦ï¼"}},
            "ç®´è¨€": {1: {7: "æ•¬ç•è€¶å’Œè¯æ˜¯çŸ¥è­˜çš„é–‹ç«¯ï¼›æ„šå¦„äººè—è¦–æ™ºæ…§å’Œè¨“èª¨ã€‚"}}
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // åˆå§‹åŒ–
        async function initApp() {
            els = {
                viewHome: document.getElementById('view-home'),
                viewWorkspace: document.getElementById('view-workspace'),
                mainHeader: document.getElementById('main-header'),
                readerTitle: document.getElementById('header-main-title'),
                readerSubtitle: document.getElementById('header-subtitle'),
                backBtn: document.getElementById('btn-header-back'),
                copyBtn: document.getElementById('btn-copy-verses'),
                btnCopyProgress: document.getElementById('btn-copy-progress'),
                
                headerTitle: document.getElementById('header-title'),
                datePicker: document.getElementById('date-picker'),
                homeDatePicker: document.getElementById('home-date-picker'),
                inlineSearch: document.getElementById('inline-search'),
                calendarGrid: document.getElementById('calendar-grid'),
                calendarMonthLabel: document.getElementById('calendar-month-label'),
                streakCount: document.getElementById('streak-count'),
                streakBadge: document.getElementById('streak-badge'),
                
                // Content Views
                viewBooks: document.getElementById('view-bible-books'),
                viewChapters: document.getElementById('view-bible-chapters'),
                viewText: document.getElementById('view-bible-text')
            };

            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            window.handleDateChange(todayKey);
            window.setAppIcon();

            try {
                // å˜—è©¦è¼‰å…¥ SQL
                if (typeof window.initSqlJs === 'function') {
                    SQL = await window.initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
                    const res = await fetch(REMOTE_DB_URL);
                    if (!res.ok) throw new Error("Remote DB Fetch Failed");
                    const buffer = await res.arrayBuffer();
                    sqlDb = new SQL.Database(new Uint8Array(buffer));
                    sqlDbLoaded = true;
                    window.detectTableStructure();
                    els.inlineSearch.placeholder = "ğŸ” æœå°‹ç¶“æ–‡...";
                } else {
                    throw new Error("SQL.js not loaded");
                }
            } catch(e) {
                console.warn("DB Load Failed, using fallback mode.", e);
                els.inlineSearch.placeholder = "âš ï¸ é€£ç·šå¤±æ•— (åƒ…ä¾›è©¦é–±)";
            }

            window.renderCalendar();
            window.calculateStreak();
        }

        window.setAppIcon = function() {
            const canvas = document.createElement('canvas');
            canvas.width = 192;
            canvas.height = 192;
            const ctx = canvas.getContext('2d');
            
            // --- 3D Lego Brick Logic ---
            
            // 1. Base Block (Yellow)
            const baseColor = '#FFD500';
            const shadowColor = '#ccaa00';
            const highlightColor = '#ffe666'; 
            
            ctx.fillStyle = baseColor;
            ctx.fillRect(0, 0, 192, 192);
            
            // Inner shadow/Highlight
            ctx.strokeStyle = 'rgba(255,255,255,0.4)';
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0,192); ctx.lineTo(0,0); ctx.lineTo(192,0); ctx.stroke();
            
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath(); ctx.moveTo(0,192); ctx.lineTo(192,192); ctx.lineTo(192,0); ctx.stroke();

            // 2. Draw Studs (3x3 Grid = 9 dots, smaller and cleaner)
            const gridSize = 3;
            const cellSize = 192 / gridSize; // 64
            const studRadius = 22; // Smaller radius for 3x3 layout
            
            for(let row=0; row<gridSize; row++) {
                for(let col=0; col<gridSize; col++) {
                    const cx = cellSize/2 + col*cellSize;
                    const cy = cellSize/2 + row*cellSize;
                    
                    // A. Cast Shadow
                    ctx.beginPath();
                    ctx.arc(cx + 4, cy + 4, studRadius, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(0,0,0,0.1)'; 
                    ctx.fill();

                    // B. Stud Side
                    ctx.beginPath();
                    ctx.arc(cx, cy + 2, studRadius, 0, Math.PI * 2);
                    ctx.fillStyle = shadowColor; 
                    ctx.fill();

                    // C. Stud Top
                    const grad = ctx.createLinearGradient(cx - studRadius, cy - studRadius, cx + studRadius, cy + studRadius);
                    grad.addColorStop(0, highlightColor);
                    grad.addColorStop(1, shadowColor);
                    
                    ctx.beginPath();
                    ctx.arc(cx, cy, studRadius, 0, Math.PI * 2);
                    ctx.fillStyle = grad; 
                    ctx.fill();

                    // D. Highlight
                    ctx.beginPath();
                    ctx.ellipse(cx - 8, cy - 8, 7, 4, -Math.PI / 4, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.fill();
                    
                    // E. Emboss
                    ctx.beginPath();
                    ctx.arc(cx, cy, studRadius - 5, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0,0,0,0.05)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // 3. Icon Overlay (Toast/Manna) - Thicker Lines
            ctx.save();
            ctx.translate(24, 24); 
            ctx.scale(6, 6); 
            
            // é—œéµä¿®æ”¹ï¼šå°‡ç·šæ¢åŠ ç²—
            ctx.lineWidth = 5.5 / 6; // Much bolder (was 2.5/6)
            ctx.strokeStyle = '#333333';
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Draw Toast Shape
            ctx.beginPath();
            ctx.moveTo(4, 14);
            ctx.bezierCurveTo(4, 14, 4, 7, 12, 7);
            ctx.bezierCurveTo(20, 7, 20, 14, 20, 14);
            ctx.lineTo(20, 18);
            ctx.bezierCurveTo(20, 19.1, 19.1, 20, 18, 20);
            ctx.lineTo(6, 20);
            ctx.bezierCurveTo(4.9, 20, 4, 19.1, 4, 18);
            ctx.lineTo(4, 14);
            ctx.closePath();
            
            // White halo for visibility against studs
            ctx.shadowColor = "rgba(255,255,255,0.8)";
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 1.5; // Slightly offset
            ctx.shadowOffsetY = 1.5;
            ctx.stroke();
            
            // Reset shadow to draw the dark line clearly
            ctx.shadowColor = "transparent"; 
            ctx.stroke(); // Stroke again to be sharp

            // Draw Line (Toast Crust)
            ctx.beginPath();
            ctx.moveTo(4, 14);
            ctx.lineTo(20, 14);
            ctx.stroke();

            // Draw Eyes (Curved)
            ctx.beginPath();
            ctx.moveTo(9, 11);
            ctx.bezierCurveTo(9, 11, 9.5, 10, 10.5, 10);
            ctx.bezierCurveTo(11.5, 10, 12, 11, 12, 11);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(13, 11);
            ctx.bezierCurveTo(13, 11, 13.5, 10, 14.5, 10);
            ctx.bezierCurveTo(15.5, 10, 16, 11, 16, 11);
            ctx.stroke();

            ctx.restore();

            const dataURL = canvas.toDataURL('image/png');
            const existingIcons = document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]');
            existingIcons.forEach(e => e.remove());
            const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.type = 'image/png'; linkIcon.href = dataURL; document.head.appendChild(linkIcon);
            const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = dataURL; document.head.appendChild(linkApple);
        }

        window.detectTableStructure = function() {
            if(!sqlDb) return;
            try {
                const tables = sqlDb.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
                if(tables[0] && tables[0].values.length > 0) {
                    const names = tables[0].values.flat();
                    dbTable = names.includes('verses') ? 'verses' : (names.includes('bible') ? 'bible' : names[0]);
                }
                const cols = sqlDb.exec(`PRAGMA table_info(${dbTable})`);
                if(cols.length > 0) {
                    const colNames = cols[0].values.map(r => r[1]);
                    if(colNames.includes('content')) dbCols.text = 'content';
                    else if(colNames.includes('scripture')) dbCols.text = 'scripture';
                    else if(colNames.includes('text')) dbCols.text = 'text';
                    if(colNames.includes('book_name')) dbCols.book = 'book_name';
                    else if(colNames.includes('book')) dbCols.book = 'book';
                    if(colNames.includes('chapter_number')) dbCols.chapter = 'chapter_number';
                    else if(colNames.includes('chapter')) dbCols.chapter = 'chapter';
                    if(colNames.includes('verse_number')) dbCols.verse = 'verse_number';
                    else if(colNames.includes('verse')) dbCols.verse = 'verse';
                }
            } catch(e) { console.error("Table detection failed", e); }
        }

        // åˆ‡æ›æ¨¡å¼
        window.switchMode = function(m) {
            currentMode = m;
            els.viewHome.classList.toggle('hidden', m !== 'home');
            els.viewWorkspace.classList.toggle('hidden', m === 'home');
            els.mainHeader.classList.toggle('hidden', m === 'home');

            const isDevotion = m === 'devotion';
            const isPureJournal = ['journal-prayer','journal-gratitude','journal-mood'].includes(m);
            const isBible = m === 'bible';

            // 1. UI å…ƒç´ åˆ‡æ›
            document.getElementById('workspace-tabs').classList.toggle('hidden', !isDevotion);
            document.getElementById('devotion-tabs').classList.toggle('hidden', !isDevotion);
            
            document.getElementById('search-box').classList.toggle('invisible', !isBible); 

            ['journal-devotion-fields', 'journal-prayer-fields', 'journal-gratitude-fields', 'journal-mood-fields']
                .forEach(id => document.getElementById(id).classList.add('hidden'));

            const readerSec = document.getElementById('section-reader');
            const journalSec = document.getElementById('section-journal');

            readerSec.classList.remove('hidden', 'lg:w-1/2');
            journalSec.classList.remove('hidden', 'lg:w-1/2');
            readerSec.classList.add('w-full'); 
            journalSec.classList.add('w-full');

            els.backBtn.classList.add('hidden');
            els.copyBtn.classList.add('hidden');

            if (els.btnCopyProgress) {
                els.btnCopyProgress.classList.toggle('hidden', !isDevotion);
            }

            if (isDevotion) {
                readerSec.classList.remove('w-full');
                journalSec.classList.remove('w-full');
                readerSec.classList.add('lg:w-1/2');
                journalSec.classList.add('lg:w-1/2');

                document.getElementById('journal-devotion-fields').classList.remove('hidden');
                els.headerTitle.innerText = "Daily Devotion";
                els.readerTitle.innerText = "Daily Devotion";
                els.readerSubtitle.innerText = "Reading Plan";
                window.updateDevotionUI();
                window.switchWorkspaceTab('reader'); 
            } else if (isBible) {
                journalSec.classList.add('hidden'); 
                els.headerTitle.innerText = "Bible Reading";
                els.readerTitle.innerText = "Bible Reading";
                els.readerSubtitle.innerText = "Select Book";
                window.renderMainBooks('old');
                window.goBackToMainBooks();
                window.switchWorkspaceTab('reader'); 
            } else if (isPureJournal) {
                readerSec.classList.add('hidden'); 
                const map = {'journal-prayer':'Prayer Journal','journal-gratitude':'Gratitude','journal-mood':'Mood Diary'};
                const fieldMap = {'journal-prayer':'journal-prayer-fields','journal-gratitude':'journal-gratitude-fields','journal-mood':'journal-mood-fields'};
                els.headerTitle.innerText = map[m];
                document.getElementById(fieldMap[m]).classList.remove('hidden');
                window.switchWorkspaceTab('journal'); 
            }
        }

        window.fetchBibleRef = async function(refInput) {
            const ref = refInput ? refInput.trim() : "";
            if(!ref) return;

            // UI ç‹€æ…‹åˆ‡æ›
            els.viewBooks.classList.add('hidden');
            els.viewChapters.classList.add('hidden');
            els.viewText.classList.remove('hidden');
            els.copyBtn.classList.remove('hidden');
            els.backBtn.classList.remove('hidden');
            
            els.viewText.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>';
            
            // è§£æç¶“æ–‡å¼•ç”¨
            const match = ref.match(/^([\u4e00-\u9fa5]+|[a-zA-Z]+)\s*(\d+)(?::(\d+)(?:-(\d+))?)?$/);
            const bookKey = match ? match[1] : null;
            const isBookRef = bookKey && (bookMap[bookKey] || bookMap[bookKey.replace("æ›¸","")]);

            // === å„ªå…ˆå˜—è©¦å¾ SQL è³‡æ–™åº«è®€å– ===
            if (sqlDbLoaded) {
                if (match && isBookRef) {
                    const book = bookMap[bookKey] || bookKey; 
                    const chapter = parseInt(match[2]);
                    const startV = match[3] ? parseInt(match[3]) : 1;
                    const endV = match[4] ? parseInt(match[4]) : (match[3] ? parseInt(match[3]) : 200); 

                    try {
                        const query = `SELECT ${dbCols.chapter}, ${dbCols.verse}, ${dbCols.text} FROM ${dbTable} WHERE ${dbCols.book} = ? AND ${dbCols.chapter} = ? AND ${dbCols.verse} >= ? AND ${dbCols.verse} <= ?`;
                        const res = sqlDb.exec(query, [book, chapter, startV, endV]);
                        
                        if (res.length > 0) {
                            els.readerTitle.innerText = `${book} ${chapter}`;
                            els.readerSubtitle.innerText = "Scripture";
                            els.viewText.innerHTML = res[0].values.map(v => `
                                <div class="verse-item mb-4" onclick="this.classList.toggle('selected'); window.updateCopyButton()">
                                    <span class="text-xs font-bold text-white bg-[#333] mr-2 px-1 rounded-sm select-none inline-block">${v[1]}</span>
                                    <span class="text-verse leading-loose">${v[2]}</span>
                                </div>
                            `).join('');
                            return; // æˆåŠŸè®€å–ï¼ŒçµæŸ
                        } else {
                            els.viewText.innerHTML = "<p class='p-8 opacity-50 text-center text-sm'>æ­¤ç« ç¯€æŸ¥ç„¡å…§å®¹ã€‚</p>";
                            return;
                        }
                    } catch(e) { console.error(e); }
                } else {
                    // é—œéµå­—æœå°‹
                    try {
                        els.readerTitle.innerText = `æœå°‹: "${ref}"`;
                        els.readerSubtitle.innerText = "Search Result";
                        const query = `SELECT ${dbCols.book}, ${dbCols.chapter}, ${dbCols.verse}, ${dbCols.text} FROM ${dbTable} WHERE ${dbCols.text} LIKE ? LIMIT 50`;
                        const res = sqlDb.exec(query, [`%${ref}%`]);

                        if (res.length > 0) {
                            const results = res[0].values;
                            els.viewText.innerHTML = results.map(v => {
                                const highlightedTxt = v[3].replace(new RegExp(ref, 'g'), `<span class="bg-[#FFD500] text-[#333] px-1 font-bold rounded">${ref}</span>`);
                                return `
                                    <div class="verse-item mb-4 p-4 border-2 border-transparent hover:border-gray-200 transition-all cursor-pointer" onclick="this.classList.toggle('selected'); window.updateCopyButton()">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-[10px] font-bold text-white bg-[#0055BF] px-2 py-1 tracking-wider rounded">${v[0]} ${v[1]}:${v[2]}</span>
                                        </div>
                                        <span class="text-verse text-[#333] leading-relaxed block">${highlightedTxt}</span>
                                    </div>
                                `;
                            }).join('');
                            return;
                        } else {
                            els.viewText.innerHTML = `<div class="flex flex-col items-center justify-center py-12"><span class="text-4xl mb-4">ğŸ‘¾</span><p class="text-lg font-bold">æ‰¾ä¸åˆ°ã€Œ${ref}ã€</p></div>`;
                            return;
                        }
                    } catch(e) { console.error(e); }
                }
            }

            // === å‚™ç”¨æ–¹æ¡ˆ (Fallback Mode) ===
            // ç•¶ SQL è³‡æ–™åº«è¼‰å…¥å¤±æ•—æ™‚ï¼Œå˜—è©¦å¾å…§å»ºçš„ Mock Data å°‹æ‰¾
            if (match && isBookRef) {
                const book = bookMap[bookKey] || bookKey; 
                const chapter = parseInt(match[2]);
                const verseData = mockVerses[book]?.[chapter];

                els.readerTitle.innerText = `${book} ${chapter}`;
                els.readerSubtitle.innerText = "Fallback Mode";

                if (verseData) {
                    els.viewText.innerHTML = `
                        <div class="p-3 bg-red-50 text-red-600 rounded mb-4 text-xs font-bold border border-red-200">
                            âš ï¸ é ç«¯è³‡æ–™åº«æœªé€£ç·šï¼Œåƒ…é¡¯ç¤ºè©¦é–±å…§å®¹ã€‚
                        </div>
                    ` + Object.keys(verseData).map(vNum => `
                        <div class="verse-item mb-4" onclick="this.classList.toggle('selected'); window.updateCopyButton()">
                            <span class="text-xs font-bold text-white bg-[#333] mr-2 px-1 rounded-sm select-none inline-block">${vNum}</span>
                            <span class="text-verse leading-loose">${verseData[vNum]}</span>
                        </div>
                    `).join('');
                } else {
                    els.viewText.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <span class="text-4xl mb-4">ğŸ”Œ</span>
                            <p class="text-lg font-bold text-[#333]">è³‡æ–™åº«é€£ç·šä¸­æ–·</p>
                            <p class="text-sm text-gray-500 mt-2">ç„¡æ³•è®€å– ${book} ç¬¬ ${chapter} ç« ã€‚<br>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>
                        </div>
                    `;
                }
            } else {
                els.viewText.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <span class="text-4xl mb-4">âš ï¸</span>
                        <p class="text-lg font-bold text-[#333]">ç„¡æ³•åŸ·è¡Œæœå°‹</p>
                        <p class="text-sm text-gray-500 mt-2">è³‡æ–™åº«æœªé€£ç·šï¼Œæœå°‹åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚</p>
                    </div>
                `;
            }
        }

        window.updateDevotionUI = function() {
            const start = new Date(calendarDate.getFullYear(), 0, 0);
            const diff = calendarDate - start;
            const dayOfYear = Math.floor(diff / 86400000);
            
            let progressTexts = [];

            const container = document.getElementById('devotion-tabs');
            container.innerHTML = planTracks.map((track, idx) => {
                const totalChapters = track.books.reduce((a,b)=>a+b.c, 0);
                const chapterIdx = Math.floor((dayOfYear % totalChapters)) || 1;
                
                let currentCount = 0, targetBook = track.books[0], targetChapter = 1;
                for(let b of track.books) {
                    if (currentCount + b.c >= chapterIdx) {
                        targetBook = b;
                        targetChapter = chapterIdx - currentCount;
                        break;
                    }
                    currentCount += b.c;
                }

                const ref = `${targetBook.abbr} ${targetChapter}`;
                progressTexts.push(ref);

                return `
                    <div class="devotion-track-card ${idx===0?'active':''}" onclick="window.fetchBibleRef('${ref}'); document.querySelectorAll('.devotion-track-card').forEach(c=>c.classList.remove('active')); this.classList.add('active');">
                        <span class="track-tag uppercase">${track.t}</span>
                        <span class="track-ref font-mono">${ref}</span>
                    </div>
                `;
            }).join('');
            
            const progressField = document.getElementById('note-devotion-progress');
            if(progressField) {
                progressField.value = progressTexts.join(' / ');
            }

            // å®‰å…¨ç²å–ç¬¬ä¸€å€‹ç¶“æ–‡å¼•ç”¨
            const firstRefEl = container.querySelector('.track-ref');
            if(firstRefEl) {
                window.fetchBibleRef(firstRefEl.innerText);
            }
        }

        window.handleDateChange = function(val) {
            calendarDate = new Date(val);
            if(els.datePicker) els.datePicker.value = val;
            if(els.homeDatePicker) els.homeDatePicker.value = val;
            
            const daySeed = val.split('-').reduce((a,b)=>a+parseInt(b), 0);
            const m = mannaVerses[daySeed % mannaVerses.length];
            document.getElementById('manna-text').innerText = m.t;
            document.getElementById('manna-ref').innerText = m.r;

            const fields = [
                'note-rhema', 'note-reflection', 'note-application', 'note-prayer-devotion',
                'note-topic', 'note-content', 
                'note-thanks', 'note-grace', 
                'note-mood-event', 'note-mood-tags', 'note-mood-lie', 'note-mood-god-view', 'note-mood-prayer'
            ];
            fields.forEach(f => {
                const el = document.getElementById(f);
                if(el) {
                    el.value = localStorage.getItem(`${val}-${f}`) || "";
                    el.oninput = () => {
                        localStorage.setItem(`${val}-${f}`, el.value);
                        window.renderCalendar();
                    };
                }
            });
            
            if(currentMode === 'devotion') {
                window.updateDevotionUI();
            }
            
            window.renderCalendar();
        }

        window.renderCalendar = function() {
            const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
            els.calendarMonthLabel.innerText = `${y}.${m+1}`;
            els.calendarGrid.innerHTML = "";
            const startDay = new Date(y, m, 1).getDay();
            const totalDays = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<startDay; i++) els.calendarGrid.appendChild(document.createElement('div'));
            for(let i=1; i<=totalDays; i++) {
                const d = document.createElement('div');
                const key = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                d.className = "calendar-day"; d.innerText = i;
                if (key === els.datePicker.value) d.classList.add('selected-day');
                const hasNote = ['note-rhema', 'note-content', 'note-thanks', 'note-mood-event', 'note-mood-tags'].some(field => localStorage.getItem(`${key}-${field}`));
                if (hasNote) d.classList.add('has-entry');
                d.onclick = () => window.handleDateChange(key);
                els.calendarGrid.appendChild(d);
            }
        }

        window.switchWorkspaceTab = function(t) {
            const r = document.getElementById('section-reader'), j = document.getElementById('section-journal');
            const tr = document.getElementById('tab-reader'), tj = document.getElementById('tab-journal');
            if (t === 'reader') {
                r.classList.replace('opacity-0', 'opacity-100'); r.classList.replace('z-0', 'z-10'); r.style.pointerEvents = "auto";
                j.classList.replace('opacity-100', 'opacity-0'); j.classList.replace('z-10', 'z-0'); j.style.pointerEvents = "none";
                tr.classList.add('active'); tj.classList.remove('active');
            } else {
                j.classList.replace('opacity-0', 'opacity-100'); j.classList.replace('z-0', 'z-10'); j.style.pointerEvents = "auto";
                r.classList.replace('opacity-100', 'opacity-0'); r.classList.replace('z-10', 'z-0'); r.style.pointerEvents = "none";
                tj.classList.add('active'); tr.classList.remove('active');
            }
        }

        window.renderMainBooks = function(t) {
            els.viewBooks.innerHTML = `<div class="flex gap-4 mb-6 shrink-0"><button onclick="window.renderMainBooks('old')" class="brick-btn btn-yellow flex-1 text-sm">èˆŠç´„ Old Testament</button><button onclick="window.renderMainBooks('new')" class="brick-btn flex-1 text-sm border-2 border-gray-100">æ–°ç´„ New Testament</button></div>` +
            `<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 content-start pb-10">` + bibleBooks[t].map(b => `<button class="px-3 py-3 text-sm border-2 border-gray-100 rounded bg-white hover:bg-gray-50 text-left font-bold shadow-[0_3px_0_#ddd] active:translate-y-1 active:shadow-none transition-all" onclick='window.showMainChapters(${JSON.stringify(b)})'>${b.n}</button>`).join('') + `</div>`;
        }

        window.showMainChapters = function(b) {
            els.viewBooks.classList.add('hidden');
            els.viewChapters.classList.remove('hidden');
            els.viewText.classList.add('hidden');
            
            els.readerTitle.innerText = b.n;
            els.readerSubtitle.innerText = "Select Chapter";
            els.backBtn.classList.remove('hidden');
            els.copyBtn.classList.add('hidden');

            document.getElementById('main-chapter-title').innerText = b.n;
            document.getElementById('main-chapter-grid').innerHTML = Array.from({length:b.c}, (_,i)=> `
                <button class="aspect-square border-2 border-gray-100 rounded bg-white hover:bg-[#0055BF] hover:text-white flex items-center justify-center font-bold text-sm shadow-[0_3px_0_#ddd] active:translate-y-1 active:shadow-none transition-all" onclick="window.fetchBibleRef('${b.abbr}${i+1}')">${i+1}</button>
            `).join('');
        }

        window.goBackToMainBooks = function() {
            if (!els.viewText.classList.contains('hidden')) {
                els.viewText.classList.add('hidden');
                els.viewChapters.classList.add('hidden');
                els.viewBooks.classList.remove('hidden');
                els.readerTitle.innerText = "Bible Reading";
                els.readerSubtitle.innerText = "Select Book";
                els.backBtn.classList.add('hidden');
                els.copyBtn.classList.add('hidden');
            } else {
                els.viewChapters.classList.add('hidden');
                els.viewBooks.classList.remove('hidden');
                els.readerTitle.innerText = "Bible Reading";
                els.readerSubtitle.innerText = "Select Book";
                els.backBtn.classList.add('hidden');
            }
        }

        window.copyDevotionProgress = function() {
            const progressText = document.getElementById('note-devotion-progress').value;
            if(!progressText || progressText === "Loading...") return;
            
            const t = document.createElement('textarea'); 
            t.value = progressText; 
            document.body.appendChild(t); 
            t.select(); 
            document.execCommand('copy'); 
            document.body.removeChild(t);
            
            const btn = document.getElementById('btn-copy-progress');
            const originalText = btn.innerText;
            const originalClass = btn.className;
            
            btn.innerText = "COPIED!";
            btn.classList.replace('bg-[#333]', 'bg-[#008F39]');
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.replace('bg-[#008F39]', 'bg-[#333]');
            }, 1500);
        }

        window.changeCalendarMonth = function(n) { calendarDate.setMonth(calendarDate.getMonth()+n); window.renderCalendar(); }
        window.goHome = function() { window.switchMode('home'); }
        window.openExportModal = function() { document.getElementById('export-modal').classList.remove('hidden'); }
        window.closeExportModal = function() { document.getElementById('export-modal').classList.add('hidden'); }
        window.selectMood = function(el, m) { document.getElementById('note-mood').value = m; document.querySelectorAll('.mood-sticker').forEach(s=>s.classList.remove('selected')); el.classList.add('selected'); }
        
        window.performSearch = function() { window.fetchBibleRef(els.inlineSearch.value); }
        window.updateCopyButton = function() {
            const count = document.querySelectorAll('.verse-item.selected').length;
            els.copyBtn.innerHTML = count > 0 ? `<span class='text-[10px] font-bold'>${count}</span>` : `<svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`;
        }
        
        window.copySelectedVerses = function() {
            const sel = document.querySelectorAll('.verse-item.selected');
            if (sel.length === 0) return;
            const text = Array.from(sel).map(v => v.innerText.trim()).join('\n');
            const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            els.copyBtn.innerHTML = "OK!";
            setTimeout(() => { sel.forEach(v=>v.classList.remove('selected')); window.updateCopyButton(); }, 1000);
        }

        window.backupData = function() {
            const data = {};
            for(let i=0; i<localStorage.length; i++){
                const k = localStorage.key(i);
                if(k.includes('note-')) data[k] = localStorage.getItem(k);
            }
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `manna-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
        }

        window.restoreData = function(input) {
            const r = new FileReader();
            r.onload = e => {
                const data = JSON.parse(e.target.result);
                Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                location.reload();
            }
            r.readAsText(input.files[0]);
        }

        window.calculateStreak = function() {
            let s = 0, d = new Date();
            while(true) {
                const k = d.toISOString().split('T')[0];
                if (localStorage.getItem(`${k}-note-rhema`) || localStorage.getItem(`${k}-note-content`)) {
                    s++; d.setDate(d.getDate()-1);
                } else break;
            }
            els.streakCount.innerText = s;
            els.streakBadge.classList.toggle('hidden', s === 0);
            els.streakBadge.classList.add('inline-flex');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
