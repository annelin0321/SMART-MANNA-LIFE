<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» | Smart Manna Life</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SQLite Support (sql.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- Google Fonts -->
    <style>
        /* ä¿æŒ Noto Sans TC é¿å…ç¼ºå­—ï¼Œä¿ç•™ VT323 è£é£¾ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=VT323&display=swap');
        
        :root {
            /* æ¨‚é«˜ç©æœ¨é…è‰² (Lego Palette) */
            --lego-red: #E3000B;
            --lego-red-dark: #bf0009;
            --lego-blue: #0055BF;
            --lego-blue-dark: #004296;
            --lego-yellow: #FFD500;
            --lego-yellow-dark: #ccaa00;
            --lego-green: #008F39;
            --lego-green-dark: #006b2b;
            --lego-orange: #FE8A18; 
            --lego-orange-dark: #d97310;
            --lego-purple: #A65AD4;
            --lego-purple-dark: #8a40b5;
            --lego-white: #FFFFFF;
            --lego-grey: #A0A5A9;
            --lego-dark-grey: #6D6E71;
            
            --bg-baseplate: #F4F6F8; /* æ·ºç°åº•æ¿è‰² */
            --stud-shadow: rgba(0,0,0,0.1);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-baseplate);
            color: #333;
            -webkit-tap-highlight-color: transparent;
            /* èƒŒæ™¯åœ“é»è®Šå°è®Šå¯† */
            background-image: 
                radial-gradient(var(--stud-shadow) 20%, transparent 22%),
                radial-gradient(var(--stud-shadow) 20%, transparent 22%);
            background-size: 20px 20px; 
            background-position: 0 0, 10px 10px;
        }
        
        .pixel-font { font-family: 'VT323', monospace; }
        
        /* ç©æœ¨å¡ç‰‡ (Brick Card) */
        .brick-card {
            background: var(--lego-white);
            border-radius: 8px;
            border: 2px solid rgba(0,0,0,0.05);
            box-shadow: 0 6px 0 #E0E0E0, 0 12px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
        }
        .brick-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: rgba(0,0,0,0.05);
        }

        /* é€šç”¨ç©æœ¨æŒ‰éˆ• */
        .brick-btn {
            background-color: var(--lego-white);
            color: #333;
            font-weight: 900;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            position: relative;
            box-shadow: 0 5px 0 #ccc; 
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .brick-btn:active, .brick-btn.active {
            transform: translateY(5px); box-shadow: 0 0 0 #ccc;
        }
        
        /* é¡è‰²è®Šé«” */
        .btn-yellow { background-color: var(--lego-yellow); color: #333; box-shadow: 0 5px 0 var(--lego-yellow-dark); }
        .btn-yellow:active { box-shadow: 0 0 0 var(--lego-yellow-dark); }
        .btn-blue { background-color: var(--lego-blue); color: white; box-shadow: 0 5px 0 var(--lego-blue-dark); }
        .btn-blue:active { box-shadow: 0 0 0 var(--lego-blue-dark); }
        .btn-red { background-color: var(--lego-red); color: white; box-shadow: 0 5px 0 var(--lego-red-dark); }
        .btn-red:active { box-shadow: 0 0 0 var(--lego-red-dark); }
        .btn-green { background-color: var(--lego-green); color: white; box-shadow: 0 5px 0 var(--lego-green-dark); }
        .btn-green:active { box-shadow: 0 0 0 var(--lego-green-dark); }
        .btn-orange { background-color: var(--lego-orange); color: white; box-shadow: 0 5px 0 var(--lego-orange-dark); }
        .btn-orange:active { box-shadow: 0 0 0 var(--lego-orange-dark); }
        .btn-purple { background-color: var(--lego-purple); color: white; box-shadow: 0 5px 0 var(--lego-purple-dark); }
        .btn-purple:active { box-shadow: 0 0 0 var(--lego-purple-dark); }

        /* çœŸå¯¦ç©æœ¨é¢¨æ ¼æŒ‰éˆ• */
        .real-brick-btn {
            position: relative; border-radius: 4px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; overflow: hidden;
        }
        .real-brick-btn::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(rgba(0,0,0,0.2) 20%, transparent 22%); background-size: 16px 16px; background-position: 8px 8px; opacity: 0.5; pointer-events: none;
        }
        .real-brick-btn::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0.3) 0%, transparent 40%); pointer-events: none;
        }
        .real-brick-btn:active { transform: translateY(6px); box-shadow: 0 0 0 transparent !important; }

        .brick-bible { background-color: var(--lego-blue); color: white; box-shadow: 0 8px 0 var(--lego-blue-dark), 0 15px 15px rgba(0,0,0,0.2); }
        .brick-prayer { background-color: var(--lego-green); color: white; box-shadow: 0 8px 0 var(--lego-green-dark), 0 15px 15px rgba(0,0,0,0.2); }
        .brick-gratitude { background-color: var(--lego-yellow); color: #333; box-shadow: 0 8px 0 var(--lego-yellow-dark), 0 15px 15px rgba(0,0,0,0.2); }
        .brick-mood { background-color: var(--lego-red); color: white; box-shadow: 0 8px 0 var(--lego-red-dark), 0 15px 15px rgba(0,0,0,0.2); }
        .brick-freewrite { background-color: var(--lego-orange); color: white; box-shadow: 0 8px 0 var(--lego-orange-dark), 0 15px 15px rgba(0,0,0,0.2); }
        .brick-capsule { background-color: var(--lego-purple); color: white; box-shadow: 0 8px 0 var(--lego-purple-dark), 0 15px 15px rgba(0,0,0,0.2); }

        /* æ¸…å–®é …ç›®ç©æœ¨ */
        .list-brick {
            position: relative;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .list-brick:active { transform: translateY(4px); margin-bottom: 8px; }
        /* å´é‚Šå‡¸ç²’è£é£¾ */
        .list-brick::before {
            content: ''; position: absolute; top: 0; bottom: 0; left: 0; width: 24px;
            background-image: radial-gradient(rgba(0,0,0,0.15) 25%, transparent 28%);
            background-size: 12px 12px; background-position: 6px 6px;
            border-right: 2px solid rgba(0,0,0,0.05);
        }
        .list-brick-content { margin-left: 24px; flex: 1; min-width: 0; }
        .list-brick-title { font-weight: 900; font-size: 1rem; }
        .list-brick-preview { font-size: 0.85rem; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .list-brick-green { background: var(--lego-green); color: white; box-shadow: 0 4px 0 var(--lego-green-dark); }
        .list-brick-green:active { box-shadow: none; }
        .list-brick-yellow { background: var(--lego-yellow); color: #333; box-shadow: 0 4px 0 var(--lego-yellow-dark); }
        .list-brick-yellow:active { box-shadow: none; }
        .list-brick-red { background: var(--lego-red); color: white; box-shadow: 0 4px 0 var(--lego-red-dark); }
        .list-brick-red:active { box-shadow: none; }
        .list-brick-orange { background: var(--lego-orange); color: white; box-shadow: 0 4px 0 var(--lego-orange-dark); }
        .list-brick-orange:active { box-shadow: none; }

        /* åˆªé™¤æŒ‰éˆ• */
        .delete-btn {
            width: 32px; height: 32px;
            background: rgba(0,0,0,0.15);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            color: inherit; opacity: 0.7;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .delete-btn:hover { background: rgba(0,0,0,0.3); opacity: 1; transform: scale(1.1); }
        .delete-btn:active { transform: scale(0.9); }

        /* æ©«ç·šç­†è¨˜æœ¬æ¨£å¼ */
        .notebook-paper {
            background-color: #fff;
            background-image: linear-gradient(#E0E0E0 1px, transparent 1px);
            background-size: 100% 2rem;
            line-height: 2rem;
            padding: 0 1rem;
            border: 2px solid #ddd;
            border-left: 6px solid var(--lego-orange);
            border-radius: 4px;
            font-size: 1.1rem;
            color: #333;
            width: 100%;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .notebook-paper:focus {
            border-color: var(--lego-orange);
            background-color: #fffcf5;
        }
        
        /* åœ–ç¤ºå°ç©æœ¨ */
        .mini-brick { position: relative; overflow: hidden; }
        .mini-brick::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(rgba(0,0,0,0.15) 25%, transparent 28%); background-size: 13.33px 13.33px; background-position: 0 0; }
        .mini-brick::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0.4) 0%, transparent 50%); pointer-events: none; }

        .bible-text { line-height: 2.2; font-size: 1.15rem; letter-spacing: 0.05em; font-weight: 500; }
        .verse-item { padding: 8px 12px; margin-bottom: 8px; cursor: pointer; border-radius: 6px; border: 2px solid transparent; background: #FAFAFA; transition: all 0.1s; }
        .verse-item:hover { border-color: var(--lego-yellow); background: #fff; }
        .verse-item.selected { background-color: var(--lego-yellow); color: #333; border-bottom: 4px solid var(--lego-yellow-dark); transform: translateY(-2px); font-weight: 700; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--lego-grey); border-radius: 6px; border: 3px solid #f1f1f1; }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .devotion-track-card { background: white; border-radius: 6px; cursor: pointer; padding: 8px 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.1s; border-bottom: 4px solid #ddd; }
        .devotion-track-card:hover { transform: translateY(-2px); border-bottom-width: 6px; }
        .devotion-track-card.active { background: var(--lego-blue); color: white; border-bottom-color: var(--lego-blue-dark); transform: translateY(1px); border-bottom-width: 2px; }
        .devotion-track-card.active .track-tag { color: rgba(255,255,255,0.9); }
        .track-tag { font-size: 12px; font-weight: 700; color: #888; margin-bottom: 2px; }
        .track-ref { font-size: 14px; font-weight: 700; font-family: 'VT323', monospace; letter-spacing: 1px;}

        .workspace-tab-btn { flex: 1; text-align: center; padding: 12px 10px; font-size: 16px; font-weight: 700; color: #888; border-radius: 8px 8px 0 0; transition: all 0.1s; position: relative; background: #eee; margin-right: 4px; }
        .workspace-tab-btn.active { background-color: var(--lego-white); color: var(--lego-blue); box-shadow: 0 -3px 0 var(--lego-blue) inset; z-index: 10; margin-bottom: -2px; padding-bottom: 14px; }

        .mood-sticker { font-size: 1.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; transition: all 0.1s; background-color: #fff; border-bottom: 4px solid #ddd; }
        .mood-sticker:active, .mood-sticker.selected { transform: translateY(3px); border-bottom-width: 0; background-color: var(--lego-yellow); }

        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: all 0.1s; position: relative; font-weight: 700; background: #fff; border-bottom: 3px solid #ddd; font-family: 'VT323', monospace; font-size: 1.4rem; }
        .calendar-day:active { transform: translateY(3px); border-bottom: 0; }
        .calendar-day.has-entry::after { content: ''; position: absolute; bottom: 4px; width: 6px; height: 6px; background: var(--lego-green); border-radius: 50%; }
        .calendar-day.selected-day { background-color: var(--lego-blue) !important; color: white !important; border-bottom-color: var(--lego-blue-dark); }
        .calendar-day.today { border: 2px dashed var(--lego-red); color: var(--lego-red); border-bottom: 2px dashed var(--lego-red); }

        .loader { width: 40px; height: 40px; background-color: var(--lego-yellow); box-shadow: 0 4px 0 var(--lego-yellow-dark); border-radius: 4px; animation: bounce 0.6s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

        textarea:not(.notebook-paper), input[type="text"], input[type="date"], input[type="search"], input[type="email"] { 
            background-color: #FAFAFA; border: 2px solid #ddd; border-top: 4px solid #ccc; border-radius: 6px; font-family: 'Noto Sans TC', sans-serif; transition: all 0.2s; 
            /* Ensure box-sizing is border-box to prevent overflow with w-full */
            box-sizing: border-box;
        }
        textarea:not(.notebook-paper):focus, input:focus { outline: none; background-color: white; border-color: var(--lego-blue); border-top-color: var(--lego-blue); }
        
        .badge { background: var(--lego-red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 0 var(--lego-red-dark); }
        
        /* æƒ…ç·’è¡¨æ¨£å¼ */
        .emotion-group-title { font-size: 0.85rem; font-weight: 900; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .emotion-chip { 
            display: inline-block; padding: 4px 10px; margin: 0 4px 6px 0; border-radius: 16px; font-size: 0.85rem; font-weight: 700; 
            cursor: pointer; transition: all 0.1s; border: 1px solid transparent; user-select: none;
        }
        .emotion-chip:active { transform: scale(0.95); }
        
        .chip-pos { background-color: #FFFDE7; color: #F57F17; border-color: #FFF9C4; }
        .chip-pos:hover { background-color: #FFF9C4; }
        
        .chip-neu { background-color: #F5F5F5; color: #616161; border-color: #EEEEEE; }
        .chip-neu:hover { background-color: #EEEEEE; }
        
        .chip-neg { background-color: #FFEBEE; color: #D32F2F; border-color: #FFCDD2; }
        .chip-neg:hover { background-color: #FFCDD2; }

        /* å°ˆå±¬æ™‚å…‰ä¿¡ç®±ç©æœ¨æ¨£å¼ */
        .brick-mailbox-container {
            background-color: #F3E5F5; /* Light purple base */
            border: 2px solid #BA68C8; /* Purple border */
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            box-shadow: 0 4px 0 #AB47BC; /* 3D Shadow */
            margin-top: 1rem;
            overflow: hidden;
        }
        .brick-mailbox-container::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(186, 104, 200, 0.3) 20%, transparent 22%); /* Studs effect increased visibility */
            background-size: 20px 20px; /* Slightly larger studs */
            background-position: 10px 10px;
            pointer-events: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-[#FFD500] selection:text-black">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <header id="main-header" class="bg-white/95 backdrop-blur-none border-b-4 border-[#eee] sticky top-0 z-30 shrink-0 hidden">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="window.goHome()">
                <div class="w-10 h-10 bg-[#FFD500] rounded flex items-center justify-center shadow-[0_4px_0_#ccaa00] active:shadow-none active:translate-y-1 transition-all mini-brick border border-yellow-400">
                     <svg class="w-6 h-6 text-[#333] relative z-10" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2.5">
                        <path d="M4 14C4 14 4 7 12 7C20 7 20 14 20 14V18C20 19.1 19.1 20 18 20H6C4.9 20 4 19.1 4 18V14Z"></path>
                        <path d="M4 14H20"></path>
                        <path d="M9 11C9 11 9.5 10 10.5 10C11.5 10 12 11 12 11"></path>
                        <path d="M13 11C13 11 13.5 10 14.5 10C15.5 10 16 11 16 11"></path>
                    </svg>
                </div>
                <h1 class="hidden sm:block text-lg font-bold tracking-wider text-[#333]">æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´»</h1>
            </div>
            
            <div id="header-title" class="flex-1 text-center pixel-font text-2xl text-[#333] font-bold tracking-widest uppercase truncate">HOME</div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.openExportModal()" class="brick-btn px-3 py-2 hover:bg-gray-50 flex items-center gap-2">
                    <svg class="w-4 h-4" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span class="text-sm font-bold">å‚™ä»½/åŒ¯å…¥</span>
                </button>
                <!-- æ¢å¾© Header æ—¥æœŸé¸æ“‡å™¨ -->
                <input type="date" id="date-picker" class="border-2 border-[#ddd] rounded px-2 py-1 text-sm font-bold outline-none text-[#333] cursor-pointer" onchange="window.handleDateChange(this.value)">
            </div>
        </div>
    </header>

    <!-- 1. é¦–é è¦–åœ– -->
    <div id="view-home" class="flex-1 overflow-y-auto p-4 md:p-8 w-full max-w-5xl mx-auto flex flex-col">
        <div class="flex justify-between items-end mb-10 fade-in pt-4">
            <div class="flex flex-col gap-2">
                <span class="inline-block px-2 py-1 bg-[#333] text-[#FFD500] text-xs font-bold tracking-widest uppercase pixel-font transform -rotate-2 rounded shadow-sm">Smart Manna Life</span>
                <h1 class="text-3xl md:text-5xl font-black text-[#333] leading-tight flex items-center gap-3 drop-shadow-sm">
                    æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» 
                    <div class="w-10 h-10 bg-[#E3000B] rounded flex items-center justify-center relative top-1 shadow-[0_4px_0_#bf0009] mini-brick border border-red-600">
                        <svg class="w-6 h-6 text-white relative z-10" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2.5">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                        </svg>
                    </div>
                </h1>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.openExportModal()" class="brick-btn px-3 py-2 bg-white text-[#333] border-2 border-[#333] hover:bg-gray-50 shadow-[2px_2px_0px_0px_#333] active:shadow-none active:translate-y-1 transition-all flex items-center gap-2">
                     <svg class="w-4 h-4" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                     <span class="text-xs font-bold">å‚™ä»½/åŒ¯å…¥</span>
                </button>
                <div class="hidden sm:block">
                    <!-- æ¢å¾©é¦–é æ—¥æœŸé¸æ“‡å™¨ -->
                    <input type="date" id="home-date-picker" class="bg-white border-2 border-[#ddd] rounded px-4 py-2 text-sm font-bold outline-none shadow-[0_4px_0_#ccc] active:shadow-none active:translate-y-1 transition-all text-[#333]" onchange="window.handleDateChange(this.value)">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 fade-in">
            <!-- ä»Šæ—¥å—å“ªå¡ç‰‡ -->
            <div class="md:col-span-1 flex flex-col brick-card p-6 relative group bg-white">
                <div class="absolute top-4 right-4 p-2 opacity-10 rotate-12">
                    <svg class="w-20 h-20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2zm0 3.8L18.4 19H5.6L12 5.8z"/></svg>
                </div>
                
                <div class="inline-block px-3 py-1 bg-[#0055BF] text-white text-sm font-bold mb-6 self-start rounded shadow-[0_3px_0_#004296]">Today's Build</div>
                
                <!-- å€åŸŸ 1ï¼šé»æ“Šç¶“æ–‡ -> é–‹å•Ÿè©²ç« ç¯€ -->
                <div id="home-manna-display" class="z-10 flex-1 flex flex-col justify-center cursor-pointer hover:opacity-70 transition-opacity" onclick="window.openMannaChapter()" title="é»æ“Šé–±è®€æ­¤ç« ç¯€">
                    <p class="text-2xl font-bold text-[#333] leading-relaxed mb-6 not-italic" id="manna-text">Loading...</p>
                    <p class="text-sm font-bold bg-[#333] text-white px-2 py-1 w-fit self-end pixel-font tracking-wider rounded" id="manna-ref"></p>
                </div>

                <!-- å€åŸŸ 2ï¼šé»æ“ŠæŒ‰éˆ• -> é–‹å§‹éˆä¿®è¨ˆç•« -->
                <div class="flex items-center justify-between mt-8 pt-5 border-t-2 border-dashed border-gray-200 z-10 cursor-pointer hover:bg-gray-50 rounded p-2 -mx-2 transition-colors" onclick="window.switchMode('devotion')">
                     <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-[#FFD500] rounded flex items-center justify-center text-[#333] shadow-[0_3px_0_#ccaa00]">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider leading-tight">START BUILDING</span>
                            <span class="text-base text-[#333] font-bold tracking-widest">é–‹å§‹éˆä¿®</span>
                        </div>
                     </div>
                     <span class="text-2xl text-[#E3000B] font-black group-hover:translate-x-2 transition-transform">â†’</span>
                </div>
            </div>

            <!-- éˆä¿®è¶³è·¡æœˆæ›† -->
            <div class="md:col-span-2 brick-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-[#333] flex items-center gap-2 text-xl">
                        ç”Ÿå‘½è¶³è·¡ <span id="streak-badge" class="hidden items-center px-3 py-1 bg-[#FFD500] text-[#333] text-xs ml-2 rounded shadow-[0_2px_0_#ccaa00]">ğŸ”¥ <span id="streak-count" class="mx-1 font-mono text-lg">0</span> Days</span>
                    </h3>
                    <div class="flex items-center gap-3">
                        <button onclick="window.changeCalendarMonth(-1)" class="w-8 h-8 flex items-center justify-center brick-btn p-0">â—€</button>
                        <div class="text-xl font-bold w-24 text-center text-[#333] pixel-font" id="calendar-month-label"></div>
                        <button onclick="window.changeCalendarMonth(1)" class="w-8 h-8 flex items-center justify-center brick-btn p-0">â–¶</button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-400 mb-3 font-bold uppercase tracking-widest pixel-font">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>
        </div>

        <!-- æ·å¾‘å€åŸŸ (6å€‹æŒ‰éˆ• - å †ç©æœ¨æ’åˆ—) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-10 fade-in">
            <!-- Row 1: 1+1+2 -->
            <!-- è—è‰²ï¼šè–ç¶“ -->
            <div onclick="window.switchMode('bible')" class="real-brick-btn brick-bible cursor-pointer group h-auto col-span-1">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">è–ç¶“é–±è®€</h3>
            </div>
            
            <!-- ç¶ è‰²ï¼šç¦±å‘Š -->
            <div onclick="window.switchMode('journal-prayer')" class="real-brick-btn brick-prayer cursor-pointer group h-auto col-span-1">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">è·Ÿç¥èŠèŠ</h3>
            </div>
            
            <!-- é»ƒè‰²ï¼šæ„Ÿæ© (2 cols) -->
            <div onclick="window.switchMode('journal-gratitude')" class="real-brick-btn brick-gratitude cursor-pointer group h-auto col-span-2 md:col-span-2">
                <div class="flex items-center gap-3">
                     <svg class="w-10 h-10 text-[#333] opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <h3 class="text-base font-bold text-[#333] tracking-widest">æ„Ÿæ©æ—¥è¨˜</h3>
                </div>
            </div>
            
            <!-- Row 2: 2+1+1 -->
            <!-- ç´…è‰²ï¼šå…§å¿ƒæˆ² (2 cols) -->
            <div onclick="window.switchMode('journal-mood')" class="real-brick-btn brick-mood cursor-pointer group h-auto col-span-2 md:col-span-2">
                <div class="flex items-center gap-3">
                    <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                    <h3 class="text-base font-bold text-white tracking-widest">å…§å¿ƒæˆ²</h3>
                </div>
            </div>

            <!-- æ©˜è‰²ï¼šéš¨ä¾¿å¯« (1 col) -->
            <div onclick="window.switchMode('journal-freewrite')" class="real-brick-btn brick-freewrite cursor-pointer group h-auto col-span-1">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">éš¨ä¾¿å¯«</h3>
            </div>
            
            <!-- ç´«è‰²ï¼šæ™‚å…‰è† å›Š (1 col) -->
            <div onclick="window.openTimeCapsuleModal()" class="real-brick-btn brick-capsule cursor-pointer group h-auto col-span-1">
                <svg class="w-10 h-10 text-white opacity-90 group-hover:scale-110 transition-transform" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M12 2v20M2 12h20M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1 10-10z"></path>
                    <circle cx="12" cy="12" r="6"></circle>
                    <path d="M12 8v4l2 2"></path>
                </svg>
                <h3 class="text-base font-bold text-white tracking-widest mt-auto">æ™‚å…‰è† å›Š</h3>
            </div>
        </div>

        <footer class="mt-auto py-10 text-center fade-in border-t-4 border-[#ddd] w-11/12 md:w-2/3 mx-auto">
            <!-- è¯çµ¡èˆ‡å›é¥‹æ–‡å­—å€ -->
            <div class="mb-6">
                <h3 class="text-base font-bold text-[#333] mb-2 pixel-font tracking-widest flex items-center justify-center gap-2">
                    <span class="inline-block w-2 h-2 bg-[#E3000B] rounded-full"></span>
                    è¯çµ¡æˆ‘å€‘ / æ­¡è¿å›é¥‹
                    <span class="inline-block w-2 h-2 bg-[#E3000B] rounded-full"></span>
                </h3>
                <p class="text-xs text-gray-500 font-bold">è‹¥æœ‰å…¶ä»–éœ€æ±‚ï¼Œæ­¡è¿å›é¥‹ï¼Œè®“é€™å€‹ç¶²é æ›´å®Œå–„ â¤ï¸</p>
            </div>

            <!-- ç¤¾ç¾¤é€£çµæŒ‰éˆ• (ç©æœ¨é¢¨æ ¼) -->
            <div class="flex justify-center flex-wrap gap-4 mb-8">
                <!-- FB -->
                <a href="https://www.facebook.com/profile.php?id=100068500932557" target="_blank" class="brick-btn p-3 text-gray-400 hover:text-white hover:bg-[#1877F2] transition-colors flex items-center justify-center" title="Facebook">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                </a>
                
                <!-- IG -->
                <a href="https://www.instagram.com/forever.believe.in.jesus/" target="_blank" class="brick-btn p-3 text-gray-400 hover:text-white hover:bg-[#E4405F] transition-colors flex items-center justify-center" title="Instagram">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                </a>
                
                <!-- Threads -->
                <a href="https://www.threads.net/@forever.believe.in.jesus" target="_blank" class="brick-btn p-3 text-gray-400 hover:text-white hover:bg-black transition-colors flex items-center justify-center" title="Threads">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M12.27 4.15c-4.46 0-7.85 3.32-7.85 7.85 0 4.54 3.39 7.85 7.85 7.85 2.5 0 4.67-1.16 6.04-2.81l-1.92-1.46c-1 1.15-2.52 1.83-4.12 1.83-2.91 0-5.32-2.31-5.32-5.41s2.41-5.41 5.32-5.41c2.46 0 4.8 1.63 5.24 4.09l.06.35c.19 1.09.08 1.95-.31 2.34-.18.18-.45.26-.81.26-.58 0-1.17-.26-1.54-1.12l-.12-.27c-.49-1.15-.74-2.42-.74-3.69v-.39h-2.52v.4c0 1.57.34 3.09.98 4.49-.9 1.02-2.22 1.69-3.7 1.69-2.7 0-4.9-2.2-4.9-4.9 0-2.7 2.2-4.9 4.9-4.9 2.59 0 4.86 1.98 5.16 4.53.13 1.14.07 2.01-.17 2.65-.54 1.43-1.69 1.98-2.98 1.98-1.25 0-2.2-.69-2.61-1.91-.45-.87-.45-1.95-.45-2.07 0-.58.11-1.14.32-1.67.58-1.45 2.03-2.46 3.69-2.46z"/></svg>
                </a>
                
                <!-- Line -->
                <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" class="brick-btn p-3 text-gray-400 hover:text-white hover:bg-[#00C300] transition-colors flex items-center justify-center" title="Line">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                </a>
                
                <!-- Email -->
                <a href="mailto:newthingsinthelittlelight@gmail.com" class="brick-btn p-3 text-gray-400 hover:text-white hover:bg-[#EA4335] transition-colors flex items-center justify-center" title="Email">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                </a>
            </div>

            <p class="text-xs text-gray-400 font-bold tracking-widest uppercase pixel-font text-lg">è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹ Â© 2024</p>
        </footer>
    </div>

    <!-- 2. å·¥ä½œå€è¦–åœ– -->
    <main id="view-workspace" class="hidden flex-1 w-full max-w-7xl mx-auto flex flex-col h-full overflow-hidden bg-transparent">
        <div id="workspace-tabs" class="flex border-b-4 border-[#ccc] shrink-0 bg-[#F4F6F8] z-20 px-4 pt-2 gap-1">
            <button id="tab-reader" class="workspace-tab-btn active" onclick="window.switchWorkspaceTab('reader')">
                <span class="text-xl mr-1 pixel-font">Read</span> <span id="tab-reader-text">é–±è®€ç¶“æ–‡</span>
            </button>
            <button id="tab-journal" class="workspace-tab-btn" onclick="window.switchWorkspaceTab('journal')">
                <span class="text-xl mr-1 pixel-font">Write</span> <span id="tab-journal-text">éˆä¿®ç­†è¨˜</span>
            </button>
        </div>

        <div class="flex-1 flex overflow-hidden relative p-0 md:p-4 gap-4">
            <!-- Left: Reader -->
            <section id="section-reader" class="w-full lg:w-1/2 flex flex-col brick-card rounded-none md:rounded-lg transition-all duration-300 absolute lg:relative inset-0 z-10 lg:z-auto shadow-none md:shadow-[0_6px_0_#E0E0E0,0_12px_10px_rgba(0,0,0,0.1)]">
                <div id="devotion-tabs" class="hidden grid grid-cols-4 gap-2 p-4 bg-[#F9F9F9] border-b-2 border-gray-100 shrink-0"></div>
                <div id="reader-universal-header" class="px-5 py-4 border-b-2 border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                         <button id="btn-header-back" onclick="window.goBackToMainBooks()" class="hidden shrink-0 w-8 h-8 rounded bg-[#333] text-white flex items-center justify-center text-xs hover:bg-black transition-colors shadow-[0_3px_0_#000] active:shadow-none active:translate-y-1">â—€</button>
                         <div class="min-w-0">
                             <div class="flex items-center gap-2">
                                <span id="header-subtitle" class="text-[12px] font-bold text-gray-400 uppercase tracking-widest block pixel-font">Scripture</span>
                                <button id="btn-copy-progress" onclick="window.copyDevotionProgress()" class="hidden text-[10px] bg-[#333] text-white rounded px-2 py-0.5 hover:bg-black transition-colors leading-tight tracking-wider" title="è¤‡è£½ä»Šæ—¥é€²åº¦">è¤‡è£½é€²åº¦</button>
                             </div>
                             <h2 id="header-main-title" class="text-lg text-[#333] font-bold truncate">Bible Reading</h2>
                         </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <form class="relative" id="search-box" onsubmit="event.preventDefault(); window.performSearch();">
                             <input type="search" id="inline-search" placeholder="Search..." class="pl-3 pr-8 py-1.5 rounded bg-gray-50 text-xs w-28 focus:w-48 transition-all outline-none border-2 border-gray-200 focus:border-[#0055BF]">
                             <button type="button" onclick="window.performSearch()" class="absolute right-2 top-2 z-10 text-gray-400"><svg class="w-4 h-4" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                         </form>
                         <button id="btn-copy-verses" onclick="window.copySelectedVerses()" class="hidden w-9 h-9 flex items-center justify-center rounded bg-[#FFD500] text-[#333] border-none shadow-[0_3px_0_#ccaa00] active:shadow-none active:translate-y-1 transition-all">
                            <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                         </button>
                    </div>
                </div>
                <div id="reader-content-wrapper" class="flex-1 overflow-y-auto relative bg-white">
                    <div id="view-bible-books" class="hidden flex-col min-h-full p-6">
                         <div class="flex gap-4 mb-6 shrink-0">
                            <button onclick="window.renderMainBooks('old')" id="btn-old" class="brick-btn btn-yellow flex-1 py-3 text-sm">èˆŠç´„ Old Testament</button>
                            <button onclick="window.renderMainBooks('new')" id="btn-new" class="brick-btn flex-1 py-3 text-sm border-2 border-gray-100">æ–°ç´„ New Testament</button>
                        </div>
                        <div id="main-book-list" class="grid grid-cols-2 sm:grid-cols-4 gap-3 content-start pb-10"></div>
                    </div>
                    <div id="view-bible-chapters" class="hidden flex-col min-h-full p-6">
                        <h3 id="main-chapter-title" class="text-3xl font-bold text-[#333] mb-8 border-b-4 border-[#FFD500] w-fit pb-1 px-2"></h3>
                        <div id="main-chapter-grid" class="grid grid-cols-5 sm:grid-cols-6 gap-3 pb-10"></div>
                    </div>
                    <div id="view-bible-text" class="hidden min-h-full p-6 md:p-10 bible-text text-gray-800"></div>
                </div>
            </section>

            <!-- Right: Journal -->
            <section id="section-journal" class="w-full lg:w-1/2 flex flex-col brick-card rounded-none md:rounded-lg transition-all duration-300 absolute lg:relative inset-0 opacity-0 lg:opacity-100 pointer-events-none lg:pointer-events-auto z-0 lg:z-auto shadow-none md:shadow-[0_6px_0_#E0E0E0,0_12px_10px_rgba(0,0,0,0.1)]">
                <div class="bg-gray-50 px-6 py-4 border-b-2 border-gray-100 flex gap-3 overflow-x-auto no-scrollbar items-center shrink-0">
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜€ï¸')">â˜€ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜ï¸')">â˜ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ§ï¸')">ğŸŒ§ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸ”¥')">ğŸ”¥</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ±')">ğŸŒ±</button>
                    <input type="hidden" id="note-mood">
                </div>
                <div class="flex-1 overflow-y-auto p-8 space-y-10 pb-20 relative">
                    
                    <!-- éˆä¿®ç­†è¨˜ -->
                    <div id="journal-devotion-fields" class="space-y-8">
                        <div>
                            <label class="block text-sm font-bold text-[#333] mb-2 uppercase tracking-widest pixel-font bg-[#FFD500] w-fit px-2 rounded shadow-sm">ğŸ“– Reading</label>
                            <input type="text" id="note-devotion-progress" readonly class="w-full p-3 text-sm text-[#333] font-bold" value="Loading...">
                        </div>

                        <!-- å‹•æ…‹è¼‰å…¥çš„éˆä¿®å…§å®¹ (æ–°å¢å€åŸŸ - æ•´åˆå€å¡Š) -->
                        <div id="devotion-dynamic-content" class="bg-white p-6 rounded-lg border-2 border-[#eee] shadow-[0_4px_0_rgba(0,0,0,0.05)] space-y-6">
                            <!-- Title -->
                            <div>
                                <div id="devotion-title-display" class="font-bold text-base text-[#333] leading-relaxed">Loading...</div>
                            </div>
                            <!-- Text -->
                            <div>
                                 <div id="devotion-text-display" class="text-base leading-relaxed text-[#444] whitespace-pre-wrap"></div>
                            </div>
                            <!-- Song -->
                            <div>
                                 <a id="devotion-song-link" href="#" target="_blank" class="group flex items-center gap-3 p-3 rounded-lg border-2 border-[#F4F6F8] hover:border-[#FFD500] hover:bg-[#FFFDE7] transition-all">
                                    <div class="w-8 h-8 rounded-full bg-[#eee] group-hover:bg-[#FFD500] flex items-center justify-center text-xs transition-colors">ğŸ§</div>
                                    <span id="devotion-song-title" class="font-bold text-sm text-[#555] group-hover:text-[#333]">No Song Selected</span>
                                 </a>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#0055BF] w-fit px-2 rounded shadow-sm">âœ¨ Rhema</label>
                            <textarea id="note-rhema" placeholder="è¨˜ä¸‹ä»Šå¤©æœ€è§¸å‹•ä½ çš„ç¶“æ–‡..." class="w-full min-h-[80px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#008F39] w-fit px-2 rounded shadow-sm">ğŸ“ Reflection</label>
                            <textarea id="note-reflection" placeholder="ä½ çš„çœ‹è¦‹ã€é«”æœƒï¼Œæˆ–æ˜¯å¤©çˆ¶å°ä½ èªªçš„è©±..." class="w-full min-h-[150px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#6D6E71] w-fit px-2 rounded shadow-sm">ğŸŒ± Action</label>
                            <textarea id="note-application" placeholder="å…·é«”å¯ä»¥è¡Œå‡ºä¾†çš„å°ç·´ç¿’..." class="w-full min-h-[80px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#E3000B] w-fit px-2 rounded shadow-sm">ğŸ’Œ Response</label>
                            <textarea id="note-prayer-devotion" placeholder="å¯«çµ¦ç¥çš„å›ä¿¡..." class="w-full min-h-[100px] resize-none p-3 text-lg leading-relaxed"></textarea>
                        </div>
                        <div class="pt-4">
                            <button onclick="window.saveSingleEntry('devotion')" class="brick-btn btn-blue w-full flex items-center justify-center gap-3">ğŸ’¾ å„²å­˜éˆä¿®ç­†è¨˜</button>
                        </div>
                    </div>
                    
                    <!-- éš¨ä¾¿å¯« (æ–°åŠŸèƒ½ï¼šæ”¹ç‚ºå¤šç¯‡æ¨¡å¼) -->
                    <div id="journal-freewrite-fields" class="hidden">
                        <div id="list-freewrite" class="space-y-4 mb-8"></div>
                        <div id="form-freewrite" class="space-y-8 hidden bg-white p-4 rounded-lg border-2 border-[#eee] mb-8">
                            <h3 class="font-bold text-lg text-[#FE8A18]">âœï¸ æ–°å¢/ç·¨è¼¯éš¨ç­†</h3>
                            <div>
                                <div class="mb-2 text-sm text-gray-500 font-bold flex items-center gap-2">
                                     <span class="inline-block w-3 h-3 bg-[#FE8A18] rounded-full"></span>
                                     Free Write / éš¨æ„å¡—é´‰
                                </div>
                                <!-- æ©«ç·šç­†è¨˜æœ¬é¢¨æ ¼ -->
                                <textarea id="note-freewrite" class="notebook-paper w-full min-h-[300px] leading-relaxed" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä»»ä½•å¿ƒæƒ…ã€éˆæ„Ÿæˆ–éš¨ç­†..."></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.saveListEntry('freewrite')" class="brick-btn btn-orange flex-1">å„²å­˜</button>
                                <button onclick="window.hideEntryForm('freewrite')" class="brick-btn flex-1">å–æ¶ˆ</button>
                            </div>
                        </div>
                        <button id="btn-add-freewrite" onclick="window.showEntryForm('freewrite')" class="brick-btn w-full py-4 text-[#FE8A18] border-2 border-[#FE8A18] hover:bg-[#FE8A18] hover:text-white transition-colors border-dashed flex items-center justify-center gap-2">
                            <span class="text-2xl font-black">+</span> æ–°å¢ä¸€å‰‡éš¨ç­†
                        </button>
                    </div>

                    <!-- è·Ÿç¥èŠèŠ -->
                    <div id="journal-prayer-fields" class="hidden">
                        <div id="list-prayer" class="space-y-4 mb-8"></div>
                        <div id="form-prayer" class="space-y-8 hidden bg-white p-4 rounded-lg border-2 border-[#eee] mb-8">
                            <h3 class="font-bold text-lg text-[#008F39]">âœï¸ æ–°å¢/ç·¨è¼¯ç¦±å‘Š</h3>
                            <div>
                                <label class="block text-sm font-bold text-[#333] mb-2 uppercase tracking-widest pixel-font bg-[#FFD500] w-fit px-2 rounded shadow-sm">ğŸ¯ Wish</label>
                                <textarea id="note-topic" placeholder="æƒ³è¦ä»€éº¼ï¼Ÿå¤§è†½è·Ÿç¥æ±‚..." class="w-full min-h-[60px] resize-none p-3 text-lg leading-relaxed"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#0055BF] w-fit px-2 rounded shadow-sm">ğŸ’¬ Murmur</label>
                                <textarea id="note-content" placeholder="æŠŠå¿ƒè£¡è©±éƒ½å€’å‡ºä¾†å§..." class="w-full min-h-[200px] resize-none p-3 text-lg leading-relaxed"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#008F39] w-fit px-2 rounded shadow-sm">ğŸ‘£ Tracking</label>
                                <textarea id="note-prayer-tracking" placeholder="è¨˜éŒ„ç¦±å‘Šçš„æˆå°±ã€é€²åº¦æˆ–æ‡‰å…..." class="w-full min-h-[150px] resize-none p-3 text-lg leading-relaxed"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.saveListEntry('prayer')" class="brick-btn btn-green flex-1">å„²å­˜</button>
                                <button onclick="window.hideEntryForm('prayer')" class="brick-btn flex-1">å–æ¶ˆ</button>
                            </div>
                        </div>
                        <button id="btn-add-prayer" onclick="window.showEntryForm('prayer')" class="brick-btn w-full py-4 text-[#008F39] border-2 border-[#008F39] hover:bg-[#008F39] hover:text-white transition-colors border-dashed flex items-center justify-center gap-2">
                            <span class="text-2xl font-black">+</span> æ–°å¢ä¸€å‰‡ç¦±å‘Š
                        </button>
                    </div>

                    <!-- æ„Ÿæ©æ—¥è¨˜ -->
                    <div id="journal-gratitude-fields" class="hidden">
                        <div id="list-gratitude" class="space-y-4 mb-8"></div>
                        <div id="form-gratitude" class="space-y-8 hidden bg-white p-4 rounded-lg border-2 border-[#eee] mb-8">
                            <h3 class="font-bold text-lg text-[#FFD500]">âœï¸ æ–°å¢/ç·¨è¼¯æ„Ÿæ©</h3>
                            <div>
                                <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#E3000B] w-fit px-2 rounded shadow-sm">ğŸ’– Gratitude</label>
                                <textarea id="note-thanks" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å¥½äº‹ï¼Ÿ..." class="w-full min-h-[120px] resize-none p-3 text-lg leading-relaxed"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-white mb-2 uppercase tracking-widest pixel-font bg-[#008F39] w-fit px-2 rounded shadow-sm">âœ¨ Grace</label>
                                <textarea id="note-grace" placeholder="å“ªè£¡çœ‹è¦‹ç¥çš„ä½œç‚ºï¼Ÿ..." class="w-full min-h-[120px] resize-none p-3 text-lg leading-relaxed"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.saveListEntry('gratitude')" class="brick-btn btn-yellow flex-1">å„²å­˜</button>
                                <button onclick="window.hideEntryForm('gratitude')" class="brick-btn flex-1">å–æ¶ˆ</button>
                            </div>
                        </div>
                        <button id="btn-add-gratitude" onclick="window.showEntryForm('gratitude')" class="brick-btn w-full py-4 text-[#FFD500] border-2 border-[#FFD500] hover:bg-[#FFD500] hover:text-[#333] transition-colors border-dashed flex items-center justify-center gap-2">
                            <span class="text-2xl font-black">+</span> æ–°å¢ä¸€å‰‡æ„Ÿæ©
                        </button>
                    </div>

                    <!-- å…§å¿ƒæˆ² -->
                    <div id="journal-mood-fields" class="hidden">
                        <div id="list-mood" class="space-y-4 mb-8"></div>
                        <div id="form-mood" class="space-y-8 hidden bg-white p-4 rounded-lg border-2 border-[#eee] mb-8">
                            <h3 class="font-bold text-lg text-[#E3000B]">âœï¸ æ–°å¢/ç·¨è¼¯å…§å¿ƒæˆ²</h3>
                            <div class="p-5 bg-[#FAFAFA] rounded-lg border-2 border-gray-200 border-t-4 border-gray-300">
                                <label class="block text-base font-bold text-[#333] mb-3 uppercase pixel-font">ğŸ¬ Event</label>
                                <textarea id="note-mood-event" placeholder="è¨˜éŒ„äº‹ä»¶èˆ‡æ„Ÿå—..." class="w-full bg-white border-2 border-[#ddd] rounded p-4 text-base outline-none resize-none h-28 focus:border-[#FFD500] leading-relaxed shadow-none"></textarea>
                            </div>

                            <!-- å…¨æ–¹ä½æƒ…ç·’è©å½™åº« -->
                            <div class="mt-4 mb-4">
                                <details class="group relative">
                                    <summary class="brick-btn btn-yellow w-full flex justify-between items-center cursor-pointer list-none select-none">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xl">ğŸ“–</span>
                                            <span class="tracking-widest">é–‹å•Ÿæƒ…ç·’è©å½™åº«</span>
                                        </div>
                                        <span class="transition-transform group-open:rotate-180">â–¼</span>
                                    </summary>
                                    <div class="mt-3 p-4 bg-white border-2 border-[#eee] rounded-lg h-64 overflow-y-auto custom-scrollbar shadow-inner relative z-10">
                                        <!-- æ­£å‘æƒ…ç·’ -->
                                        <div class="mb-4">
                                            <div class="emotion-group-title text-[#F57F17]">
                                                <span>ğŸŒ</span> æ­£å‘ / å¿«æ¨‚ (Positive)
                                            </div>
                                            <div id="emotion-list-pos"></div>
                                        </div>
                                        
                                        <!-- ä¸­æ€§æƒ…ç·’ -->
                                        <div class="mb-4">
                                            <div class="emotion-group-title text-[#616161]">
                                                <span>ğŸ˜</span> ä¸­æ€§ / ç‹€æ…‹ (Neutral)
                                            </div>
                                            <div id="emotion-list-neu"></div>
                                        </div>
                                        
                                        <!-- è² é¢æƒ…ç·’ -->
                                        <div>
                                            <div class="emotion-group-title text-[#D32F2F]">
                                                <span>ğŸŒ§ï¸</span> è² é¢ / å£“åŠ› (Negative)
                                            </div>
                                            <div id="emotion-list-neg"></div>
                                        </div>
                                    </div>
                                </details>
                            </div>

                            <div>
                                <label class="block text-lg font-bold text-[#333] mb-2 pixel-font">ğŸ·ï¸ Emotions</label>
                                <textarea id="note-mood-tags" placeholder="æƒ…ç·’æ¨™ç±¤..." class="w-full min-h-[60px] resize-none p-3 text-lg"></textarea>
                            </div>
                            <div class="grid grid-cols-1 gap-8">
                                <div>
                                    <label class="block text-lg font-bold text-white mb-2 pixel-font bg-[#333] w-fit px-2 rounded">ğŸ¤¥ Lie</label>
                                    <textarea id="note-mood-lie" placeholder="æˆ‘ç›¸ä¿¡äº†ä»€éº¼è¬Šè¨€..." class="w-full min-h-[50px] resize-none p-3 text-lg"></textarea>
                                </div>
                                <div>
                                    <label class="block text-lg font-bold text-[#333] mb-2 pixel-font bg-[#FFD500] w-fit px-2 rounded border border-[#ccaa00]">ğŸ‘“ Truth</label>
                                    <textarea id="note-mood-god-view" placeholder="ç¥çš„çœ¼å…‰..." class="w-full min-h-[50px] resize-none p-3 text-lg"></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="block text-lg font-bold text-white mb-2 pixel-font bg-[#0055BF] w-fit px-2 rounded">ğŸ™ Prayer</label>
                                <textarea id="note-mood-prayer" placeholder="äº¤è¨—èˆ‡é ˜å—..." class="w-full min-h-[100px] resize-none p-3 text-lg leading-relaxed"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.saveListEntry('mood')" class="brick-btn btn-red flex-1">å„²å­˜</button>
                                <button onclick="window.hideEntryForm('mood')" class="brick-btn flex-1">å–æ¶ˆ</button>
                            </div>
                        </div>
                        <button id="btn-add-mood" onclick="window.showEntryForm('mood')" class="brick-btn w-full py-4 text-[#E3000B] border-2 border-[#E3000B] hover:bg-[#E3000B] hover:text-white transition-colors border-dashed flex items-center justify-center gap-2">
                            <span class="text-2xl font-black">+</span> æ–°å¢ä¸€å‰‡å…§å¿ƒæˆ²
                        </button>
                    </div>

                    <!-- åº•éƒ¨å„²å­˜æç¤º -->
                    <div class="mt-10 p-4 bg-[#FFFDE7] border-2 border-[#FFD500] rounded-lg text-center shadow-[0_4px_0_rgba(0,0,0,0.05)]">
                        <p class="text-sm font-black text-[#F57F17] mb-3 flex items-center justify-center gap-2">
                            <span class="text-lg">âš ï¸</span> è³‡æ–™åƒ…å„²å­˜æ–¼æ­¤ç€è¦½å™¨
                        </p>
                        <button onclick="window.backupData()" class="brick-btn btn-yellow w-full py-3 text-xs flex items-center justify-center gap-2 mb-2">
                            <span class="text-lg">ğŸ’¾</span> é»æ­¤ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ (.json)
                        </button>
                        <p class="text-[10px] text-[#F9A825] font-bold">è«‹å®šæœŸå‚™ä»½ï¼Œä»¥å…æ¸…é™¤ç€è¦½å™¨ç´€éŒ„å¾Œè³‡æ–™éºå¤±</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm hidden" onclick="if(event.target===this)window.closeDeleteModal()">
        <div class="bg-white w-full max-w-xs p-6 rounded-lg shadow-[0_12px_0_#ccc] m-4 border-2 border-gray-200" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-[#333] text-center">ç¢ºèªæ‹†é™¤ç©æœ¨ï¼Ÿ</h3>
            <p class="text-sm text-gray-500 mb-6 text-center font-bold">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼</p>
            <div class="flex gap-3">
                 <button onclick="window.confirmDelete()" class="brick-btn btn-red flex-1 text-sm">æ˜¯ï¼Œæ‹†é™¤</button>
                 <button onclick="window.closeDeleteModal()" class="brick-btn flex-1 text-sm border-2 border-gray-300">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm hidden" onclick="if(event.target===this)window.closeExportModal()">
        <div class="bg-white w-full max-w-sm p-8 rounded-lg shadow-[0_12px_0_#ccc] m-4 border-2 border-gray-200" onclick="event.stopPropagation()">
            <h3 class="text-3xl font-bold mb-3 text-[#333] text-center pixel-font">DATA CENTER</h3>
            <p class="text-sm text-gray-500 mb-8 text-center font-bold">ç­†è¨˜å„²å­˜åœ¨ç€è¦½å™¨ä¸­ï¼Œè¨˜å¾—å®šæœŸå­˜æª”ï¼</p>
            <div class="grid grid-cols-1 gap-4">
                 <button onclick="window.backupData()" class="brick-btn btn-yellow w-full flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    ä¸‹è¼‰å­˜æª” (Export)
                 </button>
                 <button onclick="document.getElementById('restore-input').click()" class="brick-btn w-full flex items-center justify-center gap-3 border-2 border-gray-300 hover:border-gray-400">
                    <svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                    åŒ¯å…¥å‚™ä»½ (Import)
                 </button>
                 <input type="file" id="restore-input" class="hidden" accept=".json" onchange="window.restoreData(this)">
            </div>
            <button onclick="window.closeExportModal()" class="mt-8 text-xs text-[#333] font-bold w-full text-center hover:underline uppercase tracking-widest pixel-font">Close Window</button>
        </div>
    </div>

    <!-- Time Capsule Modal -->
    <div id="time-capsule-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm hidden" onclick="if(event.target===this)window.closeTimeCapsuleModal()">
        <!-- Added max-h and overflow-y-auto to prevent vertical overflow on small screens -->
        <div class="bg-white w-[90%] max-w-md p-5 md:p-6 rounded-lg shadow-[0_12px_0_rgba(0,0,0,0.1)] m-4 border-4 border-[#A65AD4] relative max-h-[90vh] overflow-y-auto custom-scrollbar" onclick="event.stopPropagation()">
            <div class="absolute -top-4 -right-4 w-12 h-12 bg-[#A65AD4] rounded-full flex items-center justify-center shadow-lg text-white text-xl z-20">ğŸ’Š</div>
            <h3 class="text-2xl font-bold mb-1 text-[#333] pixel-font mt-2">TIME CAPSULE</h3>
            <p class="text-xs text-gray-500 font-bold mb-6 uppercase tracking-widest">Send a message to the future</p>
            
            <div class="space-y-4">
                <!-- 1. Date Input (Moved to Top) -->
                <!-- Added overflow-hidden wrapper -->
                <div class="w-full relative overflow-hidden rounded-lg">
                    <label class="block text-sm font-bold text-[#A65AD4] mb-2 uppercase tracking-widest">Delivery Date</label>
                    <input type="date" id="capsule-target-date" class="w-1/2 p-3 border-2 border-gray-200 rounded-lg focus:border-[#A65AD4] outline-none transition-colors box-border" style="width: 50%;">
                </div>
                
                <!-- 2. Message Input -->
                <div class="w-full">
                    <label class="block text-sm font-bold text-[#A65AD4] mb-2 uppercase tracking-widest">Message to Future</label>
                    <textarea id="capsule-message" class="w-full max-w-full h-32 p-3 border-2 border-gray-200 rounded-lg focus:border-[#A65AD4] outline-none resize-none transition-colors box-border" placeholder="å¯«çµ¦æœªä¾†çš„è‡ªå·±..."></textarea>
                </div>

                <!-- 3. Mailbox Area (Brick Style) -->
                <div class="brick-mailbox-container w-full max-w-full box-border">
                    <label class="block text-sm font-bold text-[#8a40b5] mb-2 uppercase tracking-widest flex justify-between items-center relative z-10">
                        <span>Time Mailbox</span>
                        <span class="text-xs opacity-70 font-normal normal-case">Click to open</span>
                    </label>
                    <div id="capsule-list" class="max-h-40 overflow-y-auto space-y-2 pr-1 custom-scrollbar relative z-10 w-full">
                        <!-- Items will be injected here -->
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="window.saveTimeCapsule()" class="brick-btn btn-purple flex-1 py-3 text-sm flex items-center justify-center gap-2">
                    <span>ğŸš€</span> å°å­˜
                </button>
                <button onclick="window.closeTimeCapsuleModal()" class="brick-btn flex-1 py-3 text-sm border-2 border-gray-300">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
    
    <!-- Read Capsule Modal (New) -->
    <div id="read-capsule-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm hidden" onclick="if(event.target===this)document.getElementById('read-capsule-modal').classList.add('hidden')">
        <div class="bg-white w-full max-w-md p-8 rounded-lg shadow-[0_12px_0_rgba(0,0,0,0.1)] m-4 border-4 border-[#A65AD4] relative animate-bounce" onclick="event.stopPropagation()">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ“¬</div>
                <h3 class="text-2xl font-bold text-[#333] mb-2">ä¾†è‡ªéå»çš„ä¿¡</h3>
                <p class="text-sm text-gray-500 font-bold">A Message from the Past</p>
            </div>
            
            <div id="read-capsule-content" class="bg-[#F4F6F8] p-4 rounded-lg border-2 border-gray-200 text-lg leading-relaxed text-[#333] min-h-[100px] mb-6 whitespace-pre-wrap"></div>
            
            <button onclick="document.getElementById('read-capsule-modal').classList.add('hidden')" class="brick-btn btn-purple w-full py-3 text-sm">
                æ”¶ä¸‹é€™ä»½å¿ƒæ„ (Receive)
            </button>
        </div>
    </div>

    <script>
        const REMOTE_DB_URL = "https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db";
        const DEVOTIONALS_URL = "https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/devotionals.json";
        
        let sqlDb = null, sqlDbLoaded = false, SQL = null, els = {};
        let dbTable = "verses";
        let dbCols = { book: "book", chapter: "chapter", verse: "verse", text: "text" };
        let currentMode = 'home';
        let calendarDate = new Date();
        let currentEditingId = null; 
        let pendingDeleteType = null;
        let pendingDeleteId = null;
        let devotionalsData = [];

        const mannaVerses = [
            { t: "ã€Œæ•¬ç•è€¶å’Œè¯æ˜¯æ™ºæ…§çš„é–‹ç«¯ã€‚ã€", r: "â€” ç®´è¨€ 9:10" },
            { t: "ã€Œè€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚ã€", r: "â€” è©©ç¯‡ 23:1" },
            { t: "ã€Œå–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥ï¼›æ†‚å‚·çš„éˆä½¿éª¨æ¯ä¹¾ã€‚ã€", r: "â€” ç®´è¨€ 17:22" },
            { t: "ã€Œæˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚ã€", r: "â€” è…“ç«‹æ¯”æ›¸ 4:13" },
            { t: "ã€Œå‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚ã€", r: "â€” é¦¬å¤ªç¦éŸ³ 11:28" }
        ];

        const bibleBooks = {
            old: [{n:"å‰µä¸–è¨˜",abbr:"å‰µ",c:50},{n:"å‡ºåŸƒåŠè¨˜",abbr:"å‡º",c:40},{n:"åˆ©æœªè¨˜",abbr:"åˆ©",c:27},{n:"æ°‘æ•¸è¨˜",abbr:"æ°‘",c:36},{n:"ç”³å‘½è¨˜",abbr:"ç”³",c:34},{n:"ç´„æ›¸äºè¨˜",abbr:"æ›¸",c:24},{n:"å£«å¸«è¨˜",abbr:"å£«",c:21},{n:"è·¯å¾—è¨˜",abbr:"å¾—",c:4},{n:"æ’’æ¯è€³è¨˜ä¸Š",abbr:"æ’’ä¸Š",c:31},{n:"æ’’æ¯è€³è¨˜ä¸‹",abbr:"æ’’ä¸‹",c:24},{n:"åˆ—ç‹ç´€ä¸Š",abbr:"ç‹ä¸Š",c:22},{n:"åˆ—ç‹ç´€ä¸‹",abbr:"ç‹ä¸‹",c:25},{n:"æ­·ä»£å¿—ä¸Š",abbr:"ä»£ä¸Š",c:29},{n:"æ­·ä»£å¿—ä¸‹",abbr:"ä»£ä¸‹",c:36},{n:"ä»¥æ–¯æ‹‰è¨˜",abbr:"æ‹‰",c:10},{n:"å°¼å¸Œç±³è¨˜",abbr:"å°¼",c:13},{n:"ä»¥æ–¯å¸–è¨˜",abbr:"æ–¯",c:10},{n:"ç´„ä¼¯è¨˜",abbr:"ä¼¯",c:42},{n:"è©©ç¯‡",abbr:"è©©",c:150},{n:"ç®´è¨€",abbr:"ç®´",c:31},{n:"å‚³é“æ›¸",abbr:"å‚³",c:12},{n:"é›…æ­Œ",abbr:"æ­Œ",c:8},{n:"ä»¥è³½äºæ›¸",abbr:"è³½",c:66},{n:"è€¶åˆ©ç±³æ›¸",abbr:"è€¶",c:52},{n:"è€¶åˆ©ç±³å“€æ­Œ",abbr:"å“€",c:5},{n:"ä»¥è¥¿çµæ›¸",abbr:"çµ",c:48},{n:"ä½†ä»¥ç†æ›¸",abbr:"ä½†",c:12},{n:"ä½•è¥¿é˜¿æ›¸",abbr:"ä½•",c:14},{n:"ç´„ç¥æ›¸",abbr:"ç¥",c:3},{n:"é˜¿æ‘©å¸æ›¸",abbr:"æ‘©",c:9},{n:"ä¿„å·´åº•äºæ›¸",abbr:"ä¿„",c:1},{n:"ç´„æ‹¿æ›¸",abbr:"æ‹¿",c:4},{n:"å½Œè¿¦æ›¸",abbr:"å½Œ",c:7},{n:"é‚£é´»æ›¸",abbr:"é´»",c:3},{n:"å“ˆå·´è°·æ›¸",abbr:"å“ˆ",c:3},{n:"è¥¿ç•ªé›…æ›¸",abbr:"ç•ª",c:3},{n:"å“ˆè©²æ›¸",abbr:"è©²",c:2},{n:"æ’’è¿¦åˆ©äºæ›¸",abbr:"äº",c:14},{n:"ç‘ªæ‹‰åŸºæ›¸",abbr:"ç‘ª",c:4}],
            new: [{n:"é¦¬å¤ªç¦éŸ³",abbr:"å¤ª",c:28},{n:"é¦¬å¯ç¦éŸ³",abbr:"å¯",c:16},{n:"è·¯åŠ ç¦éŸ³",abbr:"è·¯",c:24},{n:"ç´„ç¿°ç¦éŸ³",abbr:"ç´„",c:21},{n:"ä½¿å¾’è¡Œå‚³",abbr:"å¾’",c:28},{n:"ç¾…é¦¬æ›¸",abbr:"ç¾…",c:16},{n:"å“¥æ—å¤šå‰æ›¸",abbr:"æ—å‰",c:16},{n:"å“¥æ—å¤šå¾Œæ›¸",abbr:"æ—å¾Œ",c:13},{n:"åŠ æ‹‰å¤ªæ›¸",abbr:"åŠ ",c:6},{n:"ä»¥å¼—æ‰€æ›¸",abbr:"å¼—",c:6},{n:"è…“ç«‹æ¯”æ›¸",abbr:"è…“",c:4},{n:"æ­Œç¾…è¥¿æ›¸",abbr:"è¥¿",c:4},{n:"å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸",abbr:"å¸–å‰",c:5},{n:"å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸",abbr:"å¸–å¾Œ",c:3},{n:"ææ‘©å¤ªå‰æ›¸",abbr:"æå‰",c:6},{n:"ææ‘©å¤ªå¾Œæ›¸",abbr:"æå¾Œ",c:4},{n:"æå¤šæ›¸",abbr:"å¤š",c:3},{n:"è…“åˆ©é–€æ›¸",abbr:"é–€",c:1},{n:"å¸Œä¼¯ä¾†æ›¸",abbr:"ä¾†",c:13},{n:"é›…å„æ›¸",abbr:"é›…",c:5},{n:"å½¼å¾—å‰æ›¸",abbr:"å½¼å‰",c:5},{n:"å½¼å¾—å¾Œæ›¸",abbr:"å½¼å¾Œ",c:3},{n:"ç´„ç¿°ä¸€æ›¸",abbr:"ç´„ä¸€",c:5},{n:"ç´„ç¿°äºŒæ›¸",abbr:"ç´„äºŒ",c:1},{n:"ç´„ç¿°ä¸‰æ›¸",abbr:"ç´„ä¸‰",c:1},{n:"çŒ¶å¤§æ›¸",abbr:"çŒ¶",c:1},{n:"å•Ÿç¤ºéŒ„",abbr:"å•Ÿ",c:22}]
        };

        const planTracks = [
            {t: "èˆŠç´„", books: bibleBooks.old},
            {t: "æ–°ç´„", books: bibleBooks.new},
            {t: "è©©ç¯‡", books: [{n:"è©©ç¯‡",abbr:"è©©",c:150}]},
            {t: "ç®´è¨€", books: [{n:"ç®´è¨€",abbr:"ç®´",c:31}]}
        ];

        const bookMap = {};
        [...bibleBooks.old, ...bibleBooks.new].forEach(b => {
            bookMap[b.abbr] = b.n;
            bookMap[b.n] = b.n;
            bookMap[b.n.replace("æ›¸","")] = b.n;
        });

        const mockVerses = {
            "å‰µä¸–è¨˜": {1: {1: "èµ·åˆï¼Œç¥å‰µé€ å¤©åœ°ã€‚", 2: "åœ°æ˜¯ç©ºè™›æ··æ²Œï¼Œæ·µé¢é»‘æš—ï¼›ç¥çš„éˆé‹è¡Œåœ¨æ°´é¢ä¸Šã€‚", 3: "ç¥èªªï¼šã€Œè¦æœ‰å…‰ã€ï¼Œå°±æœ‰äº†å…‰ã€‚"}},
            "é¦¬å¤ªç¦éŸ³": {1: {1: "äºä¼¯æ‹‰ç½•çš„å¾Œè£”ï¼Œå¤§è¡›çš„å­å­«ï¼Œè€¶ç©ŒåŸºç£çš„å®¶è­œã€‚", 18: "è€¶ç©ŒåŸºç£é™ç”Ÿçš„äº‹è¨˜åœ¨ä¸‹é¢ï¼šä»–æ¯è¦ªé¦¬åˆ©äºå·²ç¶“è¨±é…äº†ç´„ç‘Ÿï¼Œé‚„æ²’æœ‰è¿å¨¶ï¼Œé¦¬åˆ©äºå°±å¾è–éˆæ‡·äº†å­•ã€‚"}},
            "è©©ç¯‡": {1: {1: "ä¸å¾æƒ¡äººçš„è¨ˆè¬€ï¼Œä¸ç«™ç½ªäººçš„é“è·¯ï¼Œä¸åè¤»æ…¢äººçš„åº§ä½ã€‚", 2: "æƒŸå–œæ„›è€¶å’Œè¯çš„å¾‹æ³•ï¼Œæ™å¤œæ€æƒ³ï¼Œé€™äººä¾¿ç‚ºæœ‰ç¦ï¼"}},
            "ç®´è¨€": {1: {7: "æ•¬ç•è€¶å’Œè¯æ˜¯çŸ¥è­˜çš„é–‹ç«¯ï¼›æ„šå¦„äººè—è¦–æ™ºæ…§å’Œè¨“èª¨ã€‚"}}
        };

        // æƒ…ç·’è©å½™è³‡æ–™åº«
        const emotionData = {
            pos: ["å¿«æ¨‚", "èˆˆå¥®", "æ»¿è¶³", "è‡ªä¿¡", "é©•å‚²", "æ¨‚è§€", "æ„Ÿæ¿€", "è¢«æ„›", "å®‰å…¨", "æ”¾é¬†", "æœŸå¾…", "ç†±æƒ…", "å‹‡æ•¢", "é‡‹æ”¾", "æ„‰æ‚…", "æ•¬ç•", "è¦ªå¯†", "å……æ»¿å¸Œæœ›", "å¹³éœ", "è‡ªåœ¨", "æ„Ÿå‹•", "æº«æš–", "å……æ»¿æ´»åŠ›", "è¢«æ¥ç´", "è¢«ç†è§£", "æœ‰åƒ¹å€¼", "æ„Ÿæ©", "å–œæ‚…", "æŒ¯å¥®", "è¸å¯¦", "æ¸…çˆ½", "ç”œèœœ", "å¹¸ç¦", "å—å¯µè‹¥é©š", "æœ‰æˆå°±æ„Ÿ", "å—é¼“èˆ", "è¢«æ”¯æŒ"],
            neu: ["å¹³éœ", "å°ˆæ³¨", "å¥½å¥‡", "é©šè¨", "å›°æƒ‘", "çŒ¶è±«", "æ²‰æ€", "éº»æœ¨", "ç–²æ†Š", "å¿™ç¢Œ", "å†·éœ", "è¤‡é›œ", "æ”¾ç©º", "ç„¡èŠ", "æ·¡å®š", "éš¨ç·£", "è§€å¯Ÿä¸­", "ä¸ç¢ºå®š", "çŸ›ç›¾", "æ¸…é†’", "ææƒš", "è¢«å‹•", "ç­‰å¾…", "å¹³æ·¡", "ç„¡æ„Ÿ", "æ„å¤–", "æƒ³ç¡", "ç©ºç™½", "å®‰éœ"],
            neg: ["æ‚²å‚·", "æ²®å–ª", "å¤±æœ›", "å­¤å–®", "çµ•æœ›", "ç„¡åŠ©", "å—å‚·", "éºæ†¾", "å…§ç–š", "ç¾æ„§", "æ†¤æ€’", "ç…©èº", "å«‰å¦’", "å­æƒ¡", "ææ‡¼", "ç„¦æ…®", "ç·Šå¼µ", "å£“åŠ›", "é©šæ", "ä¸å®‰", "å§”å±ˆ", "å¾Œæ‚”", "ç©ºè™›", "è¿·æƒ˜", "å¿ƒç¢", "ç—›è‹¦", "ç–²æ†Šä¸å ª", "å´©æ½°", "æ‡·ç–‘", "è‡ªå‘", "å°·å°¬", "è¢«èƒŒå›", "ç„¡åŠ›", "çª’æ¯", "æ†¤æ¨", "ç–é›¢", "æŒ«æŠ˜", "é©šåš‡", "æ‡Šæƒ±", "æ²ˆé‡", "è¢«å¿½è¦–", "ç„¡å¥ˆ"]
        };

        async function initApp() {
            els = {
                viewHome: document.getElementById('view-home'),
                viewWorkspace: document.getElementById('view-workspace'),
                mainHeader: document.getElementById('main-header'),
                readerTitle: document.getElementById('header-main-title'),
                readerSubtitle: document.getElementById('header-subtitle'),
                backBtn: document.getElementById('btn-header-back'),
                copyBtn: document.getElementById('btn-copy-verses'),
                btnCopyProgress: document.getElementById('btn-copy-progress'),
                headerTitle: document.getElementById('header-title'),
                datePicker: document.getElementById('date-picker'),
                homeDatePicker: document.getElementById('home-date-picker'),
                inlineSearch: document.getElementById('inline-search'),
                calendarGrid: document.getElementById('calendar-grid'),
                calendarMonthLabel: document.getElementById('calendar-month-label'),
                streakCount: document.getElementById('streak-count'),
                streakBadge: document.getElementById('streak-badge'),
                viewBooks: document.getElementById('view-bible-books'),
                viewChapters: document.getElementById('view-bible-chapters'),
                viewText: document.getElementById('view-bible-text'),
                // New elements
                devotionTitle: document.getElementById('devotion-title-display'),
                devotionText: document.getElementById('devotion-text-display'),
                devotionSongTitle: document.getElementById('devotion-song-title'),
                devotionSongLink: document.getElementById('devotion-song-link')
            };

            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            
            // 1. Fetch Devotionals Data
            try {
                const res = await fetch(DEVOTIONALS_URL);
                if(res.ok) {
                    devotionalsData = await res.json();
                    if(els.devotionTitle) els.devotionTitle.innerText = "è³‡æ–™è¼‰å…¥æˆåŠŸ...";
                } else {
                    console.warn("Failed to fetch devotionals");
                    if(els.devotionTitle) els.devotionTitle.innerText = "è³‡æ–™åº«é€£ç·šå¤±æ•— (404)";
                }
            } catch(e) {
                console.warn("Devotional fetch error", e);
                if(els.devotionTitle) els.devotionTitle.innerText = "è³‡æ–™åº«é€£ç·šéŒ¯èª¤";
            }

            // 2. Load SQLite
            try {
                if (typeof window.initSqlJs === 'function') {
                    SQL = await window.initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
                    const res = await fetch(REMOTE_DB_URL);
                    if (!res.ok) throw new Error("Remote DB Fetch Failed");
                    const buffer = await res.arrayBuffer();
                    sqlDb = new SQL.Database(new Uint8Array(buffer));
                    sqlDbLoaded = true;
                    window.detectTableStructure();
                    // FIX: Add null check
                    if (els.inlineSearch) els.inlineSearch.placeholder = "ğŸ” æœå°‹ç¶“æ–‡...";
                } else { throw new Error("SQL.js not loaded"); }
            } catch(e) {
                console.warn("DB Load Failed", e);
                // FIX: Add null check
                if (els.inlineSearch) els.inlineSearch.placeholder = "âš ï¸ é€£ç·šå¤±æ•—";
            }
            
            // 3. Render Emotion Chart
            window.renderEmotionChart();

            // 4. Check Time Capsules
            window.checkTimeCapsules();

            // 5. Initial Render
            window.handleDateChange(todayKey);
            window.setAppIcon();
            window.renderCalendar();
            window.calculateStreak();
        }

        window.renderEmotionChart = function() {
            const listPos = document.getElementById('emotion-list-pos');
            const listNeu = document.getElementById('emotion-list-neu');
            const listNeg = document.getElementById('emotion-list-neg');

            if(listPos) listPos.innerHTML = emotionData.pos.map(t => `<span class="emotion-chip chip-pos" onclick="window.addMoodTag('${t}')">${t}</span>`).join('');
            if(listNeu) listNeu.innerHTML = emotionData.neu.map(t => `<span class="emotion-chip chip-neu" onclick="window.addMoodTag('${t}')">${t}</span>`).join('');
            if(listNeg) listNeg.innerHTML = emotionData.neg.map(t => `<span class="emotion-chip chip-neg" onclick="window.addMoodTag('${t}')">${t}</span>`).join('');
        }

        window.addMoodTag = function(tag) {
            const textarea = document.getElementById('note-mood-tags');
            if (textarea) {
                const currentVal = textarea.value.trim();
                if (currentVal.length > 0) {
                    // Check if tag already exists to avoid duplicates (optional but good UX)
                    if (!currentVal.includes(tag)) {
                        textarea.value = currentVal + ", " + tag;
                    }
                } else {
                    textarea.value = tag;
                }
                // Trigger input event to save to local storage
                textarea.dispatchEvent(new Event('input'));
            }
        }

        // å¤šç¯‡ç­†è¨˜é‚è¼¯
        const journalFields = {
            'prayer': ['note-topic', 'note-content', 'note-prayer-tracking'],
            'gratitude': ['note-thanks', 'note-grace'],
            'mood': ['note-mood-event', 'note-mood-tags', 'note-mood-lie', 'note-mood-god-view', 'note-mood-prayer'],
            'freewrite': ['note-freewrite']
        };

        window.getJournalEntries = function(type) {
            const dateKey = els.datePicker.value;
            const listKey = `${dateKey}-journal-${type}-entries`;
            let entries = [];
            
            try {
                const stored = localStorage.getItem(listKey);
                if (stored) entries = JSON.parse(stored);
            } catch(e) { console.error("Parse error", e); }

            if (entries.length === 0 && journalFields[type]) {
                const fields = journalFields[type];
                let hasLegacyData = false;
                let legacyEntry = { id: Date.now() };
                fields.forEach(f => {
                    const val = localStorage.getItem(`${dateKey}-${f}`);
                    if (val) { hasLegacyData = true; legacyEntry[f] = val; }
                });
                if (hasLegacyData) { entries.push(legacyEntry); localStorage.setItem(listKey, JSON.stringify(entries)); }
            }
            return entries;
        }

        window.renderJournalList = function(type) {
            const listEl = document.getElementById(`list-${type}`);
            if(!listEl) return;
            const entries = window.getJournalEntries(type);
            listEl.innerHTML = '';
            if (entries.length === 0) {
                listEl.innerHTML = `<div class="text-center text-gray-400 py-4 font-bold">é‚„æ²’æœ‰ç´€éŒ„ï¼Œæ–°å¢ä¸€å‰‡å§ï¼</div>`;
            } else {
                entries.forEach((entry, index) => {
                    let title = "", preview = "";
                    if (type === 'prayer') { title = entry['note-topic'] || "æœªå‘½åç¦±å‘Š"; preview = entry['note-content'] || "ç„¡å…§å®¹"; }
                    else if (type === 'gratitude') { title = entry['note-thanks'] || "æ„Ÿæ©äº‹é …"; preview = entry['note-grace'] || ""; }
                    else if (type === 'mood') { title = entry['note-mood-event'] || "å¿ƒæƒ…äº‹ä»¶"; preview = entry['note-mood-tags'] || ""; }
                    else if (type === 'freewrite') { title = "éš¨ç­†è¨˜éŒ„"; preview = entry['note-freewrite'] || "ç„¡å…§å®¹"; }

                    let colorClass = 'list-brick-yellow';
                    if (type === 'prayer') colorClass = 'list-brick-green';
                    else if (type === 'mood') colorClass = 'list-brick-red';
                    else if (type === 'freewrite') colorClass = 'list-brick-orange';

                    listEl.innerHTML += `
                        <div class="list-brick ${colorClass}" onclick="window.editListEntry('${type}', ${entry.id})">
                            <div class="list-brick-content pr-8">
                                <div class="list-brick-title">${title || (index + 1) + '. ç„¡æ¨™é¡Œ'}</div>
                                <div class="list-brick-preview">${preview}</div>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); window.requestDelete('${type}', ${entry.id})">ğŸ—‘ï¸</button>
                        </div>
                    `;
                });
            }
        }

        window.editListEntry = function(type, id) {
            window.showEntryForm(type, id);
        }

        window.requestDelete = function(type, id) { pendingDeleteType = type; pendingDeleteId = id; document.getElementById('delete-confirm-modal').classList.remove('hidden'); }
        window.closeDeleteModal = function() { document.getElementById('delete-confirm-modal').classList.add('hidden'); pendingDeleteType = null; pendingDeleteId = null; }
        window.confirmDelete = function() {
            if (!pendingDeleteType || !pendingDeleteId) return;
            const dateKey = els.datePicker.value;
            const listKey = `${dateKey}-journal-${pendingDeleteType}-entries`;
            let entries = window.getJournalEntries(pendingDeleteType);
            const newEntries = entries.filter(e => e.id !== pendingDeleteId);
            localStorage.setItem(listKey, JSON.stringify(newEntries));
            window.renderJournalList(pendingDeleteType);
            window.renderCalendar();
            window.closeDeleteModal();
        }

        window.showEntryForm = function(type, entryId = null) {
            const f = document.getElementById(`form-${type}`);
            const l = document.getElementById(`list-${type}`);
            const b = document.getElementById(`btn-add-${type}`);
            
            // Safe guard against null elements
            if(l) l.classList.add('hidden');
            if(b) b.classList.add('hidden');
            if(f) f.classList.remove('hidden');
            
            currentEditingId = entryId;
            const fields = journalFields[type];
            if (entryId) {
                const entries = window.getJournalEntries(type);
                const entry = entries.find(e => e.id === entryId);
                if (entry) { fields.forEach(f => { const el = document.getElementById(f); if(el) el.value = entry[f] || ""; }); }
            } else {
                fields.forEach(f => { const el = document.getElementById(f); if(el) el.value = ""; });
            }
        }

        window.hideEntryForm = function(type) {
            const f = document.getElementById(`form-${type}`);
            const l = document.getElementById(`list-${type}`);
            const b = document.getElementById(`btn-add-${type}`);
            
            // Safe guard against null elements
            if(f) f.classList.add('hidden');
            if(l) l.classList.remove('hidden');
            if(b) b.classList.remove('hidden');
            currentEditingId = null;
        }

        window.saveListEntry = function(type) {
            const dateKey = els.datePicker.value;
            const listKey = `${dateKey}-journal-${type}-entries`;
            let entries = window.getJournalEntries(type);
            const fields = journalFields[type];
            const newData = { id: currentEditingId || Date.now() };
            fields.forEach(f => { const el = document.getElementById(f); if(el) newData[f] = el.value; });
            if (currentEditingId) { const idx = entries.findIndex(e => e.id === currentEditingId); if (idx !== -1) entries[idx] = { ...entries[idx], ...newData }; } 
            else { entries.push(newData); }
            localStorage.setItem(listKey, JSON.stringify(entries));
            window.hideEntryForm(type);
            window.renderJournalList(type);
            window.renderCalendar();
        }

        window.saveSingleEntry = function(type) {
            const btn = event.target; const originalText = btn.innerText;
            btn.innerText = "å·²å„²å­˜ï¼"; setTimeout(() => btn.innerText = originalText, 1000);
            window.renderCalendar();
        }

        window.switchMode = function(m) {
            currentMode = m;
            if (els.viewHome) els.viewHome.classList.toggle('hidden', m !== 'home');
            if (els.viewWorkspace) els.viewWorkspace.classList.toggle('hidden', m === 'home');
            if (els.mainHeader) els.mainHeader.classList.toggle('hidden', m === 'home');
            
            const isDevotion = m === 'devotion';
            const isPureJournal = ['journal-prayer','journal-gratitude','journal-mood','journal-freewrite'].includes(m);
            const isBible = m === 'bible';

            const tabEl = document.getElementById('workspace-tabs');
            if (tabEl) tabEl.classList.toggle('hidden', !isDevotion);
            
            const devTabEl = document.getElementById('devotion-tabs');
            if (devTabEl) devTabEl.classList.toggle('hidden', !isDevotion);
            
            const searchBoxEl = document.getElementById('search-box');
            if (searchBoxEl) searchBoxEl.classList.toggle('invisible', !isBible); 

            ['journal-devotion-fields', 'journal-prayer-fields', 'journal-gratitude-fields', 'journal-mood-fields', 'journal-freewrite-fields']
                .forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden');
                });

            const readerSec = document.getElementById('section-reader');
            const journalSec = document.getElementById('section-journal');
            if(readerSec) {
                readerSec.classList.remove('hidden', 'lg:w-1/2'); 
                readerSec.classList.add('w-full');
            }
            if(journalSec) {
                journalSec.classList.remove('hidden', 'lg:w-1/2');
                journalSec.classList.add('w-full');
            }

            if(els.backBtn) els.backBtn.classList.add('hidden'); 
            if(els.copyBtn) els.copyBtn.classList.add('hidden');
            if(els.btnCopyProgress) els.btnCopyProgress.classList.toggle('hidden', !isDevotion);

            if (isDevotion) {
                if(readerSec) { readerSec.classList.remove('w-full'); readerSec.classList.add('lg:w-1/2'); }
                if(journalSec) { journalSec.classList.remove('w-full'); journalSec.classList.add('lg:w-1/2'); }
                const devFields = document.getElementById('journal-devotion-fields');
                if(devFields) devFields.classList.remove('hidden');
                
                if(els.headerTitle) els.headerTitle.innerText = "Daily Devotion"; 
                if(els.readerTitle) els.readerTitle.innerText = "Daily Devotion"; 
                if(els.readerSubtitle) els.readerSubtitle.innerText = "Reading Plan";
                window.updateDevotionUI(); 
                window.switchWorkspaceTab('reader'); 
            } else if (isBible) {
                if(journalSec) journalSec.classList.add('hidden'); 
                if(els.headerTitle) els.headerTitle.innerText = "Bible Reading"; 
                if(els.readerTitle) els.readerTitle.innerText = "Bible Reading"; 
                if(els.readerSubtitle) els.readerSubtitle.innerText = "Select Book";
                window.renderMainBooks('old'); window.goBackToMainBooks(); window.switchWorkspaceTab('reader'); 
            } else if (isPureJournal) {
                if(readerSec) readerSec.classList.add('hidden'); 
                const map = {'journal-prayer':'Prayer Journal','journal-gratitude':'Gratitude','journal-mood':'Mood Diary', 'journal-freewrite': 'Free Write'};
                const fieldMap = {'journal-prayer':'journal-prayer-fields','journal-gratitude':'journal-gratitude-fields','journal-mood':'journal-mood-fields', 'journal-freewrite':'journal-freewrite-fields'};
                if(els.headerTitle) els.headerTitle.innerText = map[m];
                const targetField = document.getElementById(fieldMap[m]);
                if(targetField) targetField.classList.remove('hidden');
                window.switchWorkspaceTab('journal'); 
            }
        }

        window.handleDateChange = function(val) {
            calendarDate = new Date(val);
            if(els.datePicker) els.datePicker.value = val;
            if(els.homeDatePicker) els.homeDatePicker.value = val;
            
            // --- å„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­çš„è®€ç¶“èˆ‡é‡‘å¥ (è‹¥æœ‰) ---
            // é€™è£¡çš„é‚è¼¯æ˜¯ï¼šå…ˆå–å¾—ç•¶å¤©çš„ devotionï¼Œå¦‚æœæœ‰çš„è©±ï¼Œå°±ç”¨å®ƒçš„ manna/reading è¦†è“‹é è¨­å€¼
            
            let todayDevotional = null;
            if (Array.isArray(devotionalsData) && devotionalsData.length > 0) {
                 const seed = parseInt(val.replace(/-/g, ''));
                 const index = seed % devotionalsData.length;
                 todayDevotional = devotionalsData[index];
            }

            // æ›´æ–°ä»Šæ—¥å—å“ª (å¦‚æœ DB æœ‰)
            if (todayDevotional && (todayDevotional.manna || todayDevotional.verse)) {
                let dbManna = todayDevotional.manna || todayDevotional.verse;
                document.getElementById('manna-text').innerText = dbManna;
                document.getElementById('manna-ref').innerText = ""; 
            } else {
                // å›é€€åˆ°é è¨­æ¸…å–®
                const daySeed = val.split('-').reduce((a,b)=>a+parseInt(b), 0);
                if (typeof mannaVerses !== 'undefined') {
                    const m = mannaVerses[daySeed % mannaVerses.length];
                    document.getElementById('manna-text').innerText = m.t;
                    document.getElementById('manna-ref').innerText = m.r;
                }
            }

            // Update Devotional Data Fields
            if (els.devotionTitle && els.devotionText) {
                if (todayDevotional) {
                    // Title
                    els.devotionTitle.innerText = todayDevotional.title || todayDevotional.Title || "ä»Šæ—¥ä¸»é¡Œ";
                    
                    // Text / Content (Handle Array & HTML)
                    let content = todayDevotional.text || todayDevotional.Text || todayDevotional.content || todayDevotional.Content || "ä»Šæ—¥å…§å®¹";
                    if (Array.isArray(content)) {
                        content = content.join('<br><br>');
                    }
                    if (typeof content === 'string' && !content.includes('<') && content.includes('\n')) {
                         content = content.replace(/\n/g, '<br>');
                    }
                    els.devotionText.innerHTML = content;

                    // Song
                    let songTitle = todayDevotional.song || todayDevotional.Song;
                    let songLink = todayDevotional.link || todayDevotional.Link;

                    if (songTitle && songLink) {
                         els.devotionSongTitle.innerText = songTitle;
                         els.devotionSongLink.href = songLink;
                         els.devotionSongLink.classList.remove('opacity-50', 'pointer-events-none');
                    } else {
                         els.devotionSongTitle.innerText = "No song today";
                         els.devotionSongLink.href = "#";
                         els.devotionSongLink.classList.add('opacity-50', 'pointer-events-none');
                    }
                    
                    // è¦†è“‹è®€ç¶“é€²åº¦ (å¦‚æœ DB æœ‰)
                    let dbReading = todayDevotional.reading || todayDevotional.scripture;
                    if (dbReading) {
                        const readingField = document.getElementById('note-devotion-progress');
                        if (readingField) readingField.value = dbReading;
                    }

                } else {
                    els.devotionTitle.innerText = "è³‡æ–™è¼‰å…¥ä¸­æˆ–ç„¡å…§å®¹";
                    els.devotionText.innerText = "è«‹ç¨å€™...";
                    els.devotionSongTitle.innerText = "---";
                    els.devotionSongLink.href = "#";
                    els.devotionSongLink.classList.add('opacity-50', 'pointer-events-none');
                }
            }

            // 1. å–®ç¯‡æ¨¡å¼
            const singleFields = ['note-rhema', 'note-reflection', 'note-application', 'note-prayer-devotion', 'note-freewrite'];
            singleFields.forEach(f => {
                const el = document.getElementById(f);
                if(el) {
                    el.value = localStorage.getItem(`${val}-${f}`) || "";
                    el.oninput = () => { localStorage.setItem(`${val}-${f}`, el.value); };
                }
            });

            // 2. å¤šç¯‡æ¨¡å¼
            ['prayer', 'gratitude', 'mood', 'freewrite'].forEach(type => {
                // Check if elements exist before calling these functions
                if(document.getElementById(`form-${type}`)) {
                    window.hideEntryForm(type);
                    window.renderJournalList(type);
                }
            });
            
            if(currentMode === 'devotion') {
                window.updateDevotionUI(); 
                if (todayDevotional && (todayDevotional.reading || todayDevotional.scripture)) {
                     const readingField = document.getElementById('note-devotion-progress');
                     if (readingField) readingField.value = todayDevotional.reading || todayDevotional.scripture;
                }
            }
            window.renderCalendar();
        }

        window.renderCalendar = function() {
            const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
            els.calendarMonthLabel.innerText = `${y}.${m+1}`;
            els.calendarGrid.innerHTML = "";
            const startDay = new Date(y, m, 1).getDay();
            const totalDays = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<startDay; i++) els.calendarGrid.appendChild(document.createElement('div'));
            for(let i=1; i<=totalDays; i++) {
                const d = document.createElement('div');
                const key = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                d.className = "calendar-day"; d.innerText = i;
                if (key === els.datePicker.value) d.classList.add('selected-day');
                
                let hasEntry = false;
                if (localStorage.getItem(`${key}-note-rhema`) || localStorage.getItem(`${key}-note-freewrite`)) hasEntry = true;
                ['prayer', 'gratitude', 'mood', 'freewrite'].forEach(type => {
                    const list = localStorage.getItem(`${key}-journal-${type}-entries`);
                    if (list && JSON.parse(list).length > 0) hasEntry = true;
                });

                if (hasEntry) d.classList.add('has-entry');
                d.onclick = () => window.handleDateChange(key);
                els.calendarGrid.appendChild(d);
            }
        }

        window.setAppIcon = function() { const canvas = document.createElement('canvas'); canvas.width = 192; canvas.height = 192; const ctx = canvas.getContext('2d'); const baseColor = '#FFD500'; const shadowColor = '#ccaa00'; const highlightColor = '#ffe666'; ctx.fillStyle = baseColor; ctx.fillRect(0, 0, 192, 192); ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(0,192); ctx.lineTo(0,0); ctx.lineTo(192,0); ctx.stroke(); ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.moveTo(0,192); ctx.lineTo(192,192); ctx.lineTo(192,0); ctx.stroke(); const gridSize = 3; const cellSize = 192 / gridSize; const studRadius = 22; for(let row=0; row<gridSize; row++) { for(let col=0; col<gridSize; col++) { const cx = cellSize/2 + col*cellSize; const cy = cellSize/2 + row*cellSize; ctx.beginPath(); ctx.arc(cx + 4, cy + 4, studRadius, 0, Math.PI * 2); ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fill(); ctx.beginPath(); ctx.arc(cx, cy + 2, studRadius, 0, Math.PI * 2); ctx.fillStyle = shadowColor; ctx.fill(); const grad = ctx.createLinearGradient(cx - studRadius, cy - studRadius, cx + studRadius, cy + studRadius); grad.addColorStop(0, highlightColor); grad.addColorStop(1, shadowColor); ctx.beginPath(); ctx.arc(cx, cy, studRadius, 0, Math.PI * 2); ctx.fillStyle = grad; ctx.fill(); ctx.beginPath(); ctx.ellipse(cx - 8, cy - 8, 7, 4, -Math.PI / 4, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.fill(); ctx.beginPath(); ctx.arc(cx, cy, studRadius - 5, 0, Math.PI * 2); ctx.strokeStyle = 'rgba(0,0,0,0.05)'; ctx.lineWidth = 1; ctx.stroke(); }} ctx.save(); ctx.translate(24, 24); ctx.scale(6, 6); ctx.lineWidth = 5.5 / 6; ctx.strokeStyle = '#333333'; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.beginPath(); ctx.moveTo(4, 14); ctx.bezierCurveTo(4, 14, 4, 7, 12, 7); ctx.bezierCurveTo(20, 7, 20, 14, 20, 14); ctx.lineTo(20, 18); ctx.bezierCurveTo(20, 19.1, 19.1, 20, 18, 20); ctx.lineTo(6, 20); ctx.bezierCurveTo(4.9, 20, 4, 19.1, 4, 18); ctx.lineTo(4, 14); ctx.closePath(); ctx.shadowColor = "rgba(255,255,255,0.8)"; ctx.shadowBlur = 0; ctx.shadowOffsetX = 1.5; ctx.shadowOffsetY = 1.5; ctx.stroke(); ctx.shadowColor = "transparent"; ctx.stroke(); ctx.beginPath(); ctx.moveTo(4, 14); ctx.lineTo(20, 14); ctx.stroke(); ctx.beginPath(); ctx.moveTo(9, 11); ctx.bezierCurveTo(9, 11, 9.5, 10, 10.5, 10); ctx.bezierCurveTo(11.5, 10, 12, 11, 12, 11); ctx.stroke(); ctx.beginPath(); ctx.moveTo(13, 11); ctx.bezierCurveTo(13, 11, 13.5, 10, 14.5, 10); ctx.bezierCurveTo(15.5, 10, 16, 11, 16, 11); ctx.stroke(); ctx.restore(); const dataURL = canvas.toDataURL('image/png'); const existingIcons = document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]'); existingIcons.forEach(e => e.remove()); const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.type = 'image/png'; linkIcon.href = dataURL; document.head.appendChild(linkIcon); const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = dataURL; document.head.appendChild(linkApple); }
        window.detectTableStructure = function() { if(!sqlDb) return; try { const tables = sqlDb.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'"); if(tables[0] && tables[0].values.length > 0) { const names = tables[0].values.flat(); dbTable = names.includes('verses') ? 'verses' : (names.includes('bible') ? 'bible' : names[0]); } const cols = sqlDb.exec(`PRAGMA table_info(${dbTable})`); if(cols.length > 0) { const colNames = cols[0].values.map(r => r[1]); if(colNames.includes('content')) dbCols.text = 'content'; else if(colNames.includes('scripture')) dbCols.text = 'scripture'; else if(colNames.includes('text')) dbCols.text = 'text'; if(colNames.includes('book_name')) dbCols.book = 'book_name'; else if(colNames.includes('book')) dbCols.book = 'book'; if(colNames.includes('chapter_number')) dbCols.chapter = 'chapter_number'; else if(colNames.includes('chapter')) dbCols.chapter = 'chapter'; if(colNames.includes('verse_number')) dbCols.verse = 'verse_number'; else if(colNames.includes('verse')) dbCols.verse = 'verse'; } } catch(e) { console.error("Table detection failed", e); } }
        window.fetchBibleRef = async function(refInput) { const ref = refInput ? refInput.trim() : ""; if(!ref) return; els.viewBooks.classList.add('hidden'); els.viewChapters.classList.add('hidden'); els.viewText.classList.remove('hidden'); els.copyBtn.classList.remove('hidden'); els.backBtn.classList.remove('hidden'); const wrapper = document.getElementById('reader-content-wrapper'); if(wrapper) wrapper.scrollTop = 0; els.viewText.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>'; const match = ref.match(/^([\u4e00-\u9fa5]+|[a-zA-Z]+)\s*(\d+)(?::(\d+)(?:-(\d+))?)?$/); const bookKey = match ? match[1] : null; const isBookRef = bookKey && (bookMap[bookKey] || bookMap[bookKey.replace("æ›¸","")]); if (sqlDbLoaded) { if (match && isBookRef) { const book = bookMap[bookKey] || bookKey; const chapter = parseInt(match[2]); const startV = match[3] ? parseInt(match[3]) : 1; const endV = match[4] ? parseInt(match[4]) : (match[3] ? parseInt(match[3]) : 200); try { const query = `SELECT ${dbCols.chapter}, ${dbCols.verse}, ${dbCols.text} FROM ${dbTable} WHERE ${dbCols.book} = ? AND ${dbCols.chapter} = ? AND ${dbCols.verse} >= ? AND ${dbCols.verse} <= ?`; const res = sqlDb.exec(query, [book, chapter, startV, endV]); if (res.length > 0) { els.readerTitle.innerText = `${book} ${chapter}`; els.readerSubtitle.innerText = "Scripture"; els.viewText.innerHTML = res[0].values.map(v => ` <div class="verse-item mb-4" onclick="this.classList.toggle('selected'); window.updateCopyButton()"> <span class="text-xs font-bold text-white bg-[#333] mr-2 px-1 rounded-sm select-none inline-block">${v[1]}</span> <span class="text-verse leading-loose">${v[2]}</span> </div> `).join(''); return; } else { els.viewText.innerHTML = "<p class='p-8 opacity-50 text-center text-sm'>æ­¤ç« ç¯€æŸ¥ç„¡å…§å®¹ã€‚</p>"; return; } } catch(e) { console.error(e); } } else { try { els.readerTitle.innerText = `æœå°‹: "${ref}"`; els.readerSubtitle.innerText = "Search Result"; const query = `SELECT ${dbCols.book}, ${dbCols.chapter}, ${dbCols.verse}, ${dbCols.text} FROM ${dbTable} WHERE ${dbCols.text} LIKE ? LIMIT 50`; const res = sqlDb.exec(query, [`%${ref}%`]); if (res.length > 0) { const results = res[0].values; els.viewText.innerHTML = results.map(v => { const highlightedTxt = v[3].replace(new RegExp(ref, 'g'), `<span class="bg-[#FFD500] text-[#333] px-1 font-bold rounded">${ref}</span>`); return ` <div class="verse-item mb-4 p-4 border-2 border-transparent hover:border-gray-200 transition-all cursor-pointer" onclick="this.classList.toggle('selected'); window.updateCopyButton()"> <div class="flex items-center gap-2 mb-2"> <span class="text-[10px] font-bold text-white bg-[#0055BF] px-2 py-1 tracking-wider rounded">${v[0]} ${v[1]}:${v[2]}</span> </div> <span class="text-verse text-[#333] leading-relaxed block">${highlightedTxt}</span> </div> `; }).join(''); return; } else { els.viewText.innerHTML = `<div class="flex flex-col items-center justify-center py-12"><span class="text-4xl mb-4">ğŸ‘¾</span><p class="text-lg font-bold">æ‰¾ä¸åˆ°ã€Œ${ref}ã€</p></div>`; return; } } catch(e) { console.error(e); } } } if (match && isBookRef) { const book = bookMap[bookKey] || bookKey; const chapter = parseInt(match[2]); const verseData = mockVerses[book]?.[chapter]; els.readerTitle.innerText = `${book} ${chapter}`; els.readerSubtitle.innerText = "Fallback Mode"; if (verseData) { els.viewText.innerHTML = ` <div class="p-3 bg-red-50 text-red-600 rounded mb-4 text-xs font-bold border border-red-200"> âš ï¸ é ç«¯è³‡æ–™åº«æœªé€£ç·šï¼Œåƒ…é¡¯ç¤ºè©¦é–±å…§å®¹ã€‚ </div> ` + Object.keys(verseData).map(vNum => ` <div class="verse-item mb-4" onclick="this.classList.toggle('selected'); window.updateCopyButton()"> <span class="text-xs font-bold text-white bg-[#333] mr-2 px-1 rounded-sm select-none inline-block">${vNum}</span> <span class="text-verse leading-loose">${verseData[vNum]}</span> </div> `).join(''); } else { els.viewText.innerHTML = ` <div class="flex flex-col items-center justify-center py-12 text-center"> <span class="text-4xl mb-4">ğŸ”Œ</span> <p class="text-lg font-bold text-[#333]">è³‡æ–™åº«é€£ç·šä¸­æ–·</p> <p class="text-sm text-gray-500 mt-2">ç„¡æ³•è®€å– ${book} ç¬¬ ${chapter} ç« ã€‚<br>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p> </div> `; } } else { els.viewText.innerHTML = ` <div class="flex flex-col items-center justify-center py-12 text-center"> <span class="text-4xl mb-4">âš ï¸</span> <p class="text-lg font-bold text-[#333]">ç„¡æ³•åŸ·è¡Œæœå°‹</p> <p class="text-sm text-gray-500 mt-2">è³‡æ–™åº«æœªé€£ç·šï¼Œæœå°‹åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚</p> </div> `; } }
        
        window.updateDevotionUI = function() { 
            const start = new Date(calendarDate.getFullYear(), 0, 0); 
            const diff = calendarDate - start; 
            const dayOfYear = Math.floor(diff / 86400000); 
            let progressTexts = []; 
            const container = document.getElementById('devotion-tabs'); 
            
            // Fix: Check if container exists
            if (!container) {
                console.warn("Element 'devotion-tabs' not found.");
                return;
            }

            container.innerHTML = planTracks.map((track, idx) => { 
                const totalChapters = track.books.reduce((a,b)=>a+b.c, 0); 
                const chapterIdx = Math.floor((dayOfYear % totalChapters)) || 1; 
                let currentCount = 0, targetBook = track.books[0], targetChapter = 1; 
                for(let b of track.books) { 
                    if (currentCount + b.c >= chapterIdx) { 
                        targetBook = b; 
                        targetChapter = chapterIdx - currentCount; 
                        break; 
                    } 
                    currentCount += b.c; 
                } 
                const ref = `${targetBook.abbr} ${targetChapter}`; 
                progressTexts.push(ref); 
                return ` <div class="devotion-track-card ${idx===0?'active':''}" onclick="window.fetchBibleRef('${ref}'); document.querySelectorAll('.devotion-track-card').forEach(c=>c.classList.remove('active')); this.classList.add('active');"> <span class="track-tag uppercase">${track.t}</span> <span class="track-ref font-mono">${ref}</span> </div> `; 
            }).join(''); 
            
            const progressField = document.getElementById('note-devotion-progress'); 
            if(progressField) { progressField.value = progressTexts.join(' / '); } 
            
            const firstRefEl = container.querySelector('.track-ref'); 
            if(firstRefEl) { window.fetchBibleRef(firstRefEl.innerText); } 
        }
        
        // FIX: Add safety checks to prevent null reference errors and ensure toggling
        window.switchWorkspaceTab = function(t) {
            const r = document.getElementById('section-reader');
            const j = document.getElementById('section-journal');
            const tr = document.getElementById('tab-reader');
            const tj = document.getElementById('tab-journal');

            // Force refetch if elements are missing
            if (!r || !j || !tr || !tj) {
                console.warn("Retrying to fetch workspace elements...");
                // In a real scenario, we might want to wait or check why they are missing.
                // For now, we return to avoid the crash.
                return;
            }

            if (t === 'reader') {
                // Ensure correct classes are added/removed (no replace dependency)
                r.classList.remove('opacity-0', 'z-0');
                r.classList.add('opacity-100', 'z-10');
                r.style.pointerEvents = "auto";
                
                j.classList.remove('opacity-100', 'z-10');
                j.classList.add('opacity-0', 'z-0');
                j.style.pointerEvents = "none";
                
                tr.classList.add('active');
                tj.classList.remove('active');
            } else {
                j.classList.remove('opacity-0', 'z-0');
                j.classList.add('opacity-100', 'z-10');
                j.style.pointerEvents = "auto";
                
                r.classList.remove('opacity-100', 'z-10');
                r.classList.add('opacity-0', 'z-0');
                r.style.pointerEvents = "none";
                
                tj.classList.add('active');
                tr.classList.remove('active');
            }
        }
        
        // FIX: Update renderMainBooks to handle missing els
        window.renderMainBooks = function(t) { 
            // Fallback to fetch element if els.viewBooks is null (e.g. initial render)
            let container = els.viewBooks || document.getElementById('view-bible-books');
            
            if (!container) {
                // If still not found, try to fetch again and update global els
                container = document.getElementById('view-bible-books');
                if (container) els.viewBooks = container;
                else {
                    console.warn("Element 'view-bible-books' not found.");
                    return;
                }
            }

            container.innerHTML = `<div class="flex gap-4 mb-6 shrink-0"><button onclick="window.renderMainBooks('old')" class="brick-btn btn-yellow flex-1 text-sm">èˆŠç´„ Old Testament</button><button onclick="window.renderMainBooks('new')" class="brick-btn flex-1 text-sm border-2 border-gray-100">æ–°ç´„ New Testament</button></div>` + `<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 content-start pb-10">` + bibleBooks[t].map(b => `<button class="px-3 py-3 text-sm border-2 border-gray-100 rounded bg-white hover:bg-gray-50 text-left font-bold shadow-[0_3px_0_#ddd] active:translate-y-1 active:shadow-none transition-all" onclick='window.showMainChapters(${JSON.stringify(b)})'>${b.n}</button>`).join('') + `</div>`; 
        }
        window.showMainChapters = function(b) { 
             // Ensure elements are available
             if (!els.viewBooks) els.viewBooks = document.getElementById('view-bible-books');
             if (!els.viewChapters) els.viewChapters = document.getElementById('view-bible-chapters');
             if (!els.viewText) els.viewText = document.getElementById('view-bible-text');
             if (!els.readerTitle) els.readerTitle = document.getElementById('header-main-title');
             if (!els.readerSubtitle) els.readerSubtitle = document.getElementById('header-subtitle');
             if (!els.backBtn) els.backBtn = document.getElementById('btn-header-back');
             if (!els.copyBtn) els.copyBtn = document.getElementById('btn-copy-verses');

             if(els.viewBooks) els.viewBooks.classList.add('hidden'); 
             if(els.viewChapters) els.viewChapters.classList.remove('hidden'); 
             if(els.viewText) els.viewText.classList.add('hidden'); 
             if(els.readerTitle) els.readerTitle.innerText = b.n; 
             if(els.readerSubtitle) els.readerSubtitle.innerText = "Select Chapter"; 
             if(els.backBtn) els.backBtn.classList.remove('hidden'); 
             if(els.copyBtn) els.copyBtn.classList.add('hidden'); 
             
             const titleEl = document.getElementById('main-chapter-title');
             if(titleEl) titleEl.innerText = b.n;
             
             const gridEl = document.getElementById('main-chapter-grid');
             if(gridEl) gridEl.innerHTML = Array.from({length:b.c}, (_,i)=> ` <button class="aspect-square border-2 border-gray-100 rounded bg-white hover:bg-[#0055BF] hover:text-white flex items-center justify-center font-bold text-sm shadow-[0_3px_0_#ddd] active:translate-y-1 active:shadow-none transition-all" onclick="window.fetchBibleRef('${b.abbr}${i+1}')">${i+1}</button> `).join(''); 
        }
        window.goBackToMainBooks = function() { 
            // Fix: Re-fetch elements if they are null
            const vt = els.viewText || document.getElementById('view-bible-text');
            const vc = els.viewChapters || document.getElementById('view-bible-chapters');
            const vb = els.viewBooks || document.getElementById('view-bible-books');
            const rt = els.readerTitle || document.getElementById('header-main-title');
            const rs = els.readerSubtitle || document.getElementById('header-subtitle');
            const bb = els.backBtn || document.getElementById('btn-header-back');
            const cb = els.copyBtn || document.getElementById('btn-copy-verses');

            if (!vt || !vc || !vb) return;

            if (!vt.classList.contains('hidden')) { 
                vt.classList.add('hidden'); 
                vc.classList.add('hidden'); 
                vb.classList.remove('hidden'); 
                if(rt) rt.innerText = "Bible Reading"; 
                if(rs) rs.innerText = "Select Book"; 
                if(bb) bb.classList.add('hidden'); 
                if(cb) cb.classList.add('hidden'); 
            } else { 
                vc.classList.add('hidden'); 
                vb.classList.remove('hidden'); 
                if(rt) rt.innerText = "Bible Reading"; 
                if(rs) rs.innerText = "Select Book"; 
                if(bb) bb.classList.add('hidden'); 
            } 
        }
        
        window.openMannaChapter = function() {
            const refText = document.getElementById('manna-ref').innerText; 
            if (!refText) return;
            let cleanRef = refText.replace(/^[â€”\s]+/, '');
            if (cleanRef.includes(':')) {
                cleanRef = cleanRef.split(':')[0];
            }
            window.switchMode('bible');
            setTimeout(() => {
                window.fetchBibleRef(cleanRef);
            }, 100);
        }

        window.openTimeCapsuleModal = function() {
            document.getElementById('time-capsule-modal').classList.remove('hidden');
            window.renderCapsuleList(); // Re-render list when opening
            
            // Set default date to today for the capsule target date
            const dateInput = document.getElementById('capsule-target-date');
            if (dateInput && !dateInput.value) {
                // Use local time to get correct today's date
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
        }

        window.closeTimeCapsuleModal = function() {
            document.getElementById('time-capsule-modal').classList.add('hidden');
        }

        window.saveTimeCapsule = function() {
            const msg = document.getElementById('capsule-message').value;
            const targetDate = document.getElementById('capsule-target-date').value;
            if(!msg || !targetDate) {
                alert("è«‹å¡«å¯«å®Œæ•´å…§å®¹èˆ‡æ—¥æœŸï¼"); 
                return;
            }
            
            const capsules = JSON.parse(localStorage.getItem('time_capsules') || '[]');
            capsules.push({ 
                msg: msg, 
                targetDate: targetDate, 
                createdDate: new Date().toISOString().split('T')[0],
                id: Date.now(), 
                read: false 
            });
            localStorage.setItem('time_capsules', JSON.stringify(capsules));

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "âœ… è† å›Šå·²å°å­˜ï¼";
            
            // Re-render the list immediately to show the new item
            window.renderCapsuleList();

            setTimeout(() => {
                btn.innerText = originalText;
                // Clear inputs
                document.getElementById('capsule-message').value = "";
                document.getElementById('capsule-target-date').value = "";
                window.closeTimeCapsuleModal();
            }, 1500);
        }

        window.renderCapsuleList = function() {
            const list = document.getElementById('capsule-list');
            if(!list) return;
            const capsules = JSON.parse(localStorage.getItem('time_capsules') || '[]');
            capsules.sort((a,b) => new Date(a.targetDate) - new Date(b.targetDate)); 

            if(capsules.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">ä¿¡ç®±æ˜¯ç©ºçš„ (Empty)</div>';
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            list.innerHTML = capsules.map(c => {
                const targetDate = new Date(c.targetDate);
                targetDate.setHours(0,0,0,0);
                
                // Allow reading if today >= targetDate
                const isArrived = today >= targetDate;
                
                const statusIcon = isArrived ? (c.read ? 'ğŸ“©' : 'ğŸ“¬') : 'â³';
                const statusText = isArrived ? 'å·²é€é” (Click to Read)' : 'å°å­˜ä¸­ (Locked)';
                const bgClass = isArrived ? 'bg-purple-50 border-purple-200 text-purple-800 cursor-pointer hover:bg-purple-100' : 'bg-gray-50 border-gray-100 text-gray-400 opacity-70';
                const onClick = isArrived ? `onclick="window.readCapsule(${c.id})"` : '';

                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border-2 transition-all ${bgClass} w-full" ${onClick}>
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <span class="text-xl flex-shrink-0">${statusIcon}</span>
                            <div class="flex flex-col min-w-0 flex-1">
                                <span class="font-bold text-sm truncate">To: ${c.targetDate}</span>
                                <span class="text-[10px] opacity-70 truncate">From: ${c.createdDate}</span>
                            </div>
                        </div>
                        <span class="text-[10px] font-bold uppercase tracking-wider flex-shrink-0 ml-2">${isArrived ? 'READ' : 'LOCKED'}</span>
                    </div>
                `;
            }).join('');
        }

        window.readCapsule = function(id) {
            const capsules = JSON.parse(localStorage.getItem('time_capsules') || '[]');
            const letter = capsules.find(c => c.id === id);
            
            if (letter) {
                // Show content modal
                const contentEl = document.getElementById('read-capsule-content');
                contentEl.innerHTML = letter.msg.replace(/\n/g, '<br>');
                document.getElementById('read-capsule-modal').classList.remove('hidden');
                
                // Mark as read
                if(!letter.read) {
                    letter.read = true;
                    localStorage.setItem('time_capsules', JSON.stringify(capsules));
                    window.renderCapsuleList(); // Refresh list to show open envelope icon
                }
            }
        }

        // Check for time capsules on load
        window.checkTimeCapsules = function() {
            const today = new Date().toISOString().split('T')[0];
            const capsules = JSON.parse(localStorage.getItem('time_capsules') || '[]');
            
            // Find unread capsules that have arrived (targetDate <= today)
            const letters = capsules.filter(c => c.targetDate <= today && !c.read);
            
            if (letters.length > 0) {
                // Auto-open the first unread letter found
                window.readCapsule(letters[0].id);
            }
        }

        window.copyDevotionProgress = function() { const progressText = document.getElementById('note-devotion-progress').value; if(!progressText || progressText === "Loading...") return; const t = document.createElement('textarea'); t.value = progressText; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); const btn = document.getElementById('btn-copy-progress'); const originalText = btn.innerText; const originalClass = btn.className; btn.innerText = "COPIED!"; btn.classList.replace('bg-[#333]', 'bg-[#008F39]'); setTimeout(() => { btn.innerText = originalText; btn.classList.replace('bg-[#008F39]', 'bg-[#333]'); }, 1500); }
        window.changeCalendarMonth = function(n) { calendarDate.setMonth(calendarDate.getMonth()+n); window.renderCalendar(); }
        window.goHome = function() { window.switchMode('home'); }
        window.openExportModal = function() { document.getElementById('export-modal').classList.remove('hidden'); }
        window.closeExportModal = function() { document.getElementById('export-modal').classList.add('hidden'); }
        window.selectMood = function(el, m) { document.getElementById('note-mood').value = m; document.querySelectorAll('.mood-sticker').forEach(s=>s.classList.remove('selected')); el.classList.add('selected'); }
        window.performSearch = function() { window.fetchBibleRef(els.inlineSearch.value); }
        window.updateCopyButton = function() { const count = document.querySelectorAll('.verse-item.selected').length; els.copyBtn.innerHTML = count > 0 ? `<span class='text-[10px] font-bold'>${count}</span>` : `<svg class="w-5 h-5" stroke="currentColor" fill="none" stroke-width="2.5" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`; }
        window.copySelectedVerses = function() { const sel = document.querySelectorAll('.verse-item.selected'); if (sel.length === 0) return; const text = Array.from(sel).map(v => v.innerText.trim()).join('\n'); const t = document.createElement('textarea'); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); els.copyBtn.innerHTML = "OK!"; setTimeout(() => { sel.forEach(v=>v.classList.remove('selected')); window.updateCopyButton(); }, 1000); }
        window.backupData = function() { const data = {}; for(let i=0; i<localStorage.length; i++){ const k = localStorage.key(i); if(k.includes('note-') || k.includes('-journal-') || k === 'time_capsules') data[k] = localStorage.getItem(k); } const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `manna-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        window.restoreData = function(input) { const r = new FileReader(); r.onload = e => { const data = JSON.parse(e.target.result); Object.keys(data).forEach(k => localStorage.setItem(k, data[k])); location.reload(); }; r.readAsText(input.files[0]); }
        
        window.calculateStreak = function() { 
            let s = 0, d = new Date(); 
            while(true) { 
                const k = d.toISOString().split('T')[0]; 
                let hasEntry = false;
                if (localStorage.getItem(`${k}-note-rhema`) || localStorage.getItem(`${k}-note-content`) || localStorage.getItem(`${k}-note-freewrite`)) hasEntry = true;
                ['prayer', 'gratitude', 'mood', 'freewrite'].forEach(type => {
                    const list = localStorage.getItem(`${k}-journal-${type}-entries`);
                    if (list && JSON.parse(list).length > 0) hasEntry = true;
                });

                if (hasEntry) { s++; d.setDate(d.getDate()-1); } else break; 
            } 
            if (els.streakCount) { els.streakCount.innerText = s; }
            if (els.streakBadge) { els.streakBadge.classList.toggle('hidden', s === 0); els.streakBadge.classList.add('inline-flex'); }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
