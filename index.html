<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´» | Smart Manna Life</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SQLite Support (sql.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --bg-cream: #FDFCF8;
            --m-brown: #A68C76;
            --m-brown-light: #F2EBE5;
            --m-green: #7E9B92;
            --m-text: #5E5A54;
            --m-gray: #94908A;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-cream);
            color: var(--m-text);
        }
        
        .serif-font, .bible-text, h1, h2, h3 { 
            font-family: 'Noto Serif TC', serif; 
        }

        .bible-text {
            line-height: 2.2;
            font-size: 1.25rem;
            letter-spacing: 0.05em;
        }

        /* é¸å–ç¶“æ–‡çš„æ¨£å¼ */
        .verse-item {
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        .verse-item.selected {
            background-color: #F2EBE5;
            border-left-color: #A68C76;
        }
        .verse-item:hover {
            background-color: #FAFAFA;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #D6D0C8; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .hover-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å››è»Œé€²åº¦å°å¡æ¨£å¼ */
        .devotion-track-card {
            background: white; 
            transition: all 0.2s; 
            cursor: pointer;
            border: 1px solid #EBE6DE;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            min-height: 60px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            position: relative;
            overflow: hidden;
        }
        .devotion-track-card:hover { 
            border-color: #A68C76; 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .devotion-track-card.active {
            background: #A68C76; 
            color: white;
            border-color: #A68C76;
            box-shadow: 0 4px 10px rgba(166,140,118,0.3);
        }
        
        .devotion-track-card .track-tag {
            font-size: 10px;
            font-weight: 700;
            color: #94908A;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .devotion-track-card.active .track-tag { color: rgba(255,255,255,0.8); }
        
        .devotion-track-card .track-ref {
            font-size: 13px;
            font-weight: 800;
            color: #5E5A54;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }
        .devotion-track-card.active .track-ref { color: white; }

        /* çµ±ä¸€çš„åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .workspace-tab-btn {
            flex: 1; 
            text-align: center; 
            padding: 14px; 
            font-size: 15px; 
            font-weight: bold; 
            color: #94908A;
            border-bottom: 3px solid transparent; 
            transition: all 0.2s;
            background: white;
        }
        .workspace-tab-btn:hover { background-color: #FDFCF8; color: #5E5A54; }
        .workspace-tab-btn.active { 
            color: #A68C76; 
            border-bottom-color: #A68C76; 
            background-color: #FAF9F6; 
        }

        .mood-sticker {
            font-size: 1.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; cursor: pointer; transition: all 0.2s; background-color: #fff; border: 1px solid #EBE6DE; flex-shrink: 0;
        }
        .mood-sticker.selected { background-color: #A68C76; color: white; border-color: #A68C76; transform: scale(1.1); }

        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 9999px;
            font-size: 0.8rem; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .calendar-day.has-entry { background-color: #7E9B92; color: white; }
        .calendar-day.selected-day { background-color: #A68C76; color: white; }
        .calendar-day.today { border: 2px solid #A68C76; font-weight: bold; }

        .loader {
            width: 24px; height: 24px; border: 2px solid #EBE6DE; border-bottom-color: #A68C76;
            border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative selection:bg-[#A68C76] selection:text-white">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <header id="main-header" class="bg-white/80 backdrop-blur-md border-b border-[#EBE6DE] sticky top-0 z-30 shrink-0 hidden">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 flex justify-between items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="window.goHome()">
                <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ</span>
                <h1 class="hidden md:block text-lg font-bold tracking-widest text-[#5E5A54]">æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´»</h1>
            </div>
            <div id="header-title" class="flex-1 text-center font-serif text-[#7E9B92] font-bold tracking-widest text-lg uppercase">HOME</div>
            <div class="flex items-center gap-3">
                <button onclick="window.openExportModal()" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-[#A68C76] text-white text-xs font-bold shadow-md tracking-wider mr-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                    <span>å‚™ä»½</span>
                </button>
                <input type="date" id="date-picker" class="bg-[#F9F7F5] border border-[#EBE6DE] rounded-full px-3 py-1 text-xs font-mono outline-none cursor-pointer text-[#5E5A54]" onchange="window.handleDateChange(this.value)">
            </div>
        </div>
    </header>

    <!-- 1. é¦–é è¦–åœ– -->
    <div id="view-home" class="flex-1 overflow-y-auto p-4 md:p-8 w-full max-w-5xl mx-auto flex flex-col">
        
        <div class="flex justify-between items-center mb-8 fade-in">
            <div class="flex items-center gap-3">
                 <div class="w-12 h-12 rounded-2xl bg-white border border-[#EBE6DE] flex items-center justify-center text-3xl shadow-sm">ğŸ</div>
                 <div class="flex flex-col">
                     <h1 class="text-xl md:text-2xl font-bold tracking-widest text-[#5E5A54] leading-tight">æ©Ÿæ™ºçš„å—å“ªç”Ÿæ´»</h1>
                     <span class="text-[10px] text-[#A68C76] tracking-[0.2em] font-medium uppercase italic">Smart Manna Life</span>
                 </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.openExportModal()" class="hidden sm:flex items-center gap-2 px-4 py-2 rounded-xl bg-[#A68C76] text-white text-xs font-bold shadow-sm">
                    è³‡æ–™ / å‚™ä»½
                </button>
                <div class="flex items-center bg-white rounded-xl px-3 py-2 border border-[#EBE6DE] shadow-sm">
                     <input type="date" id="home-date-picker" class="bg-transparent border-none text-sm font-medium focus:ring-0 outline-none cursor-pointer text-[#5E5A54] font-mono" onchange="window.handleDateChange(this.value)">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 fade-in">
            <!-- ä»Šæ—¥å—å“ªå¡ç‰‡ -->
            <div class="md:col-span-1 flex flex-col bg-[#F9F7F5] p-6 rounded-2xl border border-[#EBE6DE] relative overflow-hidden group cursor-pointer hover:border-[#A68C76] transition-colors" onclick="window.switchMode('devotion')">
                <div class="absolute -right-4 -top-4 text-9xl opacity-5 text-[#EBE6DE] group-hover:text-[#7E9B92] transition-colors pointer-events-none font-serif">M</div>
                <div class="inline-block px-3 py-1 rounded-full bg-[#EBF2F0] text-[#7E9B92] text-[10px] font-bold tracking-widest mb-4 self-start uppercase">Today's Manna</div>
                
                <div id="home-manna-display" class="z-10 flex-1 flex flex-col justify-center py-4">
                    <p class="serif-font text-xl md:text-2xl text-[#5E5A54] leading-relaxed mb-4" id="manna-text">è¼‰å…¥ä¸­...</p>
                    <p class="text-xs font-bold text-[#A68C76] tracking-widest" id="manna-ref"></p>
                </div>

                <div class="flex justify-between items-center mt-4 pt-4 border-t border-[#EBE6DE]/50 z-10">
                     <span class="text-[10px] text-[#94908A] font-bold">é»æ“Šé–‹å§‹ä»Šæ—¥éˆä¿®</span>
                     <span class="text-xs text-[#7E9B92] font-bold flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                        GO <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </span>
                </div>
            </div>

            <!-- éˆä¿®è¶³è·¡æœˆæ›† -->
            <div class="md:col-span-2 bg-white p-6 rounded-2xl border border-[#EBE6DE] relative overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[#5E5A54] flex items-center gap-2">â¤ï¸ ç´¯ç©ç”Ÿå‘½å€¼ <div id="streak-badge" class="hidden items-center gap-1 px-2 py-0.5 rounded-full bg-[#FFF5EB] text-[#A68C76] text-[10px] border border-[#F2EBE5]">ğŸ”¥ <span id="streak-count">0</span> å¤©</div></h3>
                    <div class="flex items-center gap-2">
                        <button onclick="window.changeCalendarMonth(-1)" class="p-1 text-[#94908A] hover:text-[#5E5A54]">â—€</button>
                        <div class="text-xs font-bold w-20 text-center" id="calendar-month-label"></div>
                        <button onclick="window.changeCalendarMonth(1)" class="p-1 text-[#94908A] hover:text-[#5E5A54]">â–¶</button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-[#A68C76] mb-2 font-bold uppercase">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">
            <div onclick="window.switchMode('bible')" class="hover-card bg-white p-8 rounded-2xl border border-[#EBE6DE] cursor-pointer flex flex-col items-center gap-4 group h-56 justify-center">
                <div class="w-16 h-16 rounded-full bg-[#F2EBE5] flex items-center justify-center text-3xl group-hover:bg-[#A68C76] group-hover:text-white transition-colors">ğŸ“–</div>
                <h3 class="text-xl font-bold text-[#5E5A54]">äººç”Ÿæ”»ç•¥æœ¬</h3>
            </div>
            <div onclick="window.switchMode('devotion')" class="hover-card bg-white p-8 rounded-2xl border border-[#EBE6DE] cursor-pointer flex flex-col items-center gap-4 group h-56 justify-center">
                <div class="w-16 h-16 rounded-full bg-[#E0E8E4] flex items-center justify-center text-3xl group-hover:bg-[#7E9B92] group-hover:text-white transition-colors">âš¡</div>
                <h3 class="text-xl font-bold text-[#5E5A54]">æ¯æ—¥å……é›»ç«™</h3>
            </div>
            <div class="grid grid-rows-3 gap-4 h-56">
                <div onclick="window.switchMode('journal-prayer')" class="hover-card bg-white px-6 rounded-xl border border-[#EBE6DE] cursor-pointer flex items-center gap-4 group">
                    <span class="text-xl bg-[#FFF5EB] w-10 h-10 rounded-full flex items-center justify-center">ğŸ’¬</span>
                    <h4 class="font-bold text-[#5E5A54]">è·Ÿç¥èŠèŠ</h4>
                </div>
                <div onclick="window.switchMode('journal-gratitude')" class="hover-card bg-white px-6 rounded-xl border border-[#EBE6DE] cursor-pointer flex items-center gap-4 group">
                    <span class="text-xl bg-[#F0F7FF] w-10 h-10 rounded-full flex items-center justify-center">ğŸ’–</span>
                    <h4 class="font-bold text-[#5E5A54]">æ„Ÿæ©æ—¥è¨˜</h4>
                </div>
                <div onclick="window.switchMode('journal-mood')" class="hover-card bg-white px-6 rounded-xl border border-[#EBE6DE] cursor-pointer flex items-center gap-4 group">
                    <span class="text-xl bg-[#FFF0F0] w-10 h-10 rounded-full flex items-center justify-center">ğŸ­</span>
                    <h4 class="font-bold text-[#5E5A54]">å…§å¿ƒæˆ²æ™‚é–“</h4>
                </div>
            </div>
        </div>

        <!-- é å°¾ï¼šç¤¾ç¾¤é€£çµèˆ‡ç‰ˆæ¬Šå®£å‘Š -->
        <footer class="mt-16 mb-8 flex flex-col items-center gap-6 fade-in">
            <div class="flex items-center gap-5">
                <a href="https://www.facebook.com/profile.php?id=100068500932557" target="_blank" class="text-[#94908A] hover:text-[#1877F2] transition-colors p-2 bg-white rounded-full border border-[#EBE6DE] shadow-sm hover:scale-110 transform duration-200"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>
                <a href="https://www.instagram.com/forever.believe.in.jesus/" target="_blank" class="text-[#94908A] hover:text-[#E4405F] transition-colors p-2 bg-white rounded-full border border-[#EBE6DE] shadow-sm hover:scale-110 transform duration-200"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>
                <a href="https://www.threads.net/@forever.believe.in.jesus" target="_blank" class="text-[#94908A] hover:text-black transition-colors p-2 bg-white rounded-full border border-[#EBE6DE] shadow-sm hover:scale-110 transform duration-200"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.27 4.15c-4.46 0-7.85 3.32-7.85 7.85 0 4.54 3.39 7.85 7.85 7.85 2.5 0 4.67-1.16 6.04-2.81l-1.92-1.46c-1 1.15-2.52 1.83-4.12 1.83-2.91 0-5.32-2.31-5.32-5.41s2.41-5.41 5.32-5.41c2.46 0 4.8 1.63 5.24 4.09l.06.35c.19 1.09.08 1.95-.31 2.34-.18.18-.45.26-.81.26-.58 0-1.17-.26-1.54-1.12l-.12-.27c-.49-1.15-.74-2.42-.74-3.69v-.39h-2.52v.4c0 1.57.34 3.09.98 4.49-.9 1.02-2.22 1.69-3.7 1.69-2.7 0-4.9-2.2-4.9-4.9 0-2.7 2.2-4.9 4.9-4.9 2.59 0 4.86 1.98 5.16 4.53.13 1.14.07 2.01-.17 2.65-.54 1.43-1.69 1.98-2.98 1.98-1.25 0-2.2-.69-2.61-1.91-.45-.87-.45-1.95-.45-2.07 0-.58.11-1.14.32-1.67.58-1.45 2.03-2.46 3.69-2.46z"/></svg></a>
                <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" class="text-[#94908A] hover:text-[#00C300] transition-colors p-2 bg-white rounded-full border border-[#EBE6DE] shadow-sm hover:scale-110 transform duration-200"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.346 5.86c-2.003-2.136-5.115-3.32-8.523-3.32C4.853 2.54 0 6.643 0 11.679c0 4.55 3.96 8.358 9.385 8.988.366.08.865.243 1.006.593.11.275.072.695.034 1.01l-.142.866c-.046.26-.216 1.022.895.536 4.39-2.316 6.134-4.22 8.35-6.84 3.12-3.696 2.37-8.127-.182-10.972z"/></svg></a>
                <a href="mailto:newthingsinthelittlelight@gmail.com" class="text-[#94908A] hover:text-[#A68C76] transition-colors p-2 bg-white rounded-full border border-[#EBE6DE] shadow-sm hover:scale-110 transform duration-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></a>
            </div>
            <div class="text-[10px] md:text-xs text-[#94908A] font-bold tracking-widest uppercase">
                ç‰ˆæ¬Šå®£å‘Š è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹
            </div>
        </footer>
    </div>

    <!-- 2. å·¥ä½œå€è¦–åœ– (å–®æ¬„åˆ†é æ¨¡å¼) -->
    <main id="view-workspace" class="hidden flex-1 w-full max-w-5xl mx-auto flex flex-col h-full overflow-hidden bg-white">
        
        <!-- å…¨åŸŸåˆ†é åˆ‡æ› -->
        <div id="workspace-tabs" class="flex border-b border-[#EBE6DE] shrink-0 bg-white z-20 shadow-sm">
            <button id="tab-reader" class="workspace-tab-btn active" onclick="window.switchWorkspaceTab('reader')">
                <span class="text-xl mr-1" id="tab-reader-icon">ğŸ“–</span> <span id="tab-reader-text">é–±è®€ç¶“æ–‡</span>
            </button>
            <button id="tab-journal" class="workspace-tab-btn" onclick="window.switchWorkspaceTab('journal')">
                <span class="text-xl mr-1" id="tab-journal-icon">âœğŸ»</span> <span id="tab-journal-text">éˆä¿®ç­†è¨˜</span>
            </button>
        </div>

        <!-- å…§å®¹å®¹å™¨ -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            
            <!-- é–±è®€å™¨å€å¡Š -->
            <section id="section-reader" class="flex-1 flex flex-col bg-white overflow-hidden absolute inset-0 z-10 transition-opacity duration-300">
                
                <!-- å››è»Œåˆ‡æ›å™¨ (åƒ… Devotion æ¨¡å¼é¡¯ç¤ºï¼Œå¼·åˆ¶ç½®é ‚) -->
                <div id="devotion-tabs" class="hidden grid grid-cols-4 gap-2 p-3 bg-white border-b border-[#EBE6DE] shrink-0 z-20 relative">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                
                <!-- æ›¸å·åº« (Bible æ¨¡å¼é¦–é ) -->
                <div id="view-bible-books" class="hidden flex-col h-full p-4 overflow-y-auto">
                     <div class="flex gap-2 mb-4 shrink-0">
                        <button onclick="window.renderBibleBooks('old')" id="btn-old" class="flex-1 py-2 text-xs font-bold rounded-lg bg-[#A68C76] text-white">èˆŠç´„</button>
                        <button onclick="window.renderBibleBooks('new')" id="btn-new" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white border text-[#A68C76]">æ–°ç´„</button>
                    </div>
                    <div id="bible-book-list" class="flex-1 grid grid-cols-3 sm:grid-cols-4 gap-3 content-start pb-20"></div>
                </div>

                <!-- ç« ç¯€é¸æ“‡ (Bible æ¨¡å¼) -->
                <div id="view-bible-chapters" class="hidden flex-col h-full p-4 overflow-y-auto">
                    <button onclick="window.goBackToBooks()" class="mb-4 text-xs font-bold text-[#94908A] flex items-center gap-1">
                        <span class="text-lg">â—€</span> è¿”å›æ›¸å·ç›®éŒ„
                    </button>
                    <h3 id="sidebar-chapter-title" class="text-xl font-bold text-[#5E5A54] mb-6 border-b pb-2"></h3>
                    <div id="sidebar-chapter-grid" class="grid grid-cols-5 sm:grid-cols-6 gap-3 content-start pb-20"></div>
                </div>

                <!-- æ¨™é¡Œèˆ‡æœå°‹æ¬„ -->
                <div class="px-4 py-3 border-b flex justify-between items-center bg-white shrink-0" id="reader-header">
                    <!-- æ¨™é¡Œå€ (æ•´åˆæŒ‰éˆ•èˆ‡æ¨™é¡Œï¼Œè§£æ±ºæ“ å£“å•é¡Œ) -->
                    <div class="flex items-center gap-3 overflow-hidden flex-1" id="reader-title-wrapper">
                        <!-- åˆ‡æ›å·ç« æŒ‰éˆ• (Bible æ¨¡å¼é¡¯ç¤º) -->
                        <button id="btn-switch-chapter" onclick="window.goBackToBooks()" class="hidden shrink-0 px-3 py-1.5 rounded-lg border border-[#A68C76] text-[#A68C76] text-xs font-bold hover:bg-[#A68C76] hover:text-white transition-colors">
                            ğŸ“š ç›®éŒ„
                        </button>
                        
                        <div class="min-w-0 flex-1">
                            <span class="text-[10px] font-bold text-[#7E9B92] uppercase tracking-widest block" id="reader-tag">SCRIPTURE</span>
                            <h2 id="reader-title" class="text-lg text-[#5E5A54] font-bold leading-tight truncate">è«‹é¸æ“‡ç¶“æ–‡</h2>
                        </div>
                    </div>
                    
                    <!-- åŠŸèƒ½æŒ‰éˆ•å€ (æœå°‹ & è¤‡è£½) -->
                    <div class="flex items-center gap-2 shrink-0">
                        <!-- æœå°‹æ¬„ (åœ¨ Devotion æ¨¡å¼ä¸‹æœƒè¢«éš±è—) -->
                        <div class="relative group" id="reader-search-container">
                            <input type="text" id="inline-search" placeholder="ç³»çµ±å•Ÿå‹•ä¸­..." disabled class="pl-3 pr-8 py-1 rounded-full bg-[#F9F7F5] border-none text-xs focus:ring-1 focus:ring-[#7E9B92] w-24 sm:w-32 transition-all focus:w-48 outline-none text-[#5E5A54] disabled:opacity-50 disabled:cursor-not-allowed" onkeyup="if(event.key === 'Enter') window.performSearch()">
                            <button onclick="window.performSearch()" class="absolute right-2 top-1.5 text-[#94908A] hover:text-[#7E9B92]"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button>
                        </div>
                        
                        <!-- è¤‡è£½æŒ‰éˆ• -->
                        <button id="btn-copy-verses" onclick="window.copySelectedVerses()" class="p-1.5 rounded-full bg-[#F9F7F5] text-[#94908A] hover:bg-[#A68C76] hover:text-white transition-colors border border-[#EBE6DE]" title="è¤‡è£½é¸å–ç¶“æ–‡">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="bible-content" class="flex-1 overflow-y-auto p-5 md:p-8 bible-text text-[#5E5A54] w-full pb-24"></div>
            </section>

            <!-- ç­†è¨˜å€å¡Š (é è¨­éš±è—) -->
            <section id="section-journal" class="flex-1 flex flex-col bg-white overflow-hidden absolute inset-0 z-0 opacity-0 pointer-events-none transition-opacity duration-300">
                <div class="bg-[#FAF9F6] px-6 py-3 border-b flex gap-3 overflow-x-auto no-scrollbar items-center shrink-0" id="active-mood-list">
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜€ï¸')">â˜€ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'â˜ï¸')">â˜ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ§ï¸')">ğŸŒ§ï¸</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸ”¥')">ğŸ”¥</button>
                    <button class="mood-sticker" onclick="window.selectMood(this, 'ğŸŒ±')">ğŸŒ±</button>
                    <input type="hidden" id="note-mood">
                </div>
                <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-24">
                    
                    <!-- éˆä¿®ç­†è¨˜æ¬„ä½ (Devotion Mode) -->
                    <div id="journal-devotion-fields" class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-[#A68C76] mb-2 uppercase tracking-widest">Rhema / é‡é»é‡‘å¥</label>
                            <textarea id="note-rhema" placeholder="ä»Šå¤©è§¸å‹•ä½ çš„è©±..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[80px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#7E9B92] mb-2 uppercase tracking-widest">Reflection / å¿ƒå¾—ç­†è¨˜</label>
                            <textarea id="note-reflection" placeholder="ä½ æœ‰ä»€éº¼çœ‹è¦‹æˆ–é«”æœƒï¼Ÿ..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#7E9B92] outline-none min-h-[150px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#A68C76] mb-2 uppercase tracking-widest">Prayer / ç¦±å‘Šäº‹é …</label>
                            <textarea id="note-prayer-devotion" placeholder="è·Ÿç¥èŠèŠä½ çš„éœ€è¦..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[100px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                        <div class="pt-6 mt-2">
                            <button onclick="window.backupData()" class="w-full py-3 rounded-xl bg-[#F9F7F5] border border-[#EBE6DE] text-[#94908A] text-xs font-bold hover:bg-[#A68C76] hover:text-white hover:border-[#A68C76] transition-all flex items-center justify-center gap-2 group">
                                <span class="group-hover:scale-110 transition-transform">ğŸ’¾</span> 
                                <span>å¯«å®Œäº†å—ï¼Ÿè¨˜å¾—åŒ¯å‡ºå‚™ä»½å–”ï¼</span>
                            </button>
                        </div>
                    </div>

                    <!-- è·Ÿç¥èŠèŠæ¬„ä½ (Chat Mode - é¹¹é­šç‰ˆ) -->
                    <div id="journal-prayer-fields" class="space-y-6 hidden">
                        <div>
                            <label class="block text-xs font-bold text-[#A68C76] mb-2 uppercase tracking-widest">ğŸ¯ è¨±é¡˜æ±  / ç¦±å‘Šäº‹é …</label>
                            <textarea id="note-topic" placeholder="æƒ³è¦ä»€éº¼ï¼Ÿå¤§è†½è·Ÿç¥æ±‚..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[60px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#7E9B92] mb-2 uppercase tracking-widest">ğŸ’¬ é¹¹é­šç¢ç¢å”¸ / ç¦±å‘Šå…§å®¹</label>
                            <textarea id="note-content" placeholder="æŠŠå¿ƒè£¡è©±éƒ½å€’å‡ºä¾†å§ (é»æ“Šç¶“æ–‡å¯åŠ å…¥)..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#7E9B92] outline-none min-h-[150px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#A68C76] mb-2 uppercase tracking-widest">ğŸŸ é¹¹é­šç¿»èº«è§€å¯Ÿ / è¿½è¹¤</label>
                            <textarea id="note-tracking" placeholder="åç­‰ç¥è¹Ÿï¼Œç´€éŒ„è®ŠåŒ–..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[80px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                        <div class="pt-6 mt-2">
                            <button onclick="window.backupData()" class="w-full py-3 rounded-xl bg-[#F9F7F5] border border-[#EBE6DE] text-[#94908A] text-xs font-bold hover:bg-[#A68C76] hover:text-white hover:border-[#A68C76] transition-all flex items-center justify-center gap-2 group">
                                <span class="group-hover:scale-110 transition-transform">ğŸ’¾</span> 
                                <span>èŠå®Œäº†å—ï¼Ÿè¨˜å¾—åŒ¯å‡ºå‚™ä»½å–”ï¼</span>
                            </button>
                        </div>
                    </div>

                    <!-- æ„Ÿæ©æ—¥è¨˜æ¬„ä½ (Gratitude Mode) -->
                    <div id="journal-gratitude-fields" class="space-y-6 hidden">
                        <div>
                            <label class="block text-xs font-bold text-[#A68C76] mb-2 uppercase tracking-widest">ğŸ’– æ„Ÿæ©äº‹é …</label>
                            <textarea id="note-thanks" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å¥½äº‹ï¼Ÿ..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[80px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#7E9B92] mb-2 uppercase tracking-widest">âœ¨ æ©å…¸è¨˜è™Ÿ</label>
                            <textarea id="note-grace" placeholder="å“ªè£¡çœ‹è¦‹ç¥çš„ä½œç‚ºï¼Ÿ..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#7E9B92] outline-none min-h-[80px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#A68C76] mb-2 uppercase tracking-widest">ğŸ“ ç”Ÿæ´»éš¨ç­†</label>
                            <textarea id="note-diary" placeholder="éš¨æ‰‹è¨˜ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[100px] resize-none p-1 text-lg"></textarea>
                        </div>
                        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                        <div class="pt-6 mt-2">
                            <button onclick="window.backupData()" class="w-full py-3 rounded-xl bg-[#F9F7F5] border border-[#EBE6DE] text-[#94908A] text-xs font-bold hover:bg-[#A68C76] hover:text-white hover:border-[#A68C76] transition-all flex items-center justify-center gap-2 group">
                                <span class="group-hover:scale-110 transition-transform">ğŸ’¾</span> 
                                <span>è¨˜éŒ„å®Œäº†å—ï¼Ÿè¨˜å¾—åŒ¯å‡ºå‚™ä»½å–”ï¼</span>
                            </button>
                        </div>
                    </div>

                    <!-- å…§å¿ƒæˆ²æ™‚é–“æ¬„ä½ (Mood Mode - æƒ…ç·’æ—¥è¨˜) -->
                    <div id="journal-mood-fields" class="space-y-6 hidden">
                         <div class="p-3 bg-[#F9F7F5] rounded-xl border border-[#EBE6DE]">
                            <label class="block text-xs font-bold text-[#5E5A54] mb-2">ğŸ¬ ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ</label>
                            <textarea id="note-mood-event" placeholder="å®¢è§€è¨˜éŒ„äº‹ä»¶..." class="w-full bg-white border border-[#EBE6DE] rounded-lg p-2 text-sm outline-none resize-none h-20 focus:border-[#A68C76]"></textarea>
                            <div class="mt-2 flex items-center gap-2">
                                <label class="text-xs font-bold text-[#94908A]">ğŸ·ï¸ æƒ…ç·’æ¨™ç±¤:</label>
                                <input type="text" id="note-mood-tag" placeholder="å¦‚: å§”å±ˆã€ç„¦æ…®" class="bg-white border border-[#EBE6DE] rounded-lg px-2 py-1 text-sm outline-none flex-1 focus:border-[#A68C76]">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-[#A68C76] mb-1">ğŸ¤¥ æˆ‘æ˜¯å¦ç›¸ä¿¡äº†ä»€éº¼è¬Šè¨€ï¼Ÿ</label>
                                <textarea id="note-mood-lie" placeholder="ex: ç¥ä¸æ„›æˆ‘ã€æˆ‘ä¸å¤ å¥½..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[50px] resize-none p-1 text-base"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[#7E9B92] mb-1">ğŸ‘“ ç¥æ€éº¼çœ‹é€™ä»¶äº‹ï¼Ÿ</label>
                                <textarea id="note-mood-god-view" placeholder="åœ¨ç¦±å‘Šä¸­é ˜å—ç¥çš„çœ¼å…‰..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#7E9B92] outline-none min-h-[50px] resize-none p-1 text-base"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[#A68C76] mb-1">ğŸ’¡ æˆ‘ç¾åœ¨æ€éº¼çœ‹ï¼Ÿ</label>
                                <textarea id="note-mood-my-view" placeholder="å°é½ŠçœŸç†å¾Œçš„æ–°çœ‹è¦‹..." class="w-full bg-transparent border-b border-dashed border-[#EBE6DE] focus:border-[#A68C76] outline-none min-h-[50px] resize-none p-1 text-base"></textarea>
                            </div>
                        </div>

                        <div class="pt-2 border-t border-[#EBE6DE]/50">
                             <label class="block text-xs font-bold text-[#5E5A54] mb-2">ğŸ™ ç¦±å‘Š & ğŸ é ˜å—</label>
                             <textarea id="note-mood-prayer" placeholder="æœ€å¾Œçš„äº¤è¨—èˆ‡é ˜å—..." class="w-full bg-transparent border border-[#EBE6DE] rounded-xl p-3 focus:border-[#A68C76] outline-none min-h-[80px] resize-none text-base"></textarea>
                        </div>
                        
                        <div class="pt-4 mt-2">
                            <button onclick="window.backupData()" class="w-full py-3 rounded-xl bg-[#F9F7F5] border border-[#EBE6DE] text-[#94908A] text-xs font-bold hover:bg-[#A68C76] hover:text-white hover:border-[#A68C76] transition-all flex items-center justify-center gap-2 group">
                                <span class="group-hover:scale-110 transition-transform">ğŸ’¾</span> 
                                <span>æ•´ç†å¥½äº†å—ï¼Ÿè¨˜å¾—åŒ¯å‡ºå‚™ä»½å–”ï¼</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Data Modal -->
    <div id="export-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden" onclick="if(event.target===this)window.closeExportModal()">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl m-4" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4">è³‡æ–™ç®¡ç†</h3>
            <div class="space-y-4">
                <div class="p-4 bg-[#F9F7F5] rounded-xl text-center mb-2">
                    <p class="text-xs text-[#94908A]">æ‚¨çš„éˆä¿®ç­†è¨˜å„²å­˜åœ¨ç€è¦½å™¨ä¸­ã€‚<br>å»ºè­°å®šæœŸå‚™ä»½ä»¥å…éºå¤±ã€‚</p>
                </div>
                <div class="flex gap-3">
                     <button onclick="window.backupData()" class="flex-1 p-4 rounded-xl border border-[#EBE6DE] hover:border-[#A68C76] bg-white transition-all text-sm font-bold text-[#5E5A54] flex flex-col items-center gap-2">
                        <span class="text-2xl">ğŸ’¾</span>
                        <span>ä¸‹è¼‰å‚™ä»½</span>
                     </button>
                     <button onclick="document.getElementById('restore-input').click()" class="flex-1 p-4 rounded-xl border border-[#EBE6DE] hover:border-[#A68C76] bg-white transition-all text-sm font-bold text-[#5E5A54] flex flex-col items-center gap-2">
                        <span class="text-2xl">ğŸ”„</span>
                        <span>é‚„åŸè³‡æ–™</span>
                     </button>
                     <input type="file" id="restore-input" class="hidden" accept=".json" onchange="window.restoreData(this)">
                </div>
            </div>
            <button onclick="window.closeExportModal()" class="mt-6 text-xs text-[#94908A] underline w-full text-center">é—œé–‰</button>
        </div>
    </div>

    <script>
        // --- 1. Global Utility Functions ---
        window.toggleVerseSelection = function(el) {
             el.classList.toggle('selected');
             window.updateCopyButton();
        }

        window.updateCopyButton = function() {
             const selectedCount = document.querySelectorAll('.verse-item.selected').length;
             const btn = document.getElementById('btn-copy-verses');
             if(btn) {
                 const originalHtml = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`;
                 btn.innerHTML = selectedCount > 0 ? `ğŸ“‹ è¤‡è£½ (${selectedCount})` : originalHtml;
                 btn.classList.toggle('bg-[#A68C76]', selectedCount > 0);
                 btn.classList.toggle('text-white', selectedCount > 0);
             }
        }

        window.copySelectedVerses = function() {
             const selected = document.querySelectorAll('.verse-item.selected');
             if (selected.length === 0) return;
             
             let textToCopy = "";
             selected.forEach(el => {
                 const ref = el.getAttribute('data-ref');
                 const text = el.getAttribute('data-text');
                 textToCopy += `${ref} ${text}\n`;
             });
             
             const ta = document.createElement('textarea');
             ta.value = textToCopy;
             document.body.appendChild(ta);
             ta.select();
             document.execCommand('copy');
             document.body.removeChild(ta);
             
             const btn = document.getElementById('btn-copy-verses');
             btn.innerHTML = "âœ… å·²è¤‡è£½";
             setTimeout(() => {
                 selected.forEach(el => el.classList.remove('selected'));
                 window.updateCopyButton();
                 btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`;
             }, 1000);
        }

        window.loadTrack = function(idx, btnEl) {
            if(btnEl) window.highlightTrack(btnEl);
            else {
                const btns = document.querySelectorAll('.devotion-track-card');
                if(btns[idx]) window.highlightTrack(btns[idx]);
            }
            const planItem = window.currentDailyPlan[idx];
            if(planItem && planItem.raw) window.fetchBibleRef(planItem.raw); 
        }

        window.highlightTrack = function(el) {
            document.querySelectorAll('.devotion-track-card').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
        
        let dbTable = "verses", dbCols = { book: "book", chapter: "chapter", verse: "verse", text: "text" };

        window.detectTableStructure = function() {
            if(!sqlDb) return;
            try {
                const tables = sqlDb.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
                if(tables[0]) {
                    const names = tables[0].values.flat();
                    dbTable = names.includes('verses') ? 'verses' : (names.includes('bible') ? 'bible' : names[0]);
                }
                const cols = sqlDb.exec(`PRAGMA table_info(${dbTable})`);
                if(cols.length > 0) {
                    const colNames = cols[0].values.map(r => r[1]);
                    if(colNames.includes('content')) dbCols.text = 'content';
                    else if(colNames.includes('scripture')) dbCols.text = 'scripture';
                    else if(colNames.includes('ç¶“æ–‡')) dbCols.text = 'ç¶“æ–‡';

                    if(colNames.includes('book_name')) dbCols.book = 'book_name';
                    else if(colNames.includes('æ›¸å·')) dbCols.book = 'æ›¸å·';
                }
            } catch(e) {}
        }
        
        window.setupSqlite = async function() {
            const searchInput = document.getElementById('inline-search');
            try {
                if (typeof window.initSqlJs === 'undefined') {
                    console.error("SQL.js not loaded");
                    if (searchInput) searchInput.placeholder = "âš ï¸ å…ƒä»¶è¼‰å…¥å¤±æ•—";
                    return;
                }
                
                if (searchInput) searchInput.placeholder = "ğŸ“¥ ä¸‹è¼‰è³‡æ–™åº«...";
                
                SQL = await window.initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
                
                if (REMOTE_DB_URL) {
                    const res = await fetch(REMOTE_DB_URL);
                    if (!res.ok) throw new Error("Network response was not ok");
                    const buffer = await res.arrayBuffer();
                    sqlDb = new SQL.Database(new Uint8Array(buffer));
                    sqlDbLoaded = true;
                    window.detectTableStructure();
                    if (searchInput) {
                        searchInput.disabled = false;
                        searchInput.placeholder = "ğŸ” æœå°‹ (å¦‚: å‰µ 1:1)...";
                    }
                    console.log("Database loaded successfully");
                }
            } catch(e) { 
                console.error("Database load error:", e);
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = "âš ï¸ é›¢ç·šåº«å¤±æ•—ï¼Œä½¿ç”¨API";
                }
            }
        }
        
        // ... (data definitions) ...
        const REMOTE_DB_URL = "https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db";
        let sqlDb = null, sqlDbLoaded = false, SQL = null, els = {};
        let currentMode = 'home';
        let calendarDate = new Date();
        let currentFontSize = 18;
        let currentDailyPlan = []; 

        const mannaVerses = [
            { t: "ã€Œæ•¬ç•è€¶å’Œè¯æ˜¯æ™ºæ…§çš„é–‹ç«¯ã€‚ã€", r: "â€” ç®´è¨€ 9:10" },
            { t: "ã€Œè€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚ã€", r: "â€” è©©ç¯‡ 23:1" },
            { t: "ã€Œæ‡‰ç•¶ä¸€ç„¡æ›æ…®ï¼Œåªè¦å‡¡äº‹è—‰è‘—ç¦±å‘Šã€ç¥ˆæ±‚ï¼Œå’Œæ„Ÿè¬ï¼Œå°‡ä½ å€‘æ‰€è¦çš„å‘Šè¨´ç¥ã€‚ã€", r: "â€” è…“ç«‹æ¯”æ›¸ 4:6" },
            { t: "ã€Œç¥å°±æ˜¯æ„›ï¼›ä½åœ¨æ„›è£¡é¢çš„ï¼Œå°±ä½åœ¨ç¥è£¡é¢ã€‚ã€", r: "â€” ç´„ç¿°ä¸€æ›¸ 4:16" },
            { t: "ã€Œå–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥ï¼›æ†‚å‚·çš„éˆä½¿éª¨æ¯ä¹¾ã€‚ã€", r: "â€” ç®´è¨€ 17:22" },
            { t: "ã€Œæˆ‘é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚ã€", r: "â€” è…“ç«‹æ¯”æ›¸ 4:13" }
        ];

        const bibleBooks = {
            old: [{n:"å‰µä¸–è¨˜",abbr:"å‰µ",c:50},{n:"å‡ºåŸƒåŠè¨˜",abbr:"å‡º",c:40},{n:"åˆ©æœªè¨˜",abbr:"åˆ©",c:27},{n:"æ°‘æ•¸è¨˜",abbr:"æ°‘",c:36},{n:"ç”³å‘½è¨˜",abbr:"ç”³",c:34},{n:"ç´„æ›¸äºè¨˜",abbr:"æ›¸",c:24},{n:"å£«å¸«è¨˜",abbr:"å£«",c:21},{n:"è·¯å¾—è¨˜",abbr:"å¾—",c:4},{n:"æ’’æ¯è€³è¨˜ä¸Š",abbr:"æ’’ä¸Š",c:31},{n:"æ’’æ¯è€³è¨˜ä¸‹",abbr:"æ’’ä¸‹",c:24},{n:"åˆ—ç‹ç´€ä¸Š",abbr:"ç‹ä¸Š",c:22},{n:"åˆ—ç‹ç´€ä¸‹",abbr:"ç‹ä¸‹",c:25},{n:"æ­·ä»£å¿—ä¸Š",abbr:"ä»£ä¸Š",c:29},{n:"æ­·ä»£å¿—ä¸‹",abbr:"ä»£ä¸‹",c:36},{n:"ä»¥æ–¯æ‹‰è¨˜",abbr:"æ‹‰",c:10},{n:"å°¼å¸Œç±³è¨˜",abbr:"å°¼",c:13},{n:"ä»¥æ–¯å¸–è¨˜",abbr:"æ–¯",c:10},{n:"ç´„ä¼¯è¨˜",abbr:"ä¼¯",c:42},{n:"è©©ç¯‡",abbr:"è©©",c:150},{n:"ç®´è¨€",abbr:"ç®´",c:31},{n:"å‚³é“æ›¸",abbr:"å‚³",c:12},{n:"é›…æ­Œ",abbr:"æ­Œ",c:8},{n:"ä»¥è³½äºæ›¸",abbr:"è³½",c:66},{n:"è€¶åˆ©ç±³æ›¸",abbr:"è€¶",c:52},{n:"è€¶åˆ©ç±³å“€æ­Œ",abbr:"å“€",c:5},{n:"ä»¥è¥¿çµæ›¸",abbr:"çµ",c:48},{n:"ä½†ä»¥ç†æ›¸",abbr:"ä½†",c:12},{n:"ä½•è¥¿é˜¿æ›¸",abbr:"ä½•",c:14},{n:"ç´„ç¥æ›¸",abbr:"ç¥",c:3},{n:"é˜¿æ‘©å¸æ›¸",abbr:"æ‘©",c:9},{n:"ä¿„å·´åº•äºæ›¸",abbr:"ä¿„",c:1},{n:"ç´„æ‹¿æ›¸",abbr:"æ‹¿",c:4},{n:"å½Œè¿¦æ›¸",abbr:"å½Œ",c:7},{n:"é‚£é´»æ›¸",abbr:"é´»",c:3},{n:"å“ˆå·´è°·æ›¸",abbr:"å“ˆ",c:3},{n:"è¥¿ç•ªé›…æ›¸",abbr:"ç•ª",c:3},{n:"å“ˆè©²æ›¸",abbr:"è©²",c:2},{n:"æ’’è¿¦åˆ©äºæ›¸",abbr:"äº",c:14},{n:"ç‘ªæ‹‰åŸºæ›¸",abbr:"ç‘ª",c:4}],
            new: [{n:"é¦¬å¤ªç¦éŸ³",abbr:"å¤ª",c:28},{n:"é¦¬å¯ç¦éŸ³",abbr:"å¯",c:16},{n:"è·¯åŠ ç¦éŸ³",abbr:"è·¯",c:24},{n:"ç´„ç¿°ç¦éŸ³",abbr:"ç´„",c:21},{n:"ä½¿å¾’è¡Œå‚³",abbr:"å¾’",c:28},{n:"ç¾…é¦¬æ›¸",abbr:"ç¾…",c:16},{n:"å“¥æ—å¤šå‰æ›¸",abbr:"æ—å‰",c:16},{n:"å“¥æ—å¤šå¾Œæ›¸",abbr:"æ—å¾Œ",c:13},{n:"åŠ æ‹‰å¤ªæ›¸",abbr:"åŠ ",c:6},{n:"ä»¥å¼—æ‰€æ›¸",abbr:"å¼—",c:6},{n:"è…“ç«‹æ¯”æ›¸",abbr:"è…“",c:4},{n:"æ­Œç¾…è¥¿æ›¸",abbr:"è¥¿",c:4},{n:"å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸",abbr:"å¸–å‰",c:5},{n:"å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸",abbr:"å¸–å¾Œ",c:3},{n:"ææ‘©å¤ªå‰æ›¸",abbr:"æå‰",c:6},{n:"ææ‘©å¤ªå¾Œæ›¸",abbr:"æå¾Œ",c:4},{n:"æå¤šæ›¸",abbr:"å¤š",c:3},{n:"è…“åˆ©é–€æ›¸",abbr:"é–€",c:1},{n:"å¸Œä¼¯ä¾†æ›¸",abbr:"ä¾†",c:13},{n:"é›…å„æ›¸",abbr:"é›…",c:5},{n:"å½¼å¾—å‰æ›¸",abbr:"å½¼å‰",c:5},{n:"å½¼å¾—å¾Œæ›¸",abbr:"å½¼å¾Œ",c:3},{n:"ç´„ç¿°ä¸€æ›¸",abbr:"ç´„ä¸€",c:5},{n:"ç´„ç¿°äºŒæ›¸",abbr:"ç´„äºŒ",c:1},{n:"ç´„ç¿°ä¸‰æ›¸",abbr:"ç´„ä¸‰",c:1},{n:"çŒ¶å¤§æ›¸",abbr:"çŒ¶",c:1},{n:"å•Ÿç¤ºéŒ„",abbr:"å•Ÿ",c:22}]
        };

        const psmVerses = [6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,26,17,11,9,14,20,23,19,9,6,7,23,13,11,11,17,12,8,12,11,10,13,20,7,35,36,5,24,20,28,23,10,12,20,72,13,19,16,8,18,12,13,17,7,18,52,17,16,15,5,23,11,13,12,9,9,5,8,28,22,35,45,48,43,13,31,7,10,10,9,8,18,19,2,29,176,7,8,9,4,8,5,6,5,6,8,8,3,18,3,3,21,26,9,8,24,13,10,7,12,15,21,10,20,14,9,6];
        const proVerses = [33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31];

        const planTracks = [
            [{n:"å‰µä¸–è¨˜",abbr:"å‰µ",c:50},{n:"å‡ºåŸƒåŠè¨˜",abbr:"å‡º",c:40},{n:"åˆ©æœªè¨˜",abbr:"åˆ©",c:27},{n:"æ°‘æ•¸è¨˜",abbr:"æ°‘",c:36},{n:"ç”³å‘½è¨˜",abbr:"ç”³",c:34},{n:"ç´„æ›¸äºè¨˜",abbr:"æ›¸",c:24},{n:"å£«å¸«è¨˜",abbr:"å£«",c:21},{n:"è·¯å¾—è¨˜",abbr:"å¾—",c:4},{n:"æ’’æ¯è€³è¨˜ä¸Š",abbr:"æ’’ä¸Š",c:31},{n:"æ’’æ¯è€³è¨˜ä¸‹",abbr:"æ’’ä¸‹",c:24},{n:"åˆ—ç‹ç´€ä¸Š",abbr:"ç‹ä¸Š",c:22},{n:"åˆ—ç‹ç´€ä¸‹",abbr:"ç‹ä¸‹",c:25},{n:"æ­·ä»£å¿—ä¸Š",abbr:"ä»£ä¸Š",c:29},{n:"æ­·ä»£å¿—ä¸‹",abbr:"ä»£ä¸‹",c:36},{n:"ä»¥æ–¯æ‹‰è¨˜",abbr:"æ‹‰",c:10},{n:"å°¼å¸Œç±³è¨˜",abbr:"å°¼",c:13},{n:"ä»¥æ–¯å¸–è¨˜",abbr:"æ–¯",c:10},{n:"ç´„ä¼¯è¨˜",abbr:"ä¼¯",c:42},{n:"å‚³é“æ›¸",abbr:"å‚³",c:12},{n:"é›…æ­Œ",abbr:"æ­Œ",c:8},{n:"ä»¥è³½äºæ›¸",abbr:"è³½",c:66},{n:"è€¶åˆ©ç±³æ›¸",abbr:"è€¶",c:52},{n:"è€¶åˆ©ç±³å“€æ­Œ",abbr:"å“€",c:5},{n:"ä»¥è¥¿çµæ›¸",abbr:"çµ",c:48},{n:"ä½†ä»¥ç†æ›¸",abbr:"ä½†",c:12},{n:"ä½•è¥¿é˜¿æ›¸",abbr:"ä½•",c:14},{n:"ç´„ç¥æ›¸",abbr:"ç¥",c:3},{n:"é˜¿æ‘©å¸æ›¸",abbr:"æ‘©",c:9},{n:"ä¿„å·´åº•äºæ›¸",abbr:"ä¿„",c:1},{n:"ç´„æ‹¿æ›¸",abbr:"æ‹¿",c:4},{n:"å½Œè¿¦æ›¸",abbr:"å½Œ",c:7},{n:"é‚£é´»æ›¸",abbr:"é´»",c:3},{n:"å“ˆå·´è°·æ›¸",abbr:"å“ˆ",c:3},{n:"è¥¿ç•ªé›…æ›¸",abbr:"ç•ª",c:3},{n:"å“ˆè©²æ›¸",abbr:"è©²",c:2},{n:"æ’’è¿¦åˆ©äºæ›¸",abbr:"äº",c:14},{n:"ç‘ªæ‹‰åŸºæ›¸",abbr:"ç‘ª",c:4}],
            [{n:"é¦¬å¤ªç¦éŸ³",abbr:"å¤ª",c:28},{n:"é¦¬å¯ç¦éŸ³",abbr:"å¯",c:16},{n:"è·¯åŠ ç¦éŸ³",abbr:"è·¯",c:24},{n:"ç´„ç¿°ç¦éŸ³",abbr:"ç´„",c:21},{n:"ä½¿å¾’è¡Œå‚³",abbr:"å¾’",c:28},{n:"ç¾…é¦¬æ›¸",abbr:"ç¾…",c:16},{n:"å“¥æ—å¤šå‰æ›¸",abbr:"æ—å‰",c:16},{n:"å“¥æ—å¤šå¾Œæ›¸",abbr:"æ—å¾Œ",c:13},{n:"åŠ æ‹‰å¤ªæ›¸",abbr:"åŠ ",c:6},{n:"ä»¥å¼—æ‰€æ›¸",abbr:"å¼—",c:6},{n:"è…“ç«‹æ¯”æ›¸",abbr:"è…“",c:4},{n:"æ­Œç¾…è¥¿æ›¸",abbr:"è¥¿",c:4},{n:"å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸",abbr:"å¸–å‰",c:5},{n:"å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸",abbr:"å¸–å¾Œ",c:3},{n:"ææ‘©å¤ªå‰æ›¸",abbr:"æå‰",c:6},{n:"ææ‘©å¤ªå¾Œæ›¸",abbr:"æå¾Œ",c:4},{n:"æå¤šæ›¸",abbr:"å¤š",c:3},{n:"è…“åˆ©é–€æ›¸",abbr:"é–€",c:1},{n:"å¸Œä¼¯ä¾†æ›¸",abbr:"ä¾†",c:13},{n:"é›…å„æ›¸",abbr:"é›…",c:5},{n:"å½¼å¾—å‰æ›¸",abbr:"å½¼å‰",c:5},{n:"å½¼å¾—å¾Œæ›¸",abbr:"å½¼å¾Œ",c:3},{n:"ç´„ç¿°ä¸€æ›¸",abbr:"ç´„ä¸€",c:5},{n:"ç´„ç¿°äºŒæ›¸",abbr:"ç´„äºŒ",c:1},{n:"ç´„ç¿°ä¸‰æ›¸",abbr:"ç´„ä¸‰",c:1},{n:"çŒ¶å¤§æ›¸",abbr:"çŒ¶",c:1},{n:"å•Ÿç¤ºéŒ„",abbr:"å•Ÿ",c:22}],
            [{n:"è©©ç¯‡",abbr:"è©©",c:150}],
            [{n:"ç®´è¨€",abbr:"ç®´",c:31}]
        ];

        const bookMap = {};
        [...bibleBooks.old, ...bibleBooks.new].forEach(b => {
            bookMap[b.abbr] = b.n;
            bookMap[b.n] = b.n; 
            bookMap[b.n.replace("æ›¸","")] = b.n;
        });

        // --- Core Functions ---
        window.generateReadingUnits = function(trackData, trackIndex) {
            let units = [];
            if (trackIndex === 2) { 
                const b = trackData[0]; 
                for(let i=1; i<=b.c; i++) {
                    const verses = psmVerses[i-1] || 25;
                    const parts = Math.ceil(verses / 7);
                    const step = Math.ceil(verses / parts);
                    for (let p = 0; p < parts; p++) {
                        const start = p * step + 1;
                        const end = Math.min((p + 1) * step, verses);
                        units.push(`${b.abbr} ${i}:${start}-${end}`);
                    }
                }
                return units;
            }
            if (trackIndex === 3) {
                const b = trackData[0];
                const partsPerChapter = 12; 
                for(let i=1; i<=b.c; i++) {
                    const verses = proVerses[i-1] || 30;
                    const step = Math.max(1, Math.floor(verses / partsPerChapter));
                    let current = 1;
                    while (current <= verses) {
                        let end = current + step - 1;
                        if (end > verses || (verses - end) < 3) end = verses; 
                        units.push(`${b.abbr} ${i}:${current}-${end}`);
                        current = end + 1;
                        if (current > verses) break;
                    }
                }
                return units;
            }
            const totalChapters = trackData.reduce((acc, b) => acc + b.c, 0);
            let partsPerChapter = 1;
            if (totalChapters < 365) partsPerChapter = Math.ceil(365 / totalChapters);
            trackData.forEach(b => {
                for(let i=1; i<=b.c; i++) {
                    if (partsPerChapter > 1) {
                        if (partsPerChapter === 2) {
                            units.push(`${b.abbr} ${i}:1-15`);
                            units.push(`${b.abbr} ${i}:16-end`);
                        } else {
                            units.push(`${b.abbr} ${i}:1-10`);
                            units.push(`${b.abbr} ${i}:11-20`);
                            units.push(`${b.abbr} ${i}:21-end`);
                        }
                    } else {
                        units.push(`${b.abbr} ${i}`);
                    }
                }
            });
            return units;
        }

        window.getDailyPlan = function(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            let dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
            if(dayOfYear < 1) dayOfYear = 1;
            if (dayOfYear > 365) dayOfYear = 365;
            
            const labels = ["èˆŠç´„", "æ–°ç´„", "è©©ç¯‡", "ç®´è¨€"];
            return planTracks.map((track, idx) => {
                const units = window.generateReadingUnits(track, idx);
                const total = units.length;
                const itemsPerDay = total / 365;
                const startIndex = Math.floor((dayOfYear - 1) * itemsPerDay);
                let endIndex = Math.floor(dayOfYear * itemsPerDay);
                if (dayOfYear === 365) endIndex = total; 
                if (endIndex > total) endIndex = total;
                if (startIndex === endIndex && total >= 365) endIndex = startIndex + 1;
                const dailyItems = units.slice(startIndex, endIndex);
                if (!dailyItems || dailyItems.length === 0) return null;
                let ref = dailyItems[0];
                if (dailyItems.length > 1) {
                    const first = dailyItems[0];
                    const last = dailyItems[dailyItems.length - 1];
                    const parse = (s) => {
                        const parts = s.split(' ');
                        const b = parts[0];
                        const nums = parts[1].split(':');
                        return { b, c: nums[0], v: nums[1] || '' };
                    };
                    const f = parse(first);
                    const l = parse(last);
                    if (f.b === l.b) {
                        if (f.c === l.c) {
                            const startV = f.v ? f.v.split('-')[0] : '1';
                            const endV = l.v ? l.v.split('-')[1] : 'end';
                            if (startV === '1' && endV === 'end') ref = `${f.b} ${f.c}`;
                            else ref = `${f.b} ${f.c}:${startV}-${endV}`;
                        } else ref = `${f.b} ${f.c}-${l.c}`;
                    } else ref = `${first} - ${last}`;
                }
                ref = ref.replace(/:(\d+)-end/g, ":$1+"); 
                return { t: labels[idx], r: ref, raw: dailyItems };
            }).filter(i => i);
        }

        window.fetchBibleRef = async function(refInput) {
            if(!refInput) return;
            els.bibleContent.innerHTML = '<div class="h-full flex items-center justify-center py-20"><span class="loader"></span></div>';
            let queries = [];
            if (Array.isArray(refInput)) {
                queries = refInput.map(r => r.replace(/-end/g, "-176")); 
                // Devotion Mode: Keep title hidden as per request
            } else {
                els.readerTitle.innerText = refInput;
                const cleanRef = refInput.replace(/-end/g, "-176");
                if (cleanRef.includes(':') || (cleanRef.includes('-') && !cleanRef.includes(' - '))) {
                     if(cleanRef.includes('-') && !cleanRef.includes(':')) {
                         const parts = cleanRef.split(/[- ]+/);
                         if(parts.length >= 2) {
                             const book = parts[0];
                             const start = parseInt(parts[1]);
                             const end = parseInt(parts[parts.length-1]);
                             for(let i=start; i<=end; i++) queries.push(`${book} ${i}`);
                         } else queries.push(cleanRef);
                     } else queries.push(cleanRef);
                } else queries.push(cleanRef.split('-')[0].trim()); 
            }

            let allHtml = "";
            for(let q of queries) {
                const match = q.match(/^([\u4e00-\u9fa5]+|[a-zA-Z]+)\s*(\d+)(?::(\d+)(?:-(\d+))?)?$/);
                let fetched = false;
                if (sqlDbLoaded && sqlDb && match) {
                    const bookAbbr = match[1];
                    const chapter = parseInt(match[2]);
                    const startVerse = match[3] ? parseInt(match[3]) : null;
                    const endVerse = match[4] ? parseInt(match[4]) : (startVerse || null);
                    const fullBookName = bookMap[bookAbbr] || bookAbbr;
                    try {
                        let query = `SELECT * FROM ${dbTable} WHERE ${dbCols.book} = ? AND ${dbCols.chapter} = ?`;
                        let params = [fullBookName, chapter];
                        if (startVerse !== null) {
                            if (endVerse !== null) {
                                query += ` AND ${dbCols.verse} >= ? AND ${dbCols.verse} <= ?`;
                                params.push(startVerse, endVerse);
                            } else {
                                query += ` AND ${dbCols.verse} = ?`;
                                params.push(startVerse);
                            }
                        }
                        const res = sqlDb.exec(query, params);
                        if (res && res.length > 0) {
                            const list = res[0].values.map(row => {
                                const colNames = res[0].columns;
                                const r = {};
                                colNames.forEach((c, i) => r[c] = row[i]);
                                return { ref: `${r[dbCols.chapter]}:${r[dbCols.verse]}`, text: r[dbCols.text] };
                            });
                            // Modified here: use toggleVerseSelection instead of addToNote
                            allHtml += list.map(v => `
                                <div class="verse-item mb-2 p-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-all border-l-4 border-transparent" onclick="window.toggleVerseSelection(this)" data-ref="${v.ref}" data-text="${v.text.replace(/"/g, '&quot;')}">
                                    <span class="text-xs font-bold text-[#A68C76] align-top mr-1 select-none">${v.ref}</span>
                                    <span class="text-[#5E5A54]">${v.text}</span>
                                </div>
                            `).join('');
                            fetched = true;
                        }
                    } catch(e) { console.error("SQL Error", e); }
                }
                if (!fetched) {
                    try {
                        const apiRef = q.replace(/\s/g, '');
                        const res = await fetch(`https://bolls.life/search/CUV/?search=${encodeURIComponent(apiRef)}`);
                        const data = await res.json();
                        if(data.length > 0) {
                            allHtml += data.map(v => `
                                <div class="verse-item mb-2 p-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-all border-l-4 border-transparent" onclick="window.toggleVerseSelection(this)" data-ref="${v.chapter}:${v.verse}" data-text="${v.text.replace(/"/g, '&quot;')}">
                                    <span class="text-xs font-bold text-[#A68C76] align-top mr-1 select-none">${v.chapter}:${v.verse}</span>
                                    <span class="text-[#5E5A54]">${v.text}</span>
                                </div>
                            `).join('');
                        }
                    } catch(e) { console.error("API Error", e); }
                }
            }
            if(allHtml) {
                els.bibleContent.innerHTML = allHtml;
                els.bibleContent.scrollTop = 0;
            } else els.bibleContent.innerHTML = '<p class="p-8 text-center text-gray-400 font-serif">å¦‚éœ€ç²¾ç¢ºç¯€æ•¸æŸ¥è©¢ï¼Œè«‹å…ˆç¢ºèªè³‡æ–™åº«å·²æ­£ç¢ºè¼‰å…¥ã€‚</p>';
        }

        window.handleDateChange = function(dKey) {
            const parts = dKey.split('-');
            calendarDate = new Date(parts[0], parts[1]-1, parts[2]);
            if(els.datePicker) els.datePicker.value = dKey;
            if(els.homeDatePicker) els.homeDatePicker.value = dKey;
            const randomVerse = mannaVerses[Math.abs(dKey.split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % mannaVerses.length];
            if(document.getElementById('manna-text')) {
                document.getElementById('manna-text').innerText = randomVerse.t;
                document.getElementById('manna-ref').innerText = randomVerse.r;
            }
            
            const fields = [
                'note-rhema', 'note-reflection', 'note-prayer-devotion', 
                'note-topic', 'note-content', 'note-tracking', 
                'note-thanks', 'note-grace', 'note-diary', 'note-mood',
                'note-mood-event', 'note-mood-tag', 'note-mood-lie', 'note-mood-god-view', 'note-mood-my-view', 'note-mood-prayer'
            ];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = localStorage.getItem(`${dKey}-${id}`) || "";
            });

            window.renderCalendar();
            window.calculateStreak();
            if(currentMode === 'devotion') window.updateDevotionUI();
        }

        window.updateDevotionUI = function() {
            const plan = window.getDailyPlan(calendarDate);
            const container = document.getElementById('devotion-tabs');
            window.currentDailyPlan = plan; 
            container.innerHTML = plan.map((item, idx) => `
                <div class="devotion-track-card ${idx===0?'active':''}" onclick="window.loadTrack(${idx}, this)">
                    <span class="track-tag">${item.t}</span>
                    <span class="track-ref">${item.r}</span>
                </div>
            `).join('');
            if(plan.length > 0) window.loadTrack(0);
        }
        
        window.loadTrack = function(idx, btnEl) {
            if(btnEl) window.highlightTrack(btnEl);
            else {
                const btns = document.querySelectorAll('.devotion-track-card');
                if(btns[idx]) window.highlightTrack(btns[idx]);
            }
            const planItem = window.currentDailyPlan[idx];
            if(planItem && planItem.raw) window.fetchBibleRef(planItem.raw); 
        }

        window.highlightTrack = function(el) {
            document.querySelectorAll('.devotion-track-card').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        window.toggleVerseSelection = function(el) {
             el.classList.toggle('selected');
             window.updateCopyButton();
        }

        window.updateCopyButton = function() {
             const selectedCount = document.querySelectorAll('.verse-item.selected').length;
             const btn = document.getElementById('btn-copy-verses');
             if(btn) {
                 const originalHtml = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`;
                 btn.innerHTML = selectedCount > 0 ? `ğŸ“‹ è¤‡è£½ (${selectedCount})` : originalHtml;
                 btn.classList.toggle('bg-[#A68C76]', selectedCount > 0);
                 btn.classList.toggle('text-white', selectedCount > 0);
             }
        }

        window.copySelectedVerses = function() {
             const selected = document.querySelectorAll('.verse-item.selected');
             if (selected.length === 0) return;
             
             let textToCopy = "";
             selected.forEach(el => {
                 const ref = el.getAttribute('data-ref');
                 const text = el.getAttribute('data-text');
                 textToCopy += `${ref} ${text}\n`;
             });
             
             const ta = document.createElement('textarea');
             ta.value = textToCopy;
             document.body.appendChild(ta);
             ta.select();
             document.execCommand('copy');
             document.body.removeChild(ta);
             
             const btn = document.getElementById('btn-copy-verses');
             btn.innerHTML = "âœ… å·²è¤‡è£½";
             setTimeout(() => {
                 selected.forEach(el => el.classList.remove('selected'));
                 window.updateCopyButton();
                 btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>`;
             }, 1000);
        }

        window.switchMode = function(m) {
            currentMode = m;
            els.viewHome.classList.toggle('hidden', m !== 'home');
            els.viewWorkspace.classList.toggle('hidden', m === 'home');
            els.mainHeader.classList.toggle('hidden', m === 'home');
            
            let title = m.toUpperCase();
            if (m === 'journal-prayer') title = 'è·Ÿç¥èŠèŠ';
            else if (m === 'journal-gratitude') title = 'æ„Ÿæ©æ—¥è¨˜';
            else if (m === 'journal-mood') title = 'å…§å¿ƒæˆ²æ™‚é–“';
            els.headerTitle.innerText = title;
            
            if(m !== 'home') {
                const isDevotion = m === 'devotion';
                document.getElementById('devotion-tabs').classList.toggle('hidden', !isDevotion);
                
                // --- æ¨™é¡Œåˆ—èˆ‡æœå°‹æ¡†é‚è¼¯ ---
                const readerHeader = document.getElementById('reader-header');
                const titleWrapper = document.getElementById('reader-title-wrapper');
                const searchContainer = document.getElementById('reader-search-container');
                
                // é‡ç½®æ‰€æœ‰é è¨­é¡¯ç¤º
                readerHeader.classList.remove('hidden');
                titleWrapper.classList.remove('hidden', 'invisible');
                searchContainer.classList.remove('hidden', 'invisible');

                // é‡å°ã€Œæ¯æ—¥éˆä¿® (Devotion)ã€æ¨¡å¼çš„ç‰¹æ®Šè™•ç†ï¼š
                if (m === 'devotion') {
                    // 1. éš±è—æ¨™é¡Œæ–‡å­— (å› ç‚ºå·²ç¶“æœ‰é€²åº¦å¡ç‰‡äº†)
                    titleWrapper.classList.add('invisible'); 
                    // 2. éš±è—æœå°‹æ¡†ï¼Œä½†ä¿ç•™å¤–å±¤å®¹å™¨ä»¥ä¾¿é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
                    //    æ³¨æ„ï¼šè¤‡è£½æŒ‰éˆ•åœ¨ searchContainer å¤–é¢ï¼Œæ‰€ä»¥éš±è— searchContainer ä¸æœƒå½±éŸ¿è¤‡è£½æŒ‰éˆ•
                    searchContainer.classList.add('hidden');
                }
                
                // Hide all journal fields first
                ['journal-devotion-fields', 'journal-prayer-fields', 'journal-gratitude-fields', 'journal-mood-fields']
                    .forEach(id => document.getElementById(id).classList.add('hidden'));
                
                // Show specific fields
                if (m === 'devotion') document.getElementById('journal-devotion-fields').classList.remove('hidden');
                else if (m === 'journal-prayer') document.getElementById('journal-prayer-fields').classList.remove('hidden');
                else if (m === 'journal-gratitude') document.getElementById('journal-gratitude-fields').classList.remove('hidden');
                else if (m === 'journal-mood') document.getElementById('journal-mood-fields').classList.remove('hidden');
                
                // Tab Text
                let tabText = 'éˆä¿®ç­†è¨˜';
                let tabIcon = 'âœğŸ»';
                if (m === 'journal-prayer') { tabText = 'è·Ÿç¥èŠèŠ'; tabIcon = 'ğŸ’¬'; }
                else if (m === 'journal-gratitude') { tabText = 'æ„Ÿæ©æ—¥è¨˜'; tabIcon = 'ğŸ’–'; }
                else if (m === 'journal-mood') { tabText = 'å…§å¿ƒæˆ²'; tabIcon = 'ğŸ­'; }
                
                document.getElementById('tab-journal-text').innerText = tabText;
                document.getElementById('tab-journal-icon').innerText = tabIcon;

                // Layout
                const readerSec = document.getElementById('section-reader');
                const journalSec = document.getElementById('section-journal');
                const tabs = document.getElementById('workspace-tabs');
                const switchBtn = document.getElementById('btn-switch-chapter');

                readerSec.classList.remove('hidden', 'lg:hidden'); 
                readerSec.classList.add('flex', 'lg:flex', 'lg:col-span-5');
                journalSec.classList.remove('hidden', 'lg:hidden', 'lg:col-span-8', 'lg:col-start-3');
                journalSec.classList.add('flex', 'lg:flex', 'lg:col-span-4');
                tabs.classList.remove('hidden'); 
                switchBtn.classList.add('hidden'); 

                const isPureJournalMode = (m === 'journal-gratitude' || m === 'journal-prayer' || m === 'journal-mood');

                if (isPureJournalMode) {
                    readerSec.classList.remove('flex', 'lg:flex');
                    readerSec.classList.add('hidden'); 
                    journalSec.classList.remove('lg:col-span-4');
                    journalSec.classList.add('lg:col-span-8', 'lg:col-start-3');
                    tabs.classList.add('hidden');
                    window.switchWorkspaceTab('journal');
                } else if (m === 'bible') {
                    // è–ç¶“æ¨¡å¼ (ç´”é–±è®€)
                    journalSec.classList.remove('flex', 'lg:flex');
                    journalSec.classList.add('hidden'); 
                    
                    readerSec.classList.remove('lg:col-span-5');
                    readerSec.classList.add('lg:col-span-8', 'lg:col-start-3');
                    tabs.classList.add('hidden'); // éš±è—åˆ†é 
                    switchBtn.classList.remove('hidden'); // é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ•
                    // æ¨™é¡Œèˆ‡æœå°‹éƒ½è¦ä¿ç•™
                    window.switchWorkspaceTab('reader');
                    window.renderBibleBooks('old');
                    els.readerTitle.innerText = "è«‹é¸æ“‡æ›¸å·";
                    els.bibleContent.innerHTML = '<div class="h-full flex items-center justify-center text-gray-300 italic font-serif">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é¸æ“‡ç¶“æ–‡...</div>';
                    document.getElementById('tab-reader-text').innerText = "é–±è®€ç¶“æ–‡";
                    // éš±è—ç« ç¯€/æ›¸å·è¦–åœ–ï¼Œé‡ç½®ç‚ºé¡¯ç¤ºæ›¸å·åˆ—è¡¨
                    document.getElementById('view-bible-chapters').classList.add('hidden');
                    document.getElementById('bible-content').classList.add('hidden');
                    document.getElementById('view-bible-books').classList.remove('hidden');
                    document.getElementById('view-bible-books').classList.add('flex');
                } else if (m === 'devotion') {
                    if(window.innerWidth < 1024) window.switchWorkspaceTab('reader');
                    document.getElementById('tab-reader-text').innerText = "è®€ç¶“é€²åº¦";
                    window.updateDevotionUI();
                    // Devotion æ¨¡å¼ä¸‹éš±è— Bible å°ˆç”¨è¦–åœ–
                    document.getElementById('view-bible-books').classList.add('hidden');
                    document.getElementById('view-bible-chapters').classList.add('hidden');
                    document.getElementById('bible-content').classList.remove('hidden');
                }
                
                if (m === 'bible') {
                    document.getElementById('tab-reader-text').innerText = "é–±è®€ç¶“æ–‡";
                }
            }
        }
        
        window.switchWorkspaceTab = function(tab) {
            const readerBtn = document.getElementById('tab-reader');
            const journalBtn = document.getElementById('tab-journal');
            const readerSec = document.getElementById('section-reader');
            const journalSec = document.getElementById('section-journal');
            
            if (tab === 'reader') {
                readerBtn.classList.add('active');
                journalBtn.classList.remove('active');
            } else {
                journalBtn.classList.add('active');
                readerBtn.classList.remove('active');
            }

            const isDesktop = window.innerWidth >= 1024;
            const isSplitView = currentMode === 'devotion';

            if (isDesktop && isSplitView) {
                readerSec.style.opacity = '1';
                readerSec.style.pointerEvents = 'auto';
                readerSec.style.zIndex = 'auto';
                journalSec.style.opacity = '1';
                journalSec.style.pointerEvents = 'auto';
                journalSec.style.zIndex = 'auto';
                return; 
            }

            if (tab === 'reader') {
                readerSec.style.opacity = '1';
                readerSec.style.pointerEvents = 'auto';
                readerSec.style.zIndex = '10';
                journalSec.style.opacity = '0';
                journalSec.style.pointerEvents = 'none';
                journalSec.style.zIndex = '0';
            } else {
                readerSec.style.opacity = '0';
                readerSec.style.pointerEvents = 'none';
                readerSec.style.zIndex = '0';
                journalSec.style.opacity = '1';
                journalSec.style.pointerEvents = 'auto';
                journalSec.style.zIndex = '10';
            }
        }
        
        window.toggleBibleSidebar = function() {
            const sidebar = document.getElementById('bible-sidebar-overlay');
            sidebar.classList.toggle('hidden');
        }

        window.renderBibleBooks = function(t) {
            // é¡¯ç¤ºæ›¸å·åˆ—è¡¨ï¼Œéš±è—å…¶ä»–
            document.getElementById('bible-content').classList.add('hidden');
            document.getElementById('view-bible-chapters').classList.add('hidden');
            document.getElementById('view-bible-books').classList.remove('hidden');
            document.getElementById('view-bible-books').classList.add('flex');
            
            document.getElementById('bible-book-list').innerHTML = bibleBooks[t].map(b => `<button class="text-left px-3 py-2 rounded-lg hover:bg-[#F2EBE5] text-sm border border-gray-100" onclick='window.showChapters(${JSON.stringify(b)})'>${b.n}</button>`).join('');
            
            document.getElementById('btn-old').className = t==='old'?"flex-1 py-2 text-xs font-bold rounded-lg bg-[#A68C76] text-white":"flex-1 py-2 text-xs font-bold rounded-lg bg-white border text-[#A68C76]";
            document.getElementById('btn-new').className = t==='new'?"flex-1 py-2 text-xs font-bold rounded-lg bg-[#A68C76] text-white":"flex-1 py-2 text-xs font-bold rounded-lg bg-white border text-[#A68C76]";
        }

        window.showChapters = function(b) {
            // é¡¯ç¤ºç« ç¯€åˆ—è¡¨
            document.getElementById('view-bible-books').classList.add('hidden');
            document.getElementById('view-bible-books').classList.remove('flex');
            document.getElementById('bible-content').classList.add('hidden');
            document.getElementById('view-bible-chapters').classList.remove('hidden');
            document.getElementById('view-bible-chapters').classList.add('flex');
            
            document.getElementById('sidebar-chapter-title').innerText = b.n;
            document.getElementById('sidebar-chapter-grid').innerHTML = Array.from({length:b.c}, (_,i)=> `<button class="aspect-square border rounded-lg hover:bg-[#A68C76] hover:text-white transition-colors flex items-center justify-center font-mono" onclick="window.fetchBibleRef('${b.abbr}${i+1}'); window.showBibleContent()">${i+1}</button>`).join('');
        }

        window.showBibleContent = function() {
            // é¡¯ç¤ºç¶“æ–‡å…§å®¹
            document.getElementById('view-bible-books').classList.add('hidden');
            document.getElementById('view-bible-chapters').classList.add('hidden');
            document.getElementById('view-bible-chapters').classList.remove('flex');
            document.getElementById('bible-content').classList.remove('hidden');
        }

        window.goBackToBooks = function() { 
            // è¿”å›æ›¸å·åˆ—è¡¨
            window.renderBibleBooks('old');
        }
        
        window.backToBooks = window.goBackToBooks; // Alias for compatibility

        window.renderCalendar = function() {
            const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
            els.calendarMonthLabel.innerText = `${y}å¹´ ${m+1}æœˆ`;
            els.calendarGrid.innerHTML = "";
            const start = new Date(y, m, 1).getDay();
            for(let i=0; i<start; i++) els.calendarGrid.appendChild(document.createElement('div'));
            for(let i=1; i<=new Date(y,m+1,0).getDate(); i++) {
                const div = document.createElement('div'); div.className = "calendar-day"; div.innerText = i;
                const key = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                let hasEntry = false;
                const checkFields = ['note-rhema','note-content','note-thanks','note-mood-event'];
                for (let f of checkFields) {
                     if(localStorage.getItem(`${key}-${f}`)) { hasEntry = true; break; }
                }
                if(hasEntry) div.classList.add('has-entry');
                if(key === els.datePicker.value) div.classList.add('selected-day');
                const isToday = key === new Date().toISOString().split('T')[0];
                if(isToday) div.classList.add('today');
                div.onclick = () => window.handleDateChange(key); 
                els.calendarGrid.appendChild(div);
            }
        }

        window.calculateStreak = function() {
            let s = 0, d = new Date();
            while(true) {
                const key = d.toISOString().split('T')[0];
                let hasEntry = false;
                const checkFields = ['note-rhema','note-content','note-thanks','note-mood-event'];
                for (let f of checkFields) {
                     if(localStorage.getItem(`${key}-${f}`)) { hasEntry = true; break; }
                }
                if(hasEntry) { s++; d.setDate(d.getDate()-1); } 
                else { break; }
            }
            els.streakCount.innerText = s; 
            els.streakBadge.style.display = s>0?"flex":"none";
        }

        window.selectMood = function(el, emoji) {
            document.getElementById('note-mood').value = emoji;
            localStorage.setItem(`${els.datePicker.value}-note-mood`, emoji);
            document.querySelectorAll('.mood-sticker').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
        }

        window.performSearch = function() {
            const kw = els.inlineSearch.value;
            if(kw) {
                window.fetchBibleRef(kw);
                window.showBibleContent();
            }
        }

        window.openExportModal = function() { document.getElementById('export-modal').classList.remove('hidden'); }
        window.closeExportModal = function() { document.getElementById('export-modal').classList.add('hidden'); }
        
        window.goHome = function() { window.switchMode('home'); }
        
        window.changeCalendarMonth = function(dir) { calendarDate.setMonth(calendarDate.getMonth() + dir); window.renderCalendar(); }
        
        window.backupData = function() {
            const data = {};
            for(let i=0; i<localStorage.length; i++){
                const k = localStorage.key(i);
                if(k.match(/^\d{4}-\d{2}-\d{2}/)) data[k] = localStorage.getItem(k);
            }
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `manna-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        window.restoreData = function(input) {
            const reader = new FileReader();
            reader.onload = e => {
                const data = JSON.parse(e.target.result);
                Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                alert("é‚„åŸæˆåŠŸï¼");
                location.reload();
            };
            reader.readAsText(input.files[0]);
        }
        
        window.handleManualSqliteUpload = function(input) {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    sqlDb = new SQL.Database(new Uint8Array(reader.result));
                    sqlDbLoaded = true;
                    window.detectTableStructure();
                    alert("è¼‰å…¥æˆåŠŸï¼");
                    els.inlineSearch.placeholder = "ğŸ” æœå°‹ (å¦‚: å‰µ 1:1)...";
                    window.closeExportModal();
                } catch(e) { alert("æª”æ¡ˆè®€å–å¤±æ•—"); }
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function initApp() {
            els = {
                viewHome: document.getElementById('view-home'), viewWorkspace: document.getElementById('view-workspace'), mainHeader: document.getElementById('main-header'),
                bibleContent: document.getElementById('bible-content'), readerTitle: document.getElementById('reader-title'), headerTitle: document.getElementById('header-title'),
                datePicker: document.getElementById('date-picker'), homeDatePicker: document.getElementById('home-date-picker'),
                inlineSearch: document.getElementById('inline-search'), calendarGrid: document.getElementById('calendar-grid'),
                calendarMonthLabel: document.getElementById('calendar-month-label'), streakCount: document.getElementById('streak-count'), streakBadge: document.getElementById('streak-badge')
            };
            // ä¿®æ­£ï¼šä½¿ç”¨æœ¬åœ°æ™‚é–“åˆå§‹åŒ–
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            window.handleDateChange(today);
            window.setupSqlite();
        }
        
        // Explicitly bind setupSqlite to window for safety
        window.setupSqlite = setupSqlite;

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
